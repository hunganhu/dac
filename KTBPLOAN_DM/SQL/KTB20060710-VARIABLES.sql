DROP TABLE KTB_BASE_20060710 
GO

CREATE TABLE KTB_BASE_20060710 
(	MSN				CHAR(20),
	INQUIRY_DATE		CHAR(8),
	INPUT_TIME		CHAR(12),
	REQUEST_AMT		INT,
	APR				DECIMAL(6,5),
	TOTAL_TERM		INT,
	APPROVED_AMT	INT,
	KRM001_HIT		INT,
	KRM023_HIT		INT,
	BAM086_HIT		INT,
	IND001			INT,
	JAS002_DEFECT	INT,	/* JAS002 Related */
	FS031			INT,	/* STM001 Related */
	FS031_1M		INT,
	RS017			INT,	/* KRM021 Related */
	STOP_CODE_FLAG	INT,
	FS036			INT,	/* BAM086 Related */
	FS040			INT,
	FS044			INT,
	MS063			FLOAT,
	MS074			FLOAT,
	MS093			FLOAT,
	MS105			FLOAT,
	FS302			INT,
	FS309			INT,
	FS334			INT,
	FS334B_1M		INT,
	FS546_9M		INT,
	FS314B			INT)
GO

INSERT INTO KTB_BASE_20060710 (MSN, INPUT_TIME)
SELECT	MSN,
		MAX(INPUT_TIME)
FROM	RESULT
GROUP BY MSN
GO

UPDATE	KTB_BASE_20060710
SET	INQUIRY_DATE = (
	SELECT	MAX(INQUIRY_DATE)
	FROM	dbo.JAS002
	WHERE	MSN = KTB_BASE_20060710.MSN
	AND		INPUT_TIME = KTB_BASE_20060710.INPUT_TIME
	GROUP BY MSN),
	REQUEST_AMT = (
	SELECT	MAX(APPLICATION_AMOUNT)
	FROM	dbo.APPLICANT
	WHERE	MSN = KTB_BASE_20060710.MSN
	AND		INPUT_TIME = KTB_BASE_20060710.INPUT_TIME
	GROUP BY MSN),
	APR = (
	SELECT	MAX(APPLICATION_RATE)
	FROM	dbo.APPLICANT
	WHERE	MSN = KTB_BASE_20060710.MSN
	AND		INPUT_TIME = KTB_BASE_20060710.INPUT_TIME
	GROUP BY MSN),
	TOTAL_TERM = (
	SELECT	MAX(APPLICATION_TERMS)
	FROM	dbo.APPLICANT
	WHERE	MSN = KTB_BASE_20060710.MSN
	AND		INPUT_TIME = KTB_BASE_20060710.INPUT_TIME
	GROUP BY MSN),
	APPROVED_AMT = (
	SELECT	APPROVED_AMOUNT
	FROM	dbo.RESULT_20060703
	WHERE	MSN = KTB_BASE_20060710.MSN)
GO

UPDATE KTB_BASE_20060710
SET	KRM001_HIT = 0,
	KRM023_HIT = 0,
	BAM086_HIT = 0,
	IND001	= 0
GO
/**KRM001_HIT********************************************************/
UPDATE KTB_BASE_20060710
SET KRM001_HIT = 1
WHERE MSN IN (
		SELECT MSN
		FROM	KRM021_DEDUP)
GO

/**KRM023_HIT********************************************************/
UPDATE KTB_BASE_20060710
SET KRM023_HIT = 1
WHERE MSN IN (
		SELECT MSN
		FROM	COMBINED_KRM023_DEDUP)
GO


/**KRM086_HIT********************************************************/
UPDATE KTB_BASE_20060710
SET BAM086_HIT = 1
WHERE MSN IN (
		SELECT MSN
		FROM	BAM086_DEDUP)
GO


/**IND001************************************************************/
/* IND001:
	KRM021 OLDEST CARD IS <= 6 MONTHS
OR	KRM023 LEAST RECENT STATEMENT WITHIN 6 MONTHS FROM INQUIRY DATE
OR	KRM023 MOST RECENT STATEMENT IS WITHIN 3 MONTHS FROM INQUIRY DATE
*/

CREATE VIEW TMP_KRM021_OLDEST_CARD AS
SELECT	MSN,
		INQUIRY_MON,
		MIN(START_MON_SINCE) AS FIRST_CARD
FROM	KRM021_DEDUP
GROUP BY MSN,INQUIRY_MON
GO


CREATE VIEW TMP_KRM023_STATEMENT_RANGE AS
SELECT	MSN,
		INQUIRY_MON,
		MIN(MON_SINCE)	AS FIRST_STATEMENT,
		MAX(MON_SINCE)	AS LAST_STATEMENT
FROM	COMBINED_KRM023_DEDUP
GROUP BY MSN, INQUIRY_MON
GO

UPDATE KTB_BASE_20060710
SET	IND001 = 1
WHERE	MSN IN (
		SELECT	MSN
		FROM	TMP_KRM021_OLDEST_CARD
		WHERE	INQUIRY_MON-1 - FIRST_CARD <= 6)
GO
UPDATE KTB_BASE_20060710
SET	IND001 = 1
WHERE	MSN IN (
		SELECT	MSN
		FROM	TMP_KRM023_STATEMENT_RANGE
		WHERE	(INQUIRY_MON-1 - FIRST_STATEMENT < 6   /* WITH 30-DAY RULE */
		OR		 INQUIRY_MON   - LAST_STATEMENT >= 3)  /* NO 30-DAY RULE */
		)
GO

DROP VIEW TMP_KRM021_OLDEST_CARD
GO
DROP VIEW TMP_KRM023_STATEMENT_RANGE
GO

/********************************************************************/

SELECT	CASE WHEN APPROVED_AMT > 0 THEN 1
			WHEN APPROVED_AMT = 0 THEN 0
			WHEN APPROVED_AMT IS NULL THEN NULL
		END,
		KRM001_HIT,KRM023_HIT,IND001, count(*)
FROM	dbo.KTB_BASE_20060710
GROUP BY CASE WHEN APPROVED_AMT > 0 THEN 1
			WHEN APPROVED_AMT = 0 THEN 0
			WHEN APPROVED_AMT IS NULL THEN NULL
		END,
		KRM001_HIT,KRM023_HIT,IND001
ORDER BY CASE WHEN APPROVED_AMT > 0 THEN 1
			WHEN APPROVED_AMT = 0 THEN 0
			WHEN APPROVED_AMT IS NULL THEN NULL
		END,
		KRM001_HIT,KRM023_HIT,IND001
GO

/**JAS002_DEFECT*****************************************************/
CREATE VIEW MAJOR_DEFECT AS
SELECT MSN, COUNT(*) AS CNT
FROM JAS002_T_DEDUP
WHERE INQUIRY_MON - MON_SINCE  <= 36
GROUP BY MSN
GO
UPDATE KTB_BASE_20060710
SET JAS002_DEFECT = 0
WHERE	MSN IN (
		SELECT MSN
		FROM	JAS002)
GO
UPDATE KTB_BASE_20060710
SET JAS002_DEFECT = 1
WHERE	MSN IN (
		SELECT	MSN
		FROM	MAJOR_DEFECT
		WHERE	CNT > 0)
GO
DROP VIEW MAJOR_DEFECT
GO


/*BEGINNING STM-RELATED ********************************************/

CREATE VIEW TMP AS
SELECT	MSN,
		COUNT(*) AS FS031,
		SUM(CASE WHEN DATEDIFF(DAY,
				CAST(RTRIM(CAST(CAST(LEFT(QUERY_DATE,3) AS INT)+1911 AS CHAR))+
				SUBSTRING(QUERY_DATE,4,4) AS DATETIME),	CAST(INQUIRY_DATE AS DATETIME)) < = 31
					THEN 1
				 ELSE 0
			END) AS FS031_1M
FROM	STM001_DEDUP
WHERE	ITEM_LIST IS NOT NULL
AND		ITEM_LIST <> ''
GROUP BY MSN
GO
UPDATE KTB_BASE_20060710
SET FS031 = 0,
	FS031_1M = 0
GO
UPDATE KTB_BASE_20060710
SET FS031 = (
	SELECT	FS031
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN),
    FS031_1M = (
	SELECT	FS031_1M
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN)
WHERE	MSN IN (
		SELECT	MSN
		FROM	TMP)		
GO



/*BEGINNING KRM021-RELATED *****************************************/
/* RS017 */
DROP VIEW TMP
GO
CREATE VIEW TMP AS
SELECT	MSN, 
		MAX(INQUIRY_MON - START_MON_SINCE) AS RS017
FROM	KRM021_DEDUP
WHERE	((CAST(LEFT(INQUIRY_DATE,4) AS INT)-1911)*12
	         +CAST(SUBSTRING(INQUIRY_DATE,5,2) AS INT) - START_MON_SINCE) > 0
GROUP BY MSN
GO

UPDATE KTB_BASE_20060710
SET RS017 = 0,
	STOP_CODE_FLAG = 0
WHERE	MSN IN (
		SELECT	MSN
		FROM	KRM021_DEDUP)
GO

UPDATE KTB_BASE_20060710
SET RS017 = (
	SELECT RS017
	FROM TMP
	WHERE	MSN = KTB_BASE_20060710.MSN)
WHERE	MSN IN (
		SELECT	MSN
		FROM	TMP)
GO

DROP VIEW TMP
GO

/* STOP_CODE_FLAG */

CREATE VIEW TMP AS
SELECT MSN, COUNT(*) AS CNT
FROM	KRM021_DEDUP
WHERE	STOP_CODE = '3'
GROUP BY MSN
GO

UPDATE KTB_BASE_20060710
SET	STOP_CODE_FLAG = 1
WHERE	MSN IN (
		SELECT	MSN
		FROM	TMP)
GO



/*BEGINNING BAM086-RELATED *****************************************/
UPDATE KTB_BASE_20060710
SET FS036 = 0,
	FS040 = 0,
	FS044 = 0,
	MS063 = 0,
	MS074 = 0,
	MS093 = 0,
	MS105 = 0,
	FS302 = 0,
	FS309 = 0,
	FS334 = 0,
	FS334B_1M = 0,
	FS546_9M = 0,
	FS314B = 0
WHERE	MSN IN (
		SELECT	MSN
		FROM	BAM086_DEDUP)
GO

DROP VIEW TMP
GO
CREATE VIEW TMP AS
SELECT	MSN, 
		SUM(CASE WHEN ((ACCOUNT_CODE2 IN ('S', 'W', 'M')) OR 
				       (ACCOUNT_CODE = 'K'))
			 THEN 1
			 ELSE 0 END) AS FS036,
		SUM(CASE WHEN (((ACCOUNT_CODE2 IS NULL) OR 
					    (ACCOUNT_CODE2 = '') OR 
					    (ACCOUNT_CODE2 = 'N')) AND 
					     ACCOUNT_CODE != 'K') 
			 THEN 1
			 ELSE 0 END) AS FS040,
		SUM(CASE WHEN PASS_DUE_AMT > 0 
			 THEN 1
			 ELSE 0 END) AS FS044,
		SUM(CASE WHEN ((ACCOUNT_CODE2 = '') OR
					   (ACCOUNT_CODE2 IS NULL) OR 
					   (ACCOUNT_CODE = 'N'))
			 THEN LOAN_AMT + PASS_DUE_AMT
			 ELSE 0 END) AS MS063,
		SUM(CASE WHEN PURPOSE_CODE = '4'
			 THEN LOAN_AMT + PASS_DUE_AMT
			 ELSE 0 END) AS MS074,
       SUM(CASE   /* MONTHLY PAYMENT IN K PER 10K LOAN  */
			 WHEN ACCOUNT_CODE = 'C' AND ((ACCOUNT_CODE2 IS NULL) OR (ACCOUNT_CODE2 = '') OR (ACCOUNT_CODE2 = 'N')) THEN (CONTRACT_AMT) / 10* 150 / 1000
			 WHEN ACCOUNT_CODE = 'C' AND ACCOUNT_CODE2 IN ('S', 'W', 'M') THEN (CONTRACT_AMT) / 10 * 100 / 1000
			 WHEN ACCOUNT_CODE = 'E' AND ((ACCOUNT_CODE2 IS NULL) OR (ACCOUNT_CODE2 = '') OR (ACCOUNT_CODE2 = 'N')) THEN (CONTRACT_AMT) / 10 * 150 / 1000
			 WHEN ACCOUNT_CODE = 'E' AND ACCOUNT_CODE2 IN ('S', 'W', 'M') THEN (CONTRACT_AMT) / 10 * 100 / 1000          
			 WHEN ACCOUNT_CODE = 'H' AND ((ACCOUNT_CODE2 IS NULL) OR (ACCOUNT_CODE2 = '') OR (ACCOUNT_CODE2 = 'N')) THEN (CONTRACT_AMT) / 10 * 238 / 1000
			 WHEN ACCOUNT_CODE = 'H' AND ACCOUNT_CODE2 IN ('S', 'W', 'M') THEN (CONTRACT_AMT) / 10 * 177 / 1000
			 WHEN ACCOUNT_CODE = 'I' AND ((ACCOUNT_CODE2 IS NULL) OR (ACCOUNT_CODE2 = '') OR (ACCOUNT_CODE2 = 'N')) THEN (CONTRACT_AMT) / 10 * 127 / 1000
			 WHEN ACCOUNT_CODE = 'I' AND ACCOUNT_CODE2 IN ('S', 'W', 'M') THEN (CONTRACT_AMT) / 10 * 72 / 1000
			 WHEN ACCOUNT_CODE = 'O' AND ((ACCOUNT_CODE2 IS NULL) OR (ACCOUNT_CODE2 = '') OR (ACCOUNT_CODE2 = 'N')) THEN (CONTRACT_AMT) / 10 * 177 / 1000
			 WHEN ACCOUNT_CODE = 'O' AND ACCOUNT_CODE2 IN ('S', 'W', 'M') THEN (CONTRACT_AMT) / 10 * 238 / 1000
			 WHEN ACCOUNT_CODE = 'K' THEN (CONTRACT_AMT) / 10 * 17 / 1000
			 WHEN ACCOUNT_CODE = 'Z' THEN (CONTRACT_AMT) / 10 * 213 / 1000
			 ELSE 0 END) AS MS093,
		SUM(CASE WHEN ACCOUNT_CODE='Y'
			 THEN LOAN_AMT + PASS_DUE_AMT
			 ELSE 0 END) AS MS105,
		SUM(CASE WHEN ACCOUNT_CODE = 'Y' AND ISNULL(PC_12,0) > 0 
			 THEN 1
			 ELSE 0 END) AS FS302,
		SUM(CASE WHEN ACCOUNT_CODE = 'Y' AND
			         (ISNULL(LOAN_AMT,0) + ISNULL(PASS_DUE_AMT,0)) > 0
			 THEN 1
			 ELSE 0 END) AS FS309,
		SUM(CASE WHEN PC_12 > 0
			 THEN 1
			 ELSE 0 END) AS FS334B_1M,
		SUM(CASE WHEN PURPOSE_CODE = '4' AND
					  LEN(LTRIM(RTRIM(PAY_CODE_12))) + 
					  INQUIRY_MON - 1-
					  CAST(ISNULL(DATA_YYY, 0) AS INT)*12-CAST(ISNULL(DATA_MM, 0) AS INT) <= 9
			 THEN 1
			 ELSE 0 END) AS FS546_9M,
		SUM(CASE WHEN ACCOUNT_CODE = 'Y' AND
		            (CAST(ISNULL(LOAN_AMT,0) + ISNULL(PASS_DUE_AMT,0) AS DECIMAL) / 
                     (CASE WHEN ISNULL(CONTRACT_AMT,0) = 0 THEN NULL
						   ELSE CONTRACT_AMT END)) >= 0.95
			 THEN 1
			 ELSE 0 END) AS FS314B
FROM	BAM086_DEDUP
GROUP BY MSN
GO


UPDATE KTB_BASE_20060710
SET	FS036 = (
	SELECT	FS036
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN),
	FS040 = (
	SELECT	FS040
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN),
	FS044 = (
	SELECT	FS044
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN),
	MS063 = (
	SELECT	MS063
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN),
	MS074 = (
	SELECT	MS074
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN),
	MS093 = (
	SELECT	MS093
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN),
	MS105 = (
	SELECT	MS105
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN),
	FS302 = (
	SELECT	FS302
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN),
	FS309 = (
	SELECT	FS309
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN),
	FS334B_1M = (
	SELECT	FS334B_1M
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN),
	FS546_9M = (
	SELECT	FS546_9M
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN),
	FS314B = (
	SELECT	FS314B
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN)
WHERE	MSN IN (
	SELECT	MSN
	FROM	TMP)
GO
DROP VIEW TMP
GO

/* FS334 */

CREATE VIEW TMP1 AS
SELECT	MSN, PC_01 AS BUCKET
FROM	BAM086_DEDUP
UNION
SELECT	MSN, PC_02 AS BUCKET
FROM	BAM086_DEDUP
UNION
SELECT	MSN, PC_03 AS BUCKET
FROM	BAM086_DEDUP
UNION
SELECT	MSN, PC_04 AS BUCKET
FROM	BAM086_DEDUP
UNION
SELECT	MSN, PC_05 AS BUCKET
FROM	BAM086_DEDUP
UNION
SELECT	MSN, PC_06 AS BUCKET
FROM	BAM086_DEDUP
UNION
SELECT	MSN, PC_07 AS BUCKET
FROM	BAM086_DEDUP
UNION
SELECT	MSN, PC_08 AS BUCKET
FROM	BAM086_DEDUP
UNION
SELECT	MSN, PC_09 AS BUCKET
FROM	BAM086_DEDUP
UNION
SELECT	MSN, PC_10 AS BUCKET
FROM	BAM086_DEDUP
UNION
SELECT	MSN, PC_11 AS BUCKET
FROM	BAM086_DEDUP
UNION
SELECT	MSN, PC_12 AS BUCKET
FROM	BAM086_DEDUP
GO

CREATE VIEW TMP2 AS
SELECT MSN, MAX(BUCKET) AS FS334
FROM TMP1
GROUP BY MSN
GO

UPDATE KTB_BASE_20060710
SET	FS334 = (
	SELECT	FS334
	FROM	TMP2
	WHERE	MSN = KTB_BASE_20060710.MSN)
WHERE	MSN IN (
		SELECT MSN
		FROM	TMP2)
GO
DROP VIEW TMP1
GO
DROP VIEW TMP2
GO





/*BEGINNING KRM023-RELATED *****************************************/
ALTER TABLE KTB_BASE_20060710 ADD
	APP_MAX_BUCKET	INT,
	CDEF_FLAG_1M	INT,
	FS002_3M_1K		INT,
	FS014_6M		INT,
	FS016C_9M		INT,
	FS016F_12M		INT,
	FS018_12M		INT,
	FS021_9M		INT,
	FS059_12M_1K	INT,
	FS059_3M_1K		INT,
	FS061_6M_1K		INT,
	FS073B_12M		INT,
	FS101_6M		INT,
	FS205_3M_1K		INT,
	MS001_12M_1K	FLOAT,
	MS094B			FLOAT,
	MS118_9M		FLOAT,
	MS601			FLOAT,
	MS605			FLOAT,
	MS606			FLOAT,
	WI001_9M		FLOAT,
	WI003_9M		FLOAT,
	WI004_9M		FLOAT
GO

/* APP_MAX_BUCKET */

CREATE VIEW TMP AS
SELECT MSN, MAX(BUCKET_EF_1K) AS APP_MAX_BUCKET
FROM	COMBINED_KRM023_DEDUP
GROUP BY MSN
GO
UPDATE KTB_BASE_20060710
SET	APP_MAX_BUCKET = (
	SELECT	APP_MAX_BUCKET
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN)
WHERE	MSN IN (
		SELECT	MSN
		FROM	TMP)
GO
DROP VIEW TMP
GO


/* CDEF_FLAG_1M   */
CREATE VIEW TMP AS
SELECT MSN, MON_SINCE
FROM	COMBINED_KRM023_DEDUP AS A
WHERE	INQUIRY_MON-1 - MON_SINCE <= 1 /* WITH 30-DAY RULE                */
AND		(PAY_CODE IN ('C','D','E','F') OR
		 (CASH = 'Y' AND ISNULL(SPREAD_PAYMENT,0) > 0))
GO

UPDATE KTB_BASE_20060710
SET	CDEF_FLAG_1M = 0
WHERE MSN IN (
		SELECT	MSN
		FROM	COMBINED_KRM023_DEDUP)
GO
UPDATE KTB_BASE_20060710
SET	CDEF_FLAG_1M = 1
WHERE MSN IN (
		SELECT	MSN
		FROM	TMP)
GO
DROP VIEW TMP
GO


/* FS002_3M_1K    */
CREATE VIEW TMP AS
SELECT MSN, COUNT(DISTINCT MON_SINCE) AS FS002_3M_1K
FROM	COMBINED_KRM023_DEDUP
WHERE	INQUIRY_MON-1 - MON_SINCE <= 3 /* WITH 30-DAY RULE                */
AND		BUCKET_EF_1K > 0
GROUP BY MSN
GO

UPDATE KTB_BASE_20060710
SET FS002_3M_1K = 0
WHERE MSN IN (
	SELECT	MSN
	FROM	COMBINED_KRM023_DEDUP)
GO
UPDATE KTB_BASE_20060710
SET FS002_3M_1K = (
	SELECT	FS002_3M_1K
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN)
WHERE MSN IN (
	SELECT	MSN
	FROM	TMP)
GO
DROP VIEW TMP
GO


/* FS014_6M       */
CREATE VIEW TMP AS
SELECT MSN, COUNT(DISTINCT ISSUE) AS FS014_6M
FROM	COMBINED_KRM023_DEDUP
WHERE	INQUIRY_MON - MON_SINCE <= 6 /* NO 30-DAY RULE                */
AND		INQUIRY_MON - MON_SINCE > 0  /* ELIMINATE MOST RECENT 1 MONTH */
AND		PAY_CODE IN ('A','B')
GROUP BY MSN
GO

UPDATE KTB_BASE_20060710
SET FS014_6M = 0
WHERE MSN IN (
	SELECT	MSN
	FROM	COMBINED_KRM023_DEDUP)
GO

UPDATE KTB_BASE_20060710
SET FS014_6M = (
	SELECT FS014_6M
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN)
WHERE MSN IN (
	SELECT	MSN
	FROM	TMP)
GO
DROP VIEW TMP
GO


/* FS016C_9M      */
CREATE VIEW TMP AS
SELECT	MSN, COUNT(DISTINCT ISSUE) AS FS016C_9M
FROM	COMBINED_KRM023_DEDUP
WHERE	INQUIRY_MON-1 - MON_SINCE <= 9 /* WITH 30-DAY RULE            */
AND		CASH = 'Y'
AND		(PAY_CODE IN ('C','D','E','F') OR
		 (CASH = 'Y' AND ISNULL(SPREAD_PAYMENT,0) > 0))
GROUP BY MSN
GO

UPDATE KTB_BASE_20060710
SET FS016C_9M = 0
WHERE MSN IN (
	SELECT	MSN
	FROM	COMBINED_KRM023_DEDUP)
GO

UPDATE KTB_BASE_20060710
SET FS016C_9M = (
	SELECT FS016C_9M
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN)
WHERE MSN IN (
	SELECT	MSN
	FROM	TMP)
GO
DROP VIEW TMP
GO


/* FS016F_12M & FS018_12M    */
CREATE VIEW TMP AS
SELECT	MSN, COUNT(*) AS FS016F_12M,
		COUNT(DISTINCT MON_SINCE) AS FS018_12M 
FROM	COMBINED_KRM023_DEDUP
WHERE	CASH = 'Y'
GROUP BY MSN
GO

UPDATE KTB_BASE_20060710
SET FS016F_12M = 0,
	FS018_12M = 0
WHERE MSN IN (
	SELECT	MSN
	FROM	COMBINED_KRM023_DEDUP)
GO

UPDATE KTB_BASE_20060710
SET FS016F_12M = (
	SELECT FS016F_12M
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN),
	FS018_12M = (
	SELECT FS018_12M
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN)
WHERE MSN IN (
	SELECT	MSN
	FROM	TMP)
GO
DROP VIEW TMP
GO


/* FS021_9M       */
CREATE VIEW TMP AS
SELECT MSN, COUNT(DISTINCT MON_SINCE) AS FS021_9M
FROM	COMBINED_KRM023_DEDUP
WHERE	INQUIRY_MON-1 - MON_SINCE <= 9 /* WITH 30-DAY RULE            */
AND		(PAY_CODE IN ('C','D','E','F') OR
		 (CASH = 'Y' AND ISNULL(SPREAD_PAYMENT,0) > 0))
GROUP BY MSN
GO

UPDATE KTB_BASE_20060710
SET FS021_9M = 0
WHERE MSN IN (
	SELECT	MSN
	FROM	COMBINED_KRM023_DEDUP)
GO
UPDATE KTB_BASE_20060710
SET FS021_9M = (
	SELECT	FS021_9M
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN)
WHERE MSN IN (
	SELECT	MSN
	FROM	TMP)
GO
DROP VIEW TMP
GO


/* FS059_12M_1K   */
CREATE VIEW TMP AS
SELECT MSN, COUNT(DISTINCT ISSUE) AS FS059_12M_1K
FROM	COMBINED_KRM023_DEDUP
WHERE	BUCKET_EF_1K > 0
GROUP BY MSN
GO

UPDATE KTB_BASE_20060710
SET FS059_12M_1K = 0
WHERE MSN IN (
	SELECT	MSN
	FROM	COMBINED_KRM023_DEDUP)
GO
UPDATE KTB_BASE_20060710
SET FS059_12M_1K = (
	SELECT	FS059_12M_1K
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN)
WHERE MSN IN (
	SELECT	MSN
	FROM	TMP)
GO
DROP VIEW TMP
GO


/* FS059_3M_1K    */
CREATE VIEW TMP AS
SELECT MSN, COUNT(DISTINCT ISSUE) AS FS059_3M_1K
FROM	COMBINED_KRM023_DEDUP
WHERE	INQUIRY_MON-1 - MON_SINCE <= 3 /* WITH 30-DAY RULE            */
AND		BUCKET_EF_1K > 0
GROUP BY MSN
GO

UPDATE KTB_BASE_20060710
SET FS059_3M_1K = 0
WHERE MSN IN (
	SELECT	MSN
	FROM	COMBINED_KRM023_DEDUP)
GO
UPDATE KTB_BASE_20060710
SET FS059_3M_1K = (
	SELECT	FS059_3M_1K
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN)
WHERE MSN IN (
	SELECT	MSN
	FROM	TMP)
GO
DROP VIEW TMP
GO


/* FS061_6M_1K    */
CREATE VIEW TMP AS
SELECT MSN, COUNT(DISTINCT ISSUE) AS FS061_6M_1K
FROM	COMBINED_KRM023_DEDUP
WHERE	INQUIRY_MON-1 - MON_SINCE <= 6 /* WITH 30-DAY RULE            */
AND		BUCKET_DEF_1K > 0
GROUP BY MSN
GO

UPDATE KTB_BASE_20060710
SET FS061_6M_1K = 0
WHERE MSN IN (
	SELECT	MSN
	FROM	COMBINED_KRM023_DEDUP)
GO
UPDATE KTB_BASE_20060710
SET FS061_6M_1K = (
	SELECT	FS061_6M_1K
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN)
WHERE MSN IN (
	SELECT	MSN
	FROM	TMP)
GO
DROP VIEW TMP
GO


/* FS073B_12M     */
CREATE VIEW MAX_BUCKET AS
SELECT MSN, ISSUE, MAX(BUCKET_EF_1K) AS MAX_BUCKET
FROM	COMBINED_KRM023_DEDUP
GROUP BY MSN, ISSUE
GO
CREATE VIEW TMP AS
SELECT	MSN, SUM(MAX_BUCKET) AS FS073B_12M
FROM	MAX_BUCKET
GROUP BY MSN
GO

UPDATE KTB_BASE_20060710
SET FS073B_12M = 0
WHERE MSN IN (
	SELECT	MSN
	FROM	COMBINED_KRM023_DEDUP)
GO
UPDATE KTB_BASE_20060710
SET FS073B_12M = (
	SELECT	FS073B_12M
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN)
WHERE MSN IN (
	SELECT	MSN
	FROM	TMP)
GO
DROP VIEW MAX_BUCKET
GO
DROP VIEW TMP
GO


/* FS101_6M       */
CREATE VIEW TMP AS
SELECT MSN, COUNT(DISTINCT ISSUE) AS FS101_6M
FROM	COMBINED_KRM023_DEDUP
WHERE	INQUIRY_MON-1 - MON_SINCE <= 6 /* WITH 30-DAY RULE            */
GROUP BY MSN
GO

UPDATE KTB_BASE_20060710
SET FS101_6M = 0
WHERE MSN IN (
	SELECT	MSN
	FROM	COMBINED_KRM023_DEDUP)
GO
UPDATE KTB_BASE_20060710
SET FS101_6M = (
	SELECT	FS101_6M
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN)
WHERE MSN IN (
	SELECT	MSN
	FROM	TMP)
GO
DROP VIEW TMP
GO


/* FS205_3M_1K    */
CREATE VIEW TMP AS
SELECT	MSN, COUNT(*) AS FS205_3M_1K
FROM	COMBINED_KRM023_DEDUP AS A
WHERE	EXISTS (
		SELECT	ISSUE 
		FROM	LATEST_LINE
		WHERE	MSN = A.MSN
		AND		ISSUE = A.ISSUE
		AND		MOB <= 12) 
AND		(PAY_CODE IN ('C', 'D', 'E','F') OR
		 (CASH='Y' AND ISNULL(SPREAD_PAYMENT,0)>0))
AND		ISNULL(PAYMENT_AMT,0)+ISNULL(SPREAD_PAYMENT,0) > 1
AND		INQUIRY_MON-1 - MON_SINCE <= 3  /* WITH 30-DAY RULE  */
GROUP BY MSN
GO

UPDATE KTB_BASE_20060710
SET FS205_3M_1K = 0
WHERE MSN IN (
	SELECT	A.MSN
	FROM	COMBINED_KRM023_DEDUP AS A, KRM021_DEDUP AS B
	WHERE	A.MSN = B.MSN
	AND		((A.ISSUE = B.ISSUE) OR 
			 (B.ISSUE = '021' AND A.ISSUE IN ('CTV', 'CTM', 'CTD')) OR
			 (B.ISSUE = 'A82' AND A.ISSUE IN ('AEA','AEE','A82'))))
GO
UPDATE KTB_BASE_20060710
SET FS205_3M_1K = (
	SELECT	FS205_3M_1K
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN)
WHERE MSN IN (
	SELECT	MSN
	FROM	TMP)
GO
DROP VIEW TMP
GO


/* MS001_12M_1K   */
CREATE VIEW TMP AS
SELECT	MSN, MON_SINCE,SUM(ISNULL(PAYMENT_AMT,0)+ISNULL(SPREAD_PAYMENT,0)) AS MS001_12M_1K
FROM	COMBINED_KRM023_DEDUP
WHERE	BUCKET_EF_1K > 0
GROUP BY MSN, MON_SINCE
GO

UPDATE KTB_BASE_20060710
SET MS001_12M_1K = 0
WHERE MSN IN (
	SELECT	MSN
	FROM	COMBINED_KRM023_DEDUP)
GO
UPDATE KTB_BASE_20060710
SET MS001_12M_1K = (
	SELECT	MAX(MS001_12M_1K)
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN)
WHERE MSN IN (
	SELECT	MSN
	FROM	TMP)
GO
DROP VIEW TMP
GO


/* MS094B          */
CREATE VIEW TMP AS
SELECT	MSN, 
		SUM(CASE WHEN PAY_CODE IN ('C','D','E','F') 
				      THEN ISNULL(PAYMENT_AMT,0)+ISNULL(SPREAD_PAYMENT,0)
				 WHEN CASH = 'Y' AND ISNULL(SPREAD_PAYMENT,0) > 0 
                      THEN ISNULL(SPREAD_PAYMENT,0)
				 ELSE 0 END)
		/COUNT(DISTINCT MON_SINCE) AS MS094B
FROM	COMBINED_KRM023_DEDUP
WHERE	INQUIRY_MON-1 - MON_SINCE <=3  /* WITH 30-DAY RULE */
AND		INQUIRY_MON   - MON_SINCE > 1  /* TRUNCATE THE TRIALING 2 MONTHS */
GROUP BY MSN
GO

UPDATE KTB_BASE_20060710
SET MS094B = 0
WHERE MSN IN (
	SELECT	MSN
	FROM	COMBINED_KRM023_DEDUP)
GO
UPDATE KTB_BASE_20060710
SET MS094B = (
	SELECT	MS094B
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN)
WHERE MSN IN (
	SELECT	MSN
	FROM	TMP)
GO
DROP VIEW TMP
GO


/* MS118_9M       */
CREATE VIEW TMP AS
SELECT	MSN, 
		MIN(
           CASE WHEN PAY_CODE IN ('C','D','E','F') THEN ISNULL(PAYMENT_AMT,0)+ISNULL(SPREAD_PAYMENT,0)
				WHEN CASH = 'Y' AND ISNULL(SPREAD_PAYMENT,0)>0 THEN ISNULL(SPREAD_PAYMENT,0)
				ELSE 0 END /
							CAST(LIMIT AS FLOAT)) AS MS118_9M
FROM	COMBINED_KRM023_DEDUP
WHERE	INQUIRY_MON   - MON_SINCE <=9  /* NO   30-DAY RULE */
AND		CAST(LIMIT AS FLOAT) > 0
AND		((PAY_CODE IN ('C','D','E','F') AND
		ISNULL(PAYMENT_AMT,0)+ISNULL(SPREAD_PAYMENT,0) > 1) OR    /* TO ELIMINATE THOSE SMALL REVOLING LINES */
		(CASH = 'Y' AND ISNULL(SPREAD_PAYMENT,0)>1))
GROUP BY MSN
GO

UPDATE KTB_BASE_20060710
SET MS118_9M = 0
WHERE MSN IN (
	SELECT	MSN
	FROM	COMBINED_KRM023_DEDUP)
GO
UPDATE KTB_BASE_20060710
SET MS118_9M = (
	SELECT	MS118_9M
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN)
WHERE MSN IN (
	SELECT	MSN
	FROM	TMP)
GO
DROP VIEW TMP
GO


/* MS601 & MS606        */
CREATE VIEW KRM023_LATEST_STMT AS
SELECT	MSN, ISSUE, MAX(MON_SINCE) LAST_MON_SINCE
FROM	COMBINED_KRM023_DEDUP
WHERE	INQUIRY_MON  - MON_SINCE <=3  /* NO   30-DAY RULE */
GROUP BY MSN, ISSUE
GO
CREATE VIEW TMP AS
SELECT	MSN,
		SUM(CASE WHEN PAY_CODE IN ('C','D','E','F') THEN ISNULL(PAYMENT_AMT,0)+ISNULL(SPREAD_PAYMENT,0)
				 WHEN CASH = 'Y' AND ISNULL(SPREAD_PAYMENT,0)>0 THEN ISNULL(SPREAD_PAYMENT,0)
				 ELSE 0 END) AS MS601,
		SUM(CASE WHEN PAY_CODE IN ('C','D','E','F') THEN ISNULL(PAYMENT_AMT,0)
				 ELSE 0 END
			 +ISNULL(SPREAD_PAYMENT,0)) AS MS606
FROM	COMBINED_KRM023_DEDUP AS A
WHERE	EXISTS (
		SELECT	*
		FROM	KRM023_LATEST_STMT
		WHERE	MSN = A.MSN
		AND		ISSUE = A.ISSUE
		AND		LAST_MON_SINCE = A.MON_SINCE)
GROUP BY MSN
GO

UPDATE KTB_BASE_20060710
SET MS601 = 0
WHERE MSN IN (
	SELECT	MSN
	FROM	COMBINED_KRM023_DEDUP)
GO
UPDATE KTB_BASE_20060710
SET MS606 = 0
WHERE MSN IN (
	SELECT	MSN
	FROM	COMBINED_KRM023_DEDUP
	UNION	
	SELECT	MSN
	from	BAM086_DEDUP)
GO
UPDATE KTB_BASE_20060710
SET MS601 = (
	SELECT	MS601
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN),
	MS606 = (
	SELECT	MS606
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN)
WHERE MSN IN (
	SELECT	MSN
	FROM	TMP)
GO
UPDATE KTB_BASE_20060710
SET MS606 = isnull(MS606,0)+isnull(MS063,0)
WHERE MSN IN (
	SELECT	MSN
	FROM	TMP
	UNION	
	SELECT	MSN
	from	BAM086_DEDUP)
GO
DROP VIEW KRM023_LATEST_STMT
GO
DROP VIEW TMP
GO


/* MS605          */
CREATE VIEW KRM023_LATEST_STMT_NO_ZERO AS
SELECT	MSN, ISSUE, MAX(MON_SINCE) LAST_MON_SINCE
FROM	COMBINED_KRM023_DEDUP
WHERE	INQUIRY_MON   - MON_SINCE <=3  /* NO   30-DAY RULE */
AND		CAST(LIMIT AS FLOAT) > 0
GROUP BY MSN, ISSUE
GO
CREATE VIEW TMP AS
SELECT	MSN, AVG(CAST(LIMIT AS FLOAT)) AS MS605
FROM	COMBINED_KRM023_DEDUP AS A
WHERE	EXISTS (
		SELECT	*
		FROM	KRM023_LATEST_STMT_NO_ZERO
		WHERE	MSN = A.MSN
		AND		ISSUE = A.ISSUE
		AND		LAST_MON_SINCE = A.MON_SINCE)
GROUP BY MSN
GO

UPDATE KTB_BASE_20060710
SET MS605 = 0
WHERE MSN IN (
	SELECT	MSN
	FROM	COMBINED_KRM023_DEDUP)
GO
UPDATE KTB_BASE_20060710
SET MS605 = (
	SELECT	MS605
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN)
WHERE MSN IN (
	SELECT	MSN
	FROM	TMP)
GO
DROP VIEW KRM023_LATEST_STMT_NO_ZERO
GO
DROP VIEW TMP
GO


/* WI001_9M       */
/* WI003_9M       */
/* WI004_9M       */
CREATE VIEW TMP AS
SELECT	MSN, MON_SINCE, 
		CAST(COUNT(DISTINCT ISSUE) AS FLOAT)	AS WI001_9M,
		SUM(CASE WHEN CAST(LIMIT AS FLOAT) > 200 THEN 1.0 ELSE 0.0 END) AS WI003_9M,
		SUM(CAST(LIMIT AS FLOAT)) AS WI004_9M
FROM	COMBINED_KRM023_DEDUP
WHERE	INQUIRY_MON-1 - MON_SINCE <=9  /* WITH 30-DAY RULE */
AND		INQUIRY_MON - MON_SINCE > 1    /* CUT LAST 2 MONTHS */
GROUP BY MSN, MON_SINCE
GO
UPDATE KTB_BASE_20060710
SET WI001_9M = 0,
	WI003_9M = 0,
	WI004_9M = 0
WHERE MSN IN (
	SELECT	MSN
	FROM	COMBINED_KRM023_DEDUP)
GO
UPDATE KTB_BASE_20060710
SET WI001_9M = (
	SELECT	SUM(WI001_9M)/9
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN),
	WI003_9M = (
	SELECT	SUM(WI003_9M)/9
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN),
	WI004_9M = (
	SELECT	SUM(WI004_9M)/9
	FROM	TMP
	WHERE	MSN = KTB_BASE_20060710.MSN)
WHERE MSN IN (
	SELECT	MSN
	FROM	TMP)
GO
DROP VIEW TMP
GO


/*--EOF---EOF---EOF---EOF---EOF---EOF---EOF---EOF---EOF---EOF---EOF---EOF--*/








