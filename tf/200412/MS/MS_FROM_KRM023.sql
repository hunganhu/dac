USE TF_KHJ
GO

/*----TF_KHJ----*/


/*----MS001----*/
/*---Init temp table----*/
DECLARE @NOW INT
DECLARE @i INT
SET @NOW = 93 * 12 + 12
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
SET @i = 3
/*---Start making MS001---*/
INSERT INTO MS_TMP1
SELECT IDN, Mon_Since, SUM(Payment_amt)
FROM KRM023_200412
WHERE Bucket_ef_1K >=1
GROUP BY IDN, Mon_Since

WHILE @i<=12
BEGIN

  INSERT INTO MS_TMP
  SELECT IDN, @i, MAX(V1), NULL, NULL
  FROM MS_TMP1
  WHERE (@NOW - Mon)<= @i AND
        (@Now - Mon) > 0 
  GROUP BY IDN 
 
SET @i = @i + 3
END

UPDATE MS_200412
SET
MS001_3M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=3

UPDATE MS_200412
SET
MS001_6M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=6

UPDATE MS_200412
SET
MS001_9M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=9

UPDATE MS_200412
SET
MS001_12M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=12
GO

/*----MS002----*/
/*---Init temp table----*/
DECLARE @NOW INT
DECLARE @i INT
SET @NOW = 93 * 12 + 12
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
SET @i = 3
/*---Start making MS002---*/
INSERT INTO MS_TMP1
SELECT IDN, Mon_Since, SUM(Payment_amt)
FROM KRM023_200412 
WHERE Bucket_f_1K >=1
GROUP BY IDN, Mon_Since 

WHILE @i<=12
BEGIN

  INSERT INTO MS_TMP
  SELECT IDN, @i, MAX(V1), NULL, NULL
  FROM MS_TMP1
  WHERE (@NOW - Mon)<= @i AND
        (@Now - Mon) > 0 
  GROUP BY IDN 
 
SET @i = @i + 3
END

UPDATE MS_200412
SET
MS002_3M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=3

UPDATE MS_200412
SET
MS002_6M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=6

UPDATE MS_200412
SET
MS002_9M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=9

UPDATE MS_200412
SET
MS002_12M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=12
GO


/*----MS003----*/
/*---Init temp table----*/
DECLARE @NOW INT
DECLARE @i INT
SET @NOW = 93 * 12 + 12
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
SET @i = 3
/*---Start making MS003---*/
INSERT INTO MS_TMP1
SELECT IDN, Mon_Since, SUM(Payment_amt)
FROM KRM023_200412
WHERE Bucket_ef_1K >=2
GROUP BY IDN, Mon_Since

WHILE @i<=12
BEGIN

  INSERT INTO MS_TMP
  SELECT IDN, @i, MAX(V1), NULL, NULL
  FROM MS_TMP1
  WHERE (@NOW - Mon)<= @i AND
        (@Now - Mon) > 0  
  GROUP BY IDN
 
SET @i = @i + 3
END

UPDATE MS_200412
SET
MS003_3M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=3

UPDATE MS_200412
SET
MS003_6M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=6

UPDATE MS_200412
SET
MS003_9M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=9

UPDATE MS_200412
SET
MS003_12M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=12
GO


/*----MS004----*/
/*---Init temp table----*/
DECLARE @NOW INT
DECLARE @i INT
SET @NOW = 93 * 12 + 12
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
SET @i = 3
/*---Start making MS004---*/
INSERT INTO MS_TMP1
SELECT IDN, Mon_Since, SUM(Payment_amt)
FROM KRM023_200412
WHERE Bucket_f_1K >=2
GROUP BY IDN, Mon_Since 

WHILE @i<=12
BEGIN

  INSERT INTO MS_TMP
  SELECT IDN, @i, MAX(V1), NULL, NULL
  FROM MS_TMP1
  WHERE (@NOW - Mon)<= @i AND
        (@Now - Mon) > 0  
  GROUP BY IDN
 
SET @i = @i + 3
END

UPDATE MS_200412
SET
MS004_3M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=3

UPDATE MS_200412
SET
MS004_6M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=6

UPDATE MS_200412
SET
MS004_9M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=9

UPDATE MS_200412
SET
MS004_12M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=12
GO


/*----MS005----*/
/*---Init temp table----*/
DECLARE @NOW INT
DECLARE @i INT
SET @NOW = 93 * 12 + 12
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
SET @i = 3
/*---Start making MS005---*/
INSERT INTO MS_TMP1
SELECT IDN, Mon_Since, SUM(Payment_amt)
FROM KRM023_200412
WHERE Bucket_ef_1K >=3
GROUP BY IDN, Mon_Since 

WHILE @i<=12
BEGIN

  INSERT INTO MS_TMP
  SELECT IDN, @i, MAX(V1), NULL, NULL
  FROM MS_TMP1
  WHERE (@NOW - Mon)<= @i AND
        (@Now - Mon) > 0  
  GROUP BY IDN  
 
SET @i = @i + 3
END

UPDATE MS_200412
SET
MS005_3M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=3

UPDATE MS_200412
SET
MS005_6M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=6

UPDATE MS_200412
SET
MS005_9M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=9

UPDATE MS_200412
SET
MS005_12M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=12
GO


/*----MS006----*/
/*---Init temp table----*/
DECLARE @NOW INT
DECLARE @i INT
SET @NOW = 93 * 12 + 12
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
SET @i = 3
/*---Start making MS006---*/
INSERT INTO MS_TMP1
SELECT IDN, Mon_Since, SUM(Payment_amt)
FROM KRM023_200412
WHERE Bucket_f_1K >=3
GROUP BY IDN, Mon_Since

WHILE @i<=12
BEGIN

  INSERT INTO MS_TMP
  SELECT IDN, @i, MAX(V1), NULL, NULL
  FROM MS_TMP1
  WHERE (@NOW - Mon)<= @i AND
        (@Now - Mon) > 0  
  GROUP BY IDN  
 
SET @i = @i + 3
END

UPDATE MS_200412
SET
MS006_3M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=3

UPDATE MS_200412
SET
MS006_6M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=6

UPDATE MS_200412
SET
MS006_9M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=9

UPDATE MS_200412
SET
MS006_12M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=12
GO


/*----MS056----*/
/*---Init temp table----*/
DECLARE @NOW INT
DECLARE @i INT
SET @NOW = 93 * 12 + 12
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
SET @i = 3
/*---Start making MS056---*/
INSERT INTO MS_TMP1 
SELECT IDN, Mon_Since, SUM(Payment_amt)
FROM KRM023_200412
WHERE Pay_Code IN ('D', 'E', 'F') AND
      Bucket_def_1K >=1
GROUP BY IDN, Mon_Since  

WHILE @i<=12
BEGIN

  INSERT INTO MS_TMP
  SELECT IDN, @i, MAX(V1), NULL, NULL
  FROM MS_TMP1
  WHERE (@NOW - Mon)<= @i AND
        (@NOW - Mon) > 0 
  GROUP BY IDN  
 
SET @i = @i + 3
END

UPDATE MS_200412
SET
MS056_3M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=3

UPDATE MS_200412
SET
MS056_6M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=6

UPDATE MS_200412
SET
MS056_9M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=9

UPDATE MS_200412
SET
MS056_12M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=12
GO



/*----MS057----*/
/*---Init temp table----*/
DECLARE @NOW INT
DECLARE @i INT
SET @NOW = 93 * 12 + 12
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
SET @i = 3
/*---Start making MS057---*/
INSERT INTO MS_TMP1 
SELECT IDN, Mon_Since, SUM(Payment_amt)
FROM KRM023_200412
WHERE Pay_Code IN ('D', 'E', 'F') AND
      Bucket_def_1K >=2
GROUP BY IDN, Mon_Since  

WHILE @i<=12
BEGIN

  INSERT INTO MS_TMP
  SELECT IDN, @i, MAX(V1), NULL, NULL
  FROM MS_TMP1
  WHERE (@NOW - Mon)<= @i AND
        (@NOW - Mon) > 0  
  GROUP BY IDN  
 
SET @i = @i + 3
END

UPDATE MS_200412
SET
MS057_3M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=3

UPDATE MS_200412
SET
MS057_6M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=6

UPDATE MS_200412
SET
MS057_9M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=9

UPDATE MS_200412
SET
MS057_12M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=12
GO


/*----MS058----*/
/*---Init temp table----*/
DECLARE @NOW INT
DECLARE @i INT
SET @NOW = 93 * 12 + 12
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
SET @i = 3
/*---Start making MS058---*/
INSERT INTO MS_TMP1 
SELECT IDN, Mon_Since, SUM(Payment_amt)
FROM KRM023_200412
WHERE Pay_Code IN ('D', 'E', 'F') AND
      Bucket_def_1K >=3
GROUP BY IDN, Mon_Since 

WHILE @i<=12
BEGIN

  INSERT INTO MS_TMP
  SELECT IDN, @i, MAX(V1), NULL, NULL
  FROM MS_TMP1
  WHERE (@NOW - Mon)<= @i AND
        (@NOW - Mon) > 0 
  GROUP BY IDN  
 
SET @i = @i + 3
END

UPDATE MS_200412
SET
MS058_3M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=3

UPDATE MS_200412
SET
MS058_6M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=6

UPDATE MS_200412
SET
MS058_9M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=9

UPDATE MS_200412
SET
MS058_12M_1k = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=12
GO



/*----MS008----*/
/*---Init temp table----*/
DECLARE @NOW INT
DECLARE @i INT
SET @NOW = 93 * 12 + 12
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
SET @i = 3
/*---Start making MS008---*/
INSERT INTO MS_TMP1
SELECT IDN, Mon_Since, SUM(Payment_amt)
FROM KRM023_200412
GROUP BY IDN, Mon_Since 

WHILE @i<=12
BEGIN

  INSERT INTO MS_TMP
  SELECT IDN, @i, MAX(V1), NULL, NULL
  FROM MS_TMP1
  WHERE (@NOW - Mon)<= @i AND
        (@NOW - Mon) > 0  
  GROUP BY IDN  
 
SET @i = @i + 3
END

UPDATE MS_200412
SET
MS008_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=3

UPDATE MS_200412
SET
MS008_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=6

UPDATE MS_200412
SET
MS008_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=9

UPDATE MS_200412
SET
MS008_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=12
GO


/*----MS009----*/
/*---Init temp table----*/
DECLARE @NOW INT
DECLARE @i INT
SET @NOW = 93 * 12 + 12
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
SET @i = 3
/*---Start making MS009---*/
INSERT INTO MS_TMP1
SELECT IDN, Mon_Since, SUM(Payment_amt)
FROM KRM023_200412
GROUP BY IDN, Mon_Since 

WHILE @i<=12
BEGIN

  INSERT INTO MS_TMP
  SELECT IDN, @i, AVG(V1), NULL, NULL
  FROM MS_TMP1
  WHERE (@NOW - Mon)<= @i AND
        (@NOW - Mon) > 0  
  GROUP BY IDN  
 
SET @i = @i + 3
END

UPDATE MS_200412
SET
MS009_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=3

UPDATE MS_200412
SET
MS009_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=6

UPDATE MS_200412
SET
MS009_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=9

UPDATE MS_200412
SET
MS009_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=12
GO


/*----MS010----*/
/*---Init temp table----*/
DECLARE @NOW INT
DECLARE @i INT
SET @NOW = 93 * 12 + 12
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
SET @i = 3
/*---Start making MS010---*/
WHILE @i<=12
BEGIN

  INSERT INTO MS_TMP
  SELECT IDN, @i, SUM(Payment_amt), NULL, NULL
  FROM KRM023_200412
  WHERE (@NOW - Mon_Since)<= @i  AND
        (@NOW - Mon_Since) > 0 AND
        Pay_Code IN ('A', 'B')
  GROUP BY IDN  
 
SET @i = @i + 3
END

UPDATE MS_200412
SET
MS010_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=3

UPDATE MS_200412
SET
MS010_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=6

UPDATE MS_200412
SET
MS010_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=9

UPDATE MS_200412
SET
MS010_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=12
GO


/*----MS011----*/
/*---Init temp table----*/
DECLARE @NOW INT
DECLARE @i INT
SET @NOW = 93 * 12 + 12
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
SET @i = 3
/*---Start making MS011---*/
INSERT INTO MS_TMP1
SELECT IDN, Mon_Since, SUM(CASE
                             WHEN Pay_Code IN ('A', 'B') THEN Payment_amt
                             ELSE 0
                           END)
FROM KRM023_200412
GROUP BY IDN, Mon_Since 

WHILE @i<=12
BEGIN

  INSERT INTO MS_TMP
  SELECT IDN, @i, AVG(V1), NULL, NULL
  FROM MS_TMP1
  WHERE (@NOW - Mon)<= @i AND
        (@NOW - Mon) > 0  
  GROUP BY IDN  
 
SET @i = @i + 3
END

UPDATE MS_200412
SET
MS011_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=3

UPDATE MS_200412
SET
MS011_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=6

UPDATE MS_200412
SET
MS011_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=9

UPDATE MS_200412
SET
MS011_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=12
GO


/*----MS012----*/
/*---Init temp table----*/
DECLARE @NOW INT
DECLARE @i INT
SET @NOW = 93 * 12 + 12
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
SET @i = 3
/*---Start making MS012---*/
WHILE @i<=12
BEGIN

  INSERT INTO MS_TMP
  SELECT IDN, @i, SUM(Payment_Amt), NULL, NULL
  FROM KRM023_200412
  WHERE (@NOW - Mon_Since)<= @i  AND
        (@NOW - Mon_Since) > 0 AND
        Pay_Code = 'C' AND
        Limit <> 0
  GROUP BY IDN  
 
SET @i = @i + 3
END

UPDATE MS_200412
SET
MS012_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=3

UPDATE MS_200412
SET
MS012_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=6

UPDATE MS_200412
SET
MS012_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=9

UPDATE MS_200412
SET
MS012_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=12
GO


/*----MS013----*/
/*---Init temp table----*/
DECLARE @NOW INT
DECLARE @i INT
SET @NOW = 93 * 12 + 12
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
SET @i = 3
/*---Start making MS013---*/
INSERT INTO MS_TMP1
SELECT IDN, Mon_Since, SUM(CASE
                             WHEN Pay_Code = 'C' THEN Payment_amt
                             ELSE 0
                           END)
FROM KRM023_200412
GROUP BY IDN, Mon_Since 

WHILE @i<=12
BEGIN

  INSERT INTO MS_TMP
  SELECT IDN, @i, AVG(V1), NULL, NULL
  FROM MS_TMP1
  WHERE (@NOW - Mon)<= @i AND
        (@NOW - Mon) > 0 
  GROUP BY IDN  
 
SET @i = @i + 3
END


UPDATE MS_200412
SET
MS013_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=3

UPDATE MS_200412
SET
MS013_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=6

UPDATE MS_200412
SET
MS013_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=9

UPDATE MS_200412
SET
MS013_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=12
GO


/*----MS014----*/
/*---Init temp table----*/
DECLARE @NOW INT
DECLARE @i INT
SET @NOW = 93 * 12 + 12
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
SET @i = 3
/*---Start making MS014---*/
INSERT INTO MS_TMP1
SELECT IDN, Mon_Since, SUM(CONVERT(float, Limit))
FROM KRM023_200412
GROUP BY IDN, Mon_Since 

WHILE @i<=12
BEGIN

  INSERT INTO MS_TMP
  SELECT IDN, @i, MAX(V1), NULL, NULL
  FROM MS_TMP1
  WHERE (@NOW - Mon)<= @i AND
        (@NOW - Mon) > 0  
  GROUP BY IDN  
 
SET @i = @i + 3
END

UPDATE MS_200412
SET
MS014_3M = (CASE WHEN V1=0 THEN NULL ELSE MS013_3M/V1 END)
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=3

UPDATE MS_200412
SET
MS014_6M = (CASE WHEN V1=0 THEN NULL ELSE MS013_6M/V1 END)
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=6

UPDATE MS_200412
SET
MS014_9M = (CASE WHEN V1=0 THEN NULL ELSE MS013_9M/V1 END)
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=9

UPDATE MS_200412
SET
MS014_12M = (CASE WHEN V1=0 THEN NULL ELSE MS013_12M/V1 END)
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=12
GO


/*----MS015----*/
/*---Init temp table----*/
DECLARE @NOW INT
DECLARE @i INT
SET @NOW = 93 * 12 + 12
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
SET @i = 3
/*---Start making MS015---*/
WHILE @i<=12
BEGIN

  INSERT INTO MS_TMP
  SELECT IDN, @i, MAX(Payment_amt/CONVERT(float,Limit)), NULL, NULL
  FROM KRM023_200412
  WHERE (@NOW - Mon_Since)<= @i AND
        (@NOW - Mon_Since) > 0  AND
        Pay_Code = 'C' AND
        Limit <> 0
  GROUP BY IDN  
 
SET @i = @i + 3
END

UPDATE MS_200412
SET
MS015_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=3

UPDATE MS_200412
SET
MS015_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=6

UPDATE MS_200412
SET
MS015_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=9

UPDATE MS_200412
SET
MS015_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=12
GO


/*----MS016----*/
/*---Init temp table----*/
DECLARE @NOW INT
DECLARE @i INT
SET @NOW = 93 * 12 + 12
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
SET @i = 3
/*---Start making MS016---*/
WHILE @i<=12
BEGIN

  INSERT INTO MS_TMP
  SELECT IDN, @i, MIN(Payment_amt/CONVERT(float,Limit)), NULL, NULL
  FROM KRM023_200412
  WHERE (@NOW - Mon_Since)<= @i AND
        (@NOW - Mon_Since) > 0  AND
        Pay_Code = 'C' AND
        Limit <> 0
  GROUP BY IDN  
 
SET @i = @i + 3
END

UPDATE MS_200412
SET
MS016_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=3

UPDATE MS_200412
SET
MS016_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=6

UPDATE MS_200412
SET
MS016_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=9

UPDATE MS_200412
SET
MS016_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=12
GO


/*----MS023----*/
/*---Init temp table----*/
DECLARE @NOW INT
DECLARE @i INT
SET @NOW = 93 * 12 + 12
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
SET @i = 3
/*---Start making MS023---*/
INSERT INTO MS_TMP1
SELECT IDN, Mon_Since, SUM(CONVERT(float,Limit))
FROM KRM023_200412
GROUP BY IDN, Mon_Since 

WHILE @i<=12
BEGIN

  INSERT INTO MS_TMP
  SELECT IDN, @i, AVG(V1), NULL, NULL
  FROM MS_TMP1
  WHERE (@NOW - Mon)<= @i  AND
        (@NOW - Mon) > 0 AND
        (V1 > 0)  
  GROUP BY IDN  
 
SET @i = @i + 3
END

UPDATE MS_200412
SET
MS023_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=3

UPDATE MS_200412
SET
MS023_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=6

UPDATE MS_200412
SET
MS023_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=9

UPDATE MS_200412
SET
MS023_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=12
GO


/*----MS024----*/
/*---Init temp table----*/
DECLARE @NOW INT
DECLARE @i INT
SET @NOW = 93 * 12 + 12
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
SET @i = 3
/*---Start making MS024---*/
WHILE @i<=12
BEGIN

  INSERT INTO MS_TMP
  SELECT IDN, @i, AVG(CONVERT(float,Limit)), NULL, NULL
  FROM KRM023_200412
  WHERE (@NOW - Mon_Since)<= @i  AND
        (@NOW - Mon_Since) > 0 AND
        CONVERT(float,Limit) > 0
  GROUP BY IDN  
 
SET @i = @i + 3
END

UPDATE MS_200412
SET
MS024_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=3

UPDATE MS_200412
SET
MS024_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=6

UPDATE MS_200412
SET
MS024_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=9

UPDATE MS_200412
SET
MS024_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=12
GO


/*----MS025----*/
/*---Init temp table----*/
DECLARE @NOW INT
DECLARE @i INT
SET @NOW = 93 * 12 + 12
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
SET @i = 3
/*---Start making MS025---*/
WHILE @i<=12
BEGIN

  INSERT INTO MS_TMP
  SELECT IDN, @i, MAX(CONVERT(float,Limit)), NULL, NULL
  FROM KRM023_200412
  WHERE (@NOW - Mon_Since)<= @i AND
        (@NOW - Mon_Since) > 0 
  GROUP BY IDN  
 
SET @i = @i + 3
END

UPDATE MS_200412
SET
MS025_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=3

UPDATE MS_200412
SET
MS025_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=6

UPDATE MS_200412
SET
MS025_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=9

UPDATE MS_200412
SET
MS025_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=12
GO


/*----MS026----*/
/*---Init temp table----*/
DECLARE @NOW INT
DECLARE @i INT
SET @NOW = 93 * 12 + 12
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
SET @i = 3
/*---Start making MS026---*/
WHILE @i<=12
BEGIN

  INSERT INTO MS_TMP
  SELECT IDN, @i, MIN(CONVERT(float,Limit)), NULL, NULL
  FROM KRM023_200412
  WHERE (@NOW - Mon_Since)<= @i  AND
        (@NOW - Mon_Since) > 0 AND
        CONVERT(float, Limit) > 0
  GROUP BY IDN  
 
SET @i = @i + 3
END
UPDATE MS_200412
SET
MS026_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=3

UPDATE MS_200412
SET
MS026_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=6

UPDATE MS_200412
SET
MS026_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=9

UPDATE MS_200412
SET
MS026_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = MS_200412.IDN AND Mon=12
GO

