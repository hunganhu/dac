use TF_KHJ
GO

DROP TABLE RS1xx_200409, RS_TMP
GO

CREATE TABLE RS1xx_200409
(IDN Char(6),
 RS101 Int,
 RS102 Int)
go

INSERT INTO RS1xx_200409
SELECT DISTINCT IDN, 0, 0
FROM KRM023_200409
go

CREATE TABLE RS_TMP
(IDN Char(6),
 V1 Int,
 V2 Int)
go


/*----RS101----*/
/*---Init---*/
DECLARE @NOW INT
SET @NOW = 93 * 12 + 9
DELETE FROM RS_TMP
/*---Start making RS101---*/
INSERT INTO RS_TMP
SELECT IDN, MIN(@NOW - MON_SINCE), 0
FROM dbo.KRM023_200409 AS A
WHERE Pay_Code IN ('C', 'D') AND
      (@NOW - MON_SINCE) > 0
GROUP BY A.IDN

UPDATE RS1xx_200409
SET
RS101 = V1
FROM RS_TMP AS A
WHERE RS1xx_200409.IDN = A.IDN
GO


/*----RS102----*/
/*---Init---*/
DECLARE @NOW INT
SET @NOW = 93 * 12 + 9
DELETE FROM RS_TMP
/*---Start making RS102---*/
INSERT INTO RS_TMP
SELECT IDN, MIN(@NOW - MON_SINCE), 0
FROM dbo.KRM023_200409 AS A
WHERE Pay_Code IN ('C', 'D', 'E', 'F') AND
      (@NOW - MON_SINCE) > 0
GROUP BY A.IDN

UPDATE RS1xx_200409
SET
RS102 = V1
FROM RS_TMP AS A
WHERE RS1xx_200409.IDN = A.IDN
GO