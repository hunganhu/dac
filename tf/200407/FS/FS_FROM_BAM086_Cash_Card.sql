USE TF_KHJ
GO

DROP TABLE FS3xx_200407
GO

Create table FS3xx_200407
(IDN Char(6), 
 FS301 int, FS302 int, FS303 int, FS304 int, FS305 int, FS306 int, 
 FS307_3M int, FS307_6M int, FS307_9M int, FS307_12M int, FS308 int,
 FS309 int, FS310 int, FS311 int, FS312 int, FS313 int, FS314 int)
GO

INSERT INTO FS3xx_200407(IDN)
SELECT DISTINCT IDN
FROM BAM085_200407
GO

UPDATE FS3xx_200407
SET
FS301 = 0,
FS302 = 0,
FS303 = 0,
FS304 = NULL,
FS305 = NULL,
FS306 = NULL,
FS307_3M = 0,
FS307_6M = 0,
FS307_9M = 0,
FS307_12M = 0,
FS308 = 0,
FS309 = 0,
FS310 = 0,
FS311 = 0,
FS312 = 0,
FS313 = 0,
FS314 = 0
GO
DROP TABLE FS_TMP
GO
CREATE TABLE FS_TMP
(IDN Char(6),
 MON Int,
 V1 float,
 V2 float,
 V3 float)
GO

DROP TABLE FS_TMP1
GO
CREATE TABLE FS_TMP1
(IDN Char(6),
 MON Int,
 V1 float)
GO



/*----FS301----*/
/*現金卡筆數*/
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

INSERT INTO FS_TMP
SELECT IDN, NULL, COUNT(*), NULL, NULL
FROM BAM085_200407
WHERE ACCOUNT_CODE = 'Y'
GROUP BY IDN  
 
UPDATE FS3xx_200407
SET
FS301 = V1
FROM FS_TMP AS A
WHERE A.IDN = FS3xx_200407.IDN
GO

/*----FS302----*/
/*當月逾期現金卡筆數*/
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

INSERT INTO FS_TMP
SELECT IDN, NULL, COUNT(*), NULL, NULL
FROM BAM085_200407
WHERE ACCOUNT_CODE = 'Y' AND
      isnull(pc_12,0) > 0
GROUP BY IDN  
 
UPDATE FS3xx_200407
SET
FS302 = V1
FROM FS_TMP AS A
WHERE A.IDN = FS3xx_200407.IDN
GO

/*----FS303----*/
/*曾經逾期現金卡筆數*/
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

INSERT INTO FS_TMP
SELECT IDN, NULL, COUNT(*), NULL, NULL
FROM BAM085_200407
WHERE ACCOUNT_CODE = 'Y' AND
      (isnull(pc_12,0) + isnull(pc_11,0) + isnull(pc_10,0) + isnull(pc_09,0) + 
       isnull(pc_08,0) + isnull(pc_07,0) + isnull(pc_06,0) + isnull(pc_05,0) + 
       isnull(pc_04,0) + isnull(pc_03,0) + isnull(pc_02,0) + isnull(pc_01,0)) > 0
GROUP BY IDN  
 
UPDATE FS3xx_200407
SET
FS303 = V1
FROM FS_TMP AS A
WHERE A.IDN = FS3xx_200407.IDN
GO

/*----FS304----*/
/*曾經最高逾期月數*/
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

INSERT INTO FS_TMP
SELECT IDN, NULL, MAX(Max_Bucket), NULL, NULL
FROM Y_BAM085_200407
GROUP BY IDN  
 
UPDATE FS3xx_200407
SET
FS304 = V1
FROM FS_TMP AS A
WHERE A.IDN = FS3xx_200407.IDN
GO

/*----FS305----*/
/*最久持卡月數*/
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

INSERT INTO FS_TMP
SELECT IDN, NULL, MAX(Cycles), NULL, NULL
FROM BAM085_200407
WHERE ACCOUNT_CODE = 'Y'
GROUP BY IDN  
 
UPDATE FS3xx_200407
SET
FS305 = V1
FROM FS_TMP AS A
WHERE A.IDN = FS3xx_200407.IDN
GO

/*----FS306----*/
/*最近開卡月數*/
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

INSERT INTO FS_TMP
SELECT IDN, NULL, MIN(Cycles), NULL, NULL
FROM BAM085_200407
WHERE ACCOUNT_CODE = 'Y'
GROUP BY IDN   
 
UPDATE FS3xx_200407
SET
FS306 = V1
FROM FS_TMP AS A
WHERE A.IDN = FS3xx_200407.IDN
GO

/*----FS307----*/
/*M個月內開卡數*/
DELETE FROM FS_TMP
DELETE FROM FS_TMP1
DECLARE @I INT
SET @I = 3

WHILE @I <= 12
BEGIN
INSERT INTO FS_TMP
SELECT IDN, @I, COUNT(*), NULL, NULL
FROM BAM085_200407
WHERE ACCOUNT_CODE = 'Y' AND
      CYCLES <= @I
GROUP BY IDN
SET @I = @I + 3
END   
 
UPDATE FS3xx_200407
SET
FS307_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = FS3xx_200407.IDN AND
      MON = 3
GO

UPDATE FS3xx_200407
SET
FS307_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = FS3xx_200407.IDN AND
      MON = 6
GO

UPDATE FS3xx_200407
SET
FS307_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = FS3xx_200407.IDN AND
      MON = 9
GO

UPDATE FS3xx_200407
SET
FS307_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = FS3xx_200407.IDN AND
      MON = 12
GO

/*----FS308----*/
/*萬泰現金卡筆數*/
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

INSERT INTO FS_TMP
SELECT IDN, NULL, COUNT(*), NULL, NULL
FROM BAM085_200407
WHERE ACCOUNT_CODE = 'Y' AND
      BANK_CODE2 = '809'
GROUP BY IDN  
 
UPDATE FS3xx_200407
SET
FS308 = V1
FROM FS_TMP AS A
WHERE A.IDN = FS3xx_200407.IDN
GO

/*----FS309----*/
/*動用筆數*/
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

INSERT INTO FS_TMP
SELECT IDN, NULL, COUNT(*), NULL, NULL
FROM BAM085_200407
WHERE ACCOUNT_CODE = 'Y' AND
      (CONVERT(INT,ISNULL(LOAN_AMT,0)) + CONVERT(INT,ISNULL(PASS_DUE_AMT,0))) > 0
GROUP BY IDN  
 
UPDATE FS3xx_200407
SET
FS309 = V1
FROM FS_TMP AS A
WHERE A.IDN = FS3xx_200407.IDN
GO

/*----FS310----*/
/*動用比例超過98%筆數*/
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

INSERT INTO FS_TMP
SELECT IDN, NULL, COUNT(*), NULL, NULL
FROM BAM085_200407
WHERE ACCOUNT_CODE = 'Y' AND
      ((CONVERT(FLOAT,ISNULL(LOAN_AMT,0)) + CONVERT(FLOAT,ISNULL(PASS_DUE_AMT,0))) / 
       (CASE WHEN ISNULL(CONTRACT_AMT,0) = 0 THEN NULL ELSE CONVERT(FLOAT, CONTRACT_AMT) END)) >= 0.98
GROUP BY IDN  
 
UPDATE FS3xx_200407
SET
FS310 = V1
FROM FS_TMP AS A
WHERE A.IDN = FS3xx_200407.IDN
GO

/*----FS311----*/
/*發卡銀行有報告額度筆數*/
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

INSERT INTO FS_TMP
SELECT IDN, NULL, COUNT(*), NULL, NULL
FROM BAM085_200407
WHERE ACCOUNT_CODE = 'Y' AND
      ISNULL(CONTRACT_AMT,0) > 0
GROUP BY IDN  
 
UPDATE FS3xx_200407
SET
FS311 = V1
FROM FS_TMP AS A
WHERE A.IDN = FS3xx_200407.IDN
GO

/*----FS312----*/
/*有動用，且發卡銀行有報告額度筆數*/
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

INSERT INTO FS_TMP
SELECT IDN, NULL, COUNT(*), NULL, NULL
FROM BAM085_200407
WHERE ACCOUNT_CODE = 'Y' AND
      ISNULL(CONTRACT_AMT,0) > 0 AND
      (CONVERT(INT,ISNULL(LOAN_AMT,0)) + CONVERT(INT,ISNULL(PASS_DUE_AMT,0))) > 0
GROUP BY IDN  
 
UPDATE FS3xx_200407
SET
FS312 = V1
FROM FS_TMP AS A
WHERE A.IDN = FS3xx_200407.IDN
GO

/*----FS313----*/
/*動用比例超過96%筆數*/
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

INSERT INTO FS_TMP
SELECT IDN, NULL, COUNT(*), NULL, NULL
FROM BAM085_200407
WHERE ACCOUNT_CODE = 'Y' AND
      ((CONVERT(FLOAT,ISNULL(LOAN_AMT,0)) + CONVERT(FLOAT,ISNULL(PASS_DUE_AMT,0))) / 
       (CASE WHEN ISNULL(CONTRACT_AMT,0) = 0 THEN NULL ELSE CONVERT(FLOAT, CONTRACT_AMT) END)) >= 0.96
GROUP BY IDN  
 
UPDATE FS3xx_200407
SET
FS313 = V1
FROM FS_TMP AS A
WHERE A.IDN = FS3xx_200407.IDN
GO

/*----FS314----*/
/*動用比例超過100%筆數*/
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

INSERT INTO FS_TMP
SELECT IDN, NULL, COUNT(*), NULL, NULL
FROM BAM085_200407
WHERE ACCOUNT_CODE = 'Y' AND
      ((CONVERT(FLOAT,ISNULL(LOAN_AMT,0)) + CONVERT(FLOAT,ISNULL(PASS_DUE_AMT,0))) / 
       (CASE WHEN ISNULL(CONTRACT_AMT,0) = 0 THEN NULL ELSE CONVERT(FLOAT, CONTRACT_AMT) END)) >= 1.00
GROUP BY IDN  
 
UPDATE FS3xx_200407
SET
FS314 = V1
FROM FS_TMP AS A
WHERE A.IDN = FS3xx_200407.IDN
GO
