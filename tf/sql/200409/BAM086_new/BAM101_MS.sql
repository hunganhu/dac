USE TF_KHJ
GO
DROP TABLE BAM101_MS_200409
GO

CREATE TABLE BAM101_MS_200409 
(IDN Char(6),
 MS405_3M FLOAT, MS405_6M FLOAT, MS405_9M FLOAT, MS405_12M FLOAT,
 MS406_3M FLOAT, MS406_6M FLOAT, MS406_9M FLOAT, MS406_12M FLOAT,
 MS407_3M FLOAT, MS407_6M FLOAT, MS407_9M FLOAT, MS407_12M FLOAT,
 MS408_3M FLOAT, MS408_6M FLOAT, MS408_9M FLOAT, MS408_12M FLOAT,
 MS409_3M FLOAT, MS409_6M FLOAT, MS409_9M FLOAT, MS409_12M FLOAT,
 MS410_3M FLOAT, MS410_6M FLOAT, MS410_9M FLOAT, MS410_12M FLOAT,
 MS411_3M FLOAT, MS411_6M FLOAT, MS411_9M FLOAT, MS411_12M FLOAT,
 MS412_3M FLOAT, MS412_6M FLOAT, MS412_9M FLOAT, MS412_12M FLOAT,
 MS413_3M FLOAT, MS413_6M FLOAT, MS413_9M FLOAT, MS413_12M FLOAT,
 MS414_3M FLOAT, MS414_6M FLOAT, MS414_9M FLOAT, MS414_12M FLOAT,
 MS415_3M FLOAT, MS415_6M FLOAT, MS415_9M FLOAT, MS415_12M FLOAT,
 MS416_3M FLOAT, MS416_6M FLOAT, MS416_9M FLOAT, MS416_12M FLOAT,
 MS417_3M FLOAT, MS417_6M FLOAT, MS417_9M FLOAT, MS417_12M FLOAT,
 MS418_3M FLOAT, MS418_6M FLOAT, MS418_9M FLOAT, MS418_12M FLOAT,
 MS419_3M FLOAT, MS419_6M FLOAT, MS419_9M FLOAT, MS419_12M FLOAT,
 MS420_3M FLOAT, MS420_6M FLOAT, MS420_9M FLOAT, MS420_12M FLOAT,
 MS421_3M FLOAT, MS421_6M FLOAT, MS421_9M FLOAT, MS421_12M FLOAT,
 MS422_3M FLOAT, MS422_6M FLOAT, MS422_9M FLOAT, MS422_12M FLOAT,
 MS423_3M FLOAT, MS423_6M FLOAT, MS423_9M FLOAT, MS423_12M FLOAT,
 MS424_3M FLOAT, MS424_6M FLOAT, MS424_9M FLOAT, MS424_12M FLOAT,
 MS425_3M FLOAT, MS425_6M FLOAT, MS425_9M FLOAT, MS425_12M FLOAT,
 MS426_3M FLOAT, MS426_6M FLOAT, MS426_9M FLOAT, MS426_12M FLOAT)
GO

INSERT INTO BAM101_MS_200409(IDN)
SELECT DISTINCT IDN
FROM BAM101_200409
GO

UPDATE BAM101_MS_200409
SET
MS405_3M=0,	MS405_6M=0,	MS405_9M=0,	MS405_12M=0,
MS406_3M=0,	MS406_6M=0,	MS406_9M=0,	MS406_12M=0,
MS407_3M=0,	MS407_6M=0,	MS407_9M=0,	MS407_12M=0,
MS408_3M=0,	MS408_6M=0,	MS408_9M=0,	MS408_12M=0,
MS409_3M=0,	MS409_6M=0,	MS409_9M=0,	MS409_12M=0,
MS410_3M=0,	MS410_6M=0,	MS410_9M=0,	MS410_12M=0,
MS411_3M=0,	MS411_6M=0,	MS411_9M=0,	MS411_12M=0,
MS412_3M=0,	MS412_6M=0,	MS412_9M=0,	MS412_12M=0,
MS413_3M=0,	MS413_6M=0,	MS413_9M=0,	MS413_12M=0,
MS414_3M=0,	MS414_6M=0,	MS414_9M=0,	MS414_12M=0,
MS415_3M=0,	MS415_6M=0,	MS415_9M=0,	MS415_12M=0,
MS416_3M=0,	MS416_6M=0,	MS416_9M=0,	MS416_12M=0,
MS417_3M=0,	MS417_6M=0,	MS417_9M=0,	MS417_12M=0,
MS418_3M=0,	MS418_6M=0,	MS418_9M=0,	MS418_12M=0,
MS419_3M=0,	MS419_6M=0,	MS419_9M=0,	MS419_12M=0,
MS420_3M=0,	MS420_6M=0,	MS420_9M=0,	MS420_12M=0,
MS421_3M=0,	MS421_6M=0,	MS421_9M=0,	MS421_12M=0,
MS422_3M=0,	MS422_6M=0,	MS422_9M=0,	MS422_12M=0,
MS423_3M=0,	MS423_6M=0,	MS423_9M=0,	MS423_12M=0,
MS424_3M=0,	MS424_6M=0,	MS424_9M=0,	MS424_12M=0,
MS425_3M=0,	MS425_6M=0,	MS425_9M=0,	MS425_12M=0,
MS426_3M=0,	MS426_6M=0,	MS426_9M=0,	MS426_12M=0
GO


DROP TABLE MS_TMP
GO
DROP TABLE MS_TMP1
GO
DROP TABLE MS_TMP2

CREATE TABLE MS_TMP
(IDN Char(6),
 Mon INT,
 V1 float,
 V2 float,
 V3 float)
GO

CREATE TABLE MS_TMP1
(IDN Char(6),
 Mon INT,
 V1 float)
GO

CREATE TABLE MS_TMP2
(IDN Char(6),
 Issuer char(3),
 Mon int,
 Line int)
GO

----MS405----
--短期放款最高金額 (千元)
DELETE FROM MS_TMP1

DECLARE @NOW INT
DECLARE @i INT

SET @NOW = 93 * 12 + 8
SET @i = 3

WHILE @i <= 12
BEGIN
	INSERT INTO MS_TMP1(IDN, MON, V1)
	SELECT IDN, @i, MAX(WECDJ_AMT)
	FROM BAM101_200409
	WHERE @NOW - MON_SINCE <= @i AND
	      @NOW - MON_SINCE > 0
	GROUP BY IDN
SET @i = @i + 3
END

UPDATE BAM101_MS_200409
SET
MS405_3M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 3
   
UPDATE BAM101_MS_200409
SET
MS405_6M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 6

UPDATE BAM101_MS_200409
SET
MS405_9M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 9

UPDATE BAM101_MS_200409
SET
MS405_12M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 12   
GO

----MS406----
--中期放款最高金額 (千元)
DELETE FROM MS_TMP1

DECLARE @NOW INT
DECLARE @i INT

SET @NOW = 93 * 12 + 8
SET @i = 3

WHILE @i <= 12
BEGIN
	INSERT INTO MS_TMP1(IDN, MON, V1)
	SELECT IDN, @i, MAX(HIGZ_AMT)
	FROM BAM101_200409
	WHERE @NOW - MON_SINCE <= @i AND
	      @NOW - MON_SINCE > 0
	GROUP BY IDN
SET @i = @i + 3
END

UPDATE BAM101_MS_200409
SET
MS406_3M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 3
   
UPDATE BAM101_MS_200409
SET
MS406_6M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 6

UPDATE BAM101_MS_200409
SET
MS406_9M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 9

UPDATE BAM101_MS_200409
SET
MS406_12M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 12   
GO

----MS407----
--擔保放款最高金額 (千元)
DELETE FROM MS_TMP1

DECLARE @NOW INT
DECLARE @i INT

SET @NOW = 93 * 12 + 8
SET @i = 3

WHILE @i <= 12
BEGIN
	INSERT INTO MS_TMP1(IDN, MON, V1)
	SELECT IDN, @i, MAX(MNSTRK_AMT)
	FROM BAM101_200409
	WHERE @NOW - MON_SINCE <= @i AND
	      @NOW - MON_SINCE > 0
	GROUP BY IDN
SET @i = @i + 3
END

UPDATE BAM101_MS_200409
SET
MS407_3M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 3
   
UPDATE BAM101_MS_200409
SET
MS407_6M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 6

UPDATE BAM101_MS_200409
SET
MS407_9M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 9

UPDATE BAM101_MS_200409
SET
MS407_12M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 12   
GO

----MS408----
--遠期信用狀最高金額 (千元)
DELETE FROM MS_TMP1

DECLARE @NOW INT
DECLARE @i INT

SET @NOW = 93 * 12 + 8
SET @i = 3

WHILE @i <= 12
BEGIN
	INSERT INTO MS_TMP1(IDN, MON, V1)
	SELECT IDN, @i, MAX(U_AMT)
	FROM BAM101_200409
	WHERE @NOW - MON_SINCE <= @i AND
	      @NOW - MON_SINCE > 0
	GROUP BY IDN
SET @i = @i + 3
END

UPDATE BAM101_MS_200409
SET
MS408_3M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 3
   
UPDATE BAM101_MS_200409
SET
MS408_6M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 6

UPDATE BAM101_MS_200409
SET
MS408_9M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 9

UPDATE BAM101_MS_200409
SET
MS408_12M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 12   
GO

----MS409----
--押匯承兌最高金額 (千元)
DELETE FROM MS_TMP1

DECLARE @NOW INT
DECLARE @i INT

SET @NOW = 93 * 12 + 8
SET @i = 3

WHILE @i <= 12
BEGIN
	INSERT INTO MS_TMP1(IDN, MON, V1)
	SELECT IDN, @i, MAX(PQX_AMT)
	FROM BAM101_200409
	WHERE @NOW - MON_SINCE <= @i AND
	      @NOW - MON_SINCE > 0
	GROUP BY IDN
SET @i = @i + 3
END

UPDATE BAM101_MS_200409
SET
MS409_3M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 3
   
UPDATE BAM101_MS_200409
SET
MS409_6M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 6

UPDATE BAM101_MS_200409
SET
MS409_9M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 9

UPDATE BAM101_MS_200409
SET
MS409_12M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 12  
GO

----MS410----
--本票保證最高金額 (千元)
DELETE FROM MS_TMP1

DECLARE @NOW INT
DECLARE @i INT

SET @NOW = 93 * 12 + 8
SET @i = 3

WHILE @i <= 12
BEGIN
	INSERT INTO MS_TMP1(IDN, MON, V1)
	SELECT IDN, @i, MAX(F_AMT)
	FROM BAM101_200409
	WHERE @NOW - MON_SINCE <= @i AND
	      @NOW - MON_SINCE > 0
	GROUP BY IDN
SET @i = @i + 3
END

UPDATE BAM101_MS_200409
SET
MS410_3M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 3
   
UPDATE BAM101_MS_200409
SET
MS410_6M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 6

UPDATE BAM101_MS_200409
SET
MS410_9M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 9

UPDATE BAM101_MS_200409
SET
MS410_12M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 12  
GO

----MS411----
--保證款項最高金額 (千元)
DELETE FROM MS_TMP1

DECLARE @NOW INT
DECLARE @i INT

SET @NOW = 93 * 12 + 8
SET @i = 3

WHILE @i <= 12
BEGIN
	INSERT INTO MS_TMP1(IDN, MON, V1)
	SELECT IDN, @i, MAX(L_AMT)
	FROM BAM101_200409
	WHERE @NOW - MON_SINCE <= @i AND
	      @NOW - MON_SINCE > 0
	GROUP BY IDN
SET @i = @i + 3
END

UPDATE BAM101_MS_200409
SET
MS411_3M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 3
   
UPDATE BAM101_MS_200409
SET
MS411_6M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 6

UPDATE BAM101_MS_200409
SET
MS411_9M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 9

UPDATE BAM101_MS_200409
SET
MS411_12M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 12  
GO

----MS412----
--不含逾催呆最高總餘額 (千元)
DELETE FROM MS_TMP1

DECLARE @NOW INT
DECLARE @i INT

SET @NOW = 93 * 12 + 8
SET @i = 3

WHILE @i <= 12
BEGIN
	INSERT INTO MS_TMP1(IDN, MON, V1)
	SELECT IDN, @i, MAX(NORMAL_LOAN_AMT)
	FROM BAM101_200409
	WHERE @NOW - MON_SINCE <= @i AND
	      @NOW - MON_SINCE > 0
	GROUP BY IDN
SET @i = @i + 3
END

UPDATE BAM101_MS_200409
SET
MS412_3M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 3
   
UPDATE BAM101_MS_200409
SET
MS412_6M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 6

UPDATE BAM101_MS_200409
SET
MS412_9M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 9

UPDATE BAM101_MS_200409
SET
MS412_12M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 12  
GO

----MS413----
--逾期最高金額 (千元)
DELETE FROM MS_TMP1

DECLARE @NOW INT
DECLARE @i INT

SET @NOW = 93 * 12 + 8
SET @i = 3

WHILE @i <= 12
BEGIN
	INSERT INTO MS_TMP1(IDN, MON, V1)
	SELECT IDN, @i, MAX(PASS_DUE_AMT)
	FROM BAM101_200409
	WHERE @NOW - MON_SINCE <= @i AND
	      @NOW - MON_SINCE > 0
	GROUP BY IDN
SET @i = @i + 3
END

UPDATE BAM101_MS_200409
SET
MS413_3M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 3
   
UPDATE BAM101_MS_200409
SET
MS413_6M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 6

UPDATE BAM101_MS_200409
SET
MS413_9M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 9

UPDATE BAM101_MS_200409
SET
MS413_12M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 12  
GO

----MS414----
--催收最高金額 (千元)
DELETE FROM MS_TMP1

DECLARE @NOW INT
DECLARE @i INT

SET @NOW = 93 * 12 + 8
SET @i = 3

WHILE @i <= 12
BEGIN
	INSERT INTO MS_TMP1(IDN, MON, V1)
	SELECT IDN, @i, MAX(COLLECTION_AMT)
	FROM BAM101_200409
	WHERE @NOW - MON_SINCE <= @i AND
	      @NOW - MON_SINCE > 0
	GROUP BY IDN
SET @i = @i + 3
END

UPDATE BAM101_MS_200409
SET
MS414_3M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 3
   
UPDATE BAM101_MS_200409
SET
MS414_6M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 6

UPDATE BAM101_MS_200409
SET
MS414_9M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 9

UPDATE BAM101_MS_200409
SET
MS414_12M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 12  
GO

----MS415----
--呆帳最高金額 (千元)
DELETE FROM MS_TMP1

DECLARE @NOW INT
DECLARE @i INT

SET @NOW = 93 * 12 + 8
SET @i = 3

WHILE @i <= 12
BEGIN
	INSERT INTO MS_TMP1(IDN, MON, V1)
	SELECT IDN, @i, MAX(BAD_DEBT)
	FROM BAM101_200409
	WHERE @NOW - MON_SINCE <= @i AND
	      @NOW - MON_SINCE > 0
	GROUP BY IDN
SET @i = @i + 3
END

UPDATE BAM101_MS_200409
SET
MS415_3M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 3
   
UPDATE BAM101_MS_200409
SET
MS415_6M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 6

UPDATE BAM101_MS_200409
SET
MS415_9M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 9

UPDATE BAM101_MS_200409
SET
MS415_12M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 12  
GO

----MS416----
--短期放款平均金額 (千元)
DELETE FROM MS_TMP1

DECLARE @NOW INT
DECLARE @i INT

SET @NOW = 93 * 12 + 8
SET @i = 3

WHILE @i <= 12
BEGIN
	INSERT INTO MS_TMP1(IDN, MON, V1)
	SELECT IDN, @i, AVG(CASE WHEN WECDJ_AMT = 0 THEN NULL ELSE CAST(WECDJ_AMT AS FLOAT) END)
	FROM BAM101_200409
	WHERE @NOW - MON_SINCE <= @i AND
	      @NOW - MON_SINCE > 0
	GROUP BY IDN
SET @i = @i + 3
END

UPDATE BAM101_MS_200409
SET
MS416_3M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 3
   
UPDATE BAM101_MS_200409
SET
MS416_6M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 6

UPDATE BAM101_MS_200409
SET
MS416_9M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 9

UPDATE BAM101_MS_200409
SET
MS416_12M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 12   
GO

----MS417----
--中期放款平均金額 (千元)
DELETE FROM MS_TMP1

DECLARE @NOW INT
DECLARE @i INT

SET @NOW = 93 * 12 + 8
SET @i = 3

WHILE @i <= 12
BEGIN
	INSERT INTO MS_TMP1(IDN, MON, V1)
	SELECT IDN, @i, AVG(CASE WHEN HIGZ_AMT = 0 THEN NULL ELSE CAST(HIGZ_AMT AS FLOAT) END)
	FROM BAM101_200409
	WHERE @NOW - MON_SINCE <= @i AND
	      @NOW - MON_SINCE > 0
	GROUP BY IDN
SET @i = @i + 3
END

UPDATE BAM101_MS_200409
SET
MS417_3M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 3
   
UPDATE BAM101_MS_200409
SET
MS417_6M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 6

UPDATE BAM101_MS_200409
SET
MS417_9M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 9

UPDATE BAM101_MS_200409
SET
MS417_12M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 12   
GO

----MS418----
--擔保放款平均金額 (千元)
DELETE FROM MS_TMP1

DECLARE @NOW INT
DECLARE @i INT

SET @NOW = 93 * 12 + 8
SET @i = 3

WHILE @i <= 12
BEGIN
	INSERT INTO MS_TMP1(IDN, MON, V1)
	SELECT IDN, @i, AVG(CASE WHEN MNSTRK_AMT = 0 THEN NULL ELSE CAST(MNSTRK_AMT AS FLOAT) END)
	FROM BAM101_200409
	WHERE @NOW - MON_SINCE <= @i AND
	      @NOW - MON_SINCE > 0
	GROUP BY IDN
SET @i = @i + 3
END

UPDATE BAM101_MS_200409
SET
MS418_3M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 3
   
UPDATE BAM101_MS_200409
SET
MS418_6M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 6

UPDATE BAM101_MS_200409
SET
MS418_9M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 9

UPDATE BAM101_MS_200409
SET
MS418_12M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 12   
GO

----MS419----
--遠期信用狀平均金額 (千元)
DELETE FROM MS_TMP1

DECLARE @NOW INT
DECLARE @i INT

SET @NOW = 93 * 12 + 8
SET @i = 3

WHILE @i <= 12
BEGIN
	INSERT INTO MS_TMP1(IDN, MON, V1)
	SELECT IDN, @i, AVG(CASE WHEN U_AMT = 0 THEN NULL ELSE CAST(U_AMT AS FLOAT) END)
	FROM BAM101_200409
	WHERE @NOW - MON_SINCE <= @i AND
	      @NOW - MON_SINCE > 0
	GROUP BY IDN
SET @i = @i + 3
END

UPDATE BAM101_MS_200409
SET
MS419_3M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 3
   
UPDATE BAM101_MS_200409
SET
MS419_6M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 6

UPDATE BAM101_MS_200409
SET
MS419_9M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 9

UPDATE BAM101_MS_200409
SET
MS419_12M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 12   
GO

----MS420----
--押匯承兌平均金額 (千元)
DELETE FROM MS_TMP1

DECLARE @NOW INT
DECLARE @i INT

SET @NOW = 93 * 12 + 8
SET @i = 3

WHILE @i <= 12
BEGIN
	INSERT INTO MS_TMP1(IDN, MON, V1)
	SELECT IDN, @i, AVG(CASE WHEN PQX_AMT = 0 THEN NULL ELSE CAST(PQX_AMT AS FLOAT) END)
	FROM BAM101_200409
	WHERE @NOW - MON_SINCE <= @i AND
	      @NOW - MON_SINCE > 0
	GROUP BY IDN
SET @i = @i + 3
END

UPDATE BAM101_MS_200409
SET
MS420_3M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 3
   
UPDATE BAM101_MS_200409
SET
MS420_6M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 6

UPDATE BAM101_MS_200409
SET
MS420_9M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 9

UPDATE BAM101_MS_200409
SET
MS420_12M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 12  
GO

----MS421----
--本票保證平均金額 (千元)
DELETE FROM MS_TMP1

DECLARE @NOW INT
DECLARE @i INT

SET @NOW = 93 * 12 + 8
SET @i = 3

WHILE @i <= 12
BEGIN
	INSERT INTO MS_TMP1(IDN, MON, V1)
	SELECT IDN, @i, AVG(CASE WHEN F_AMT = 0 THEN NULL ELSE CAST(F_AMT AS FLOAT) END)
	FROM BAM101_200409
	WHERE @NOW - MON_SINCE <= @i AND
	      @NOW - MON_SINCE > 0
	GROUP BY IDN
SET @i = @i + 3
END

UPDATE BAM101_MS_200409
SET
MS421_3M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 3
   
UPDATE BAM101_MS_200409
SET
MS421_6M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 6

UPDATE BAM101_MS_200409
SET
MS421_9M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 9

UPDATE BAM101_MS_200409
SET
MS421_12M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 12  
GO

----MS422----
--保證款項平均金額 (千元)
DELETE FROM MS_TMP1

DECLARE @NOW INT
DECLARE @i INT

SET @NOW = 93 * 12 + 8
SET @i = 3

WHILE @i <= 12
BEGIN
	INSERT INTO MS_TMP1(IDN, MON, V1)
	SELECT IDN, @i, AVG(CASE WHEN L_AMT = 0 THEN NULL ELSE CAST(L_AMT AS FLOAT) END)
	FROM BAM101_200409
	WHERE @NOW - MON_SINCE <= @i AND
	      @NOW - MON_SINCE > 0
	GROUP BY IDN
SET @i = @i + 3
END

UPDATE BAM101_MS_200409
SET
MS422_3M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 3
   
UPDATE BAM101_MS_200409
SET
MS422_6M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 6

UPDATE BAM101_MS_200409
SET
MS422_9M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 9

UPDATE BAM101_MS_200409
SET
MS422_12M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 12  
GO

----MS423----
--不含逾催呆平均總餘額 (千元)
DELETE FROM MS_TMP1

DECLARE @NOW INT
DECLARE @i INT

SET @NOW = 93 * 12 + 8
SET @i = 3

WHILE @i <= 12
BEGIN
	INSERT INTO MS_TMP1(IDN, MON, V1)
	SELECT IDN, @i, AVG(CASE WHEN NORMAL_LOAN_AMT = 0 THEN NULL ELSE CAST(NORMAL_LOAN_AMT AS FLOAT) END)
	FROM BAM101_200409
	WHERE @NOW - MON_SINCE <= @i AND
	      @NOW - MON_SINCE > 0
	GROUP BY IDN
SET @i = @i + 3
END

UPDATE BAM101_MS_200409
SET
MS423_3M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 3
   
UPDATE BAM101_MS_200409
SET
MS423_6M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 6

UPDATE BAM101_MS_200409
SET
MS423_9M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 9

UPDATE BAM101_MS_200409
SET
MS423_12M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 12  
GO

----MS424----
--逾期平均金額 (千元)
DELETE FROM MS_TMP1

DECLARE @NOW INT
DECLARE @i INT

SET @NOW = 93 * 12 + 8
SET @i = 3

WHILE @i <= 12
BEGIN
	INSERT INTO MS_TMP1(IDN, MON, V1)
	SELECT IDN, @i, AVG(CASE WHEN PASS_DUE_AMT = 0 THEN NULL ELSE CAST(PASS_DUE_AMT AS FLOAT) END)
	FROM BAM101_200409
	WHERE @NOW - MON_SINCE <= @i AND
	      @NOW - MON_SINCE > 0
	GROUP BY IDN
SET @i = @i + 3
END

UPDATE BAM101_MS_200409
SET
MS424_3M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 3
   
UPDATE BAM101_MS_200409
SET
MS424_6M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 6

UPDATE BAM101_MS_200409
SET
MS424_9M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 9

UPDATE BAM101_MS_200409
SET
MS424_12M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 12  
GO

----MS425----
--催收平均金額 (千元)
DELETE FROM MS_TMP1

DECLARE @NOW INT
DECLARE @i INT

SET @NOW = 93 * 12 + 8
SET @i = 3

WHILE @i <= 12
BEGIN
	INSERT INTO MS_TMP1(IDN, MON, V1)
	SELECT IDN, @i, AVG(CASE WHEN COLLECTION_AMT = 0 THEN NULL ELSE CAST(COLLECTION_AMT AS FLOAT) END)
	FROM BAM101_200409
	WHERE @NOW - MON_SINCE <= @i AND
	      @NOW - MON_SINCE > 0
	GROUP BY IDN
SET @i = @i + 3
END

UPDATE BAM101_MS_200409
SET
MS425_3M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 3
   
UPDATE BAM101_MS_200409
SET
MS425_6M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 6

UPDATE BAM101_MS_200409
SET
MS425_9M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 9

UPDATE BAM101_MS_200409
SET
MS425_12M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 12  
GO

----MS426----
--呆帳平均金額 (千元)
DELETE FROM MS_TMP1

DECLARE @NOW INT
DECLARE @i INT

SET @NOW = 93 * 12 + 8
SET @i = 3

WHILE @i <= 12
BEGIN
	INSERT INTO MS_TMP1(IDN, MON, V1)
	SELECT IDN, @i, AVG(CASE WHEN BAD_DEBT = 0 THEN NULL ELSE CAST(BAD_DEBT AS FLOAT) END)
	FROM BAM101_200409
	WHERE @NOW - MON_SINCE <= @i AND
	      @NOW - MON_SINCE > 0
	GROUP BY IDN
SET @i = @i + 3
END

UPDATE BAM101_MS_200409
SET
MS426_3M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 3
   
UPDATE BAM101_MS_200409
SET
MS426_6M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 6

UPDATE BAM101_MS_200409
SET
MS426_9M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 9

UPDATE BAM101_MS_200409
SET
MS426_12M = V1
FROM MS_TMP1 AS A INNER JOIN BAM101_MS_200409 AS B
ON A.IDN = B.IDN AND
   A.MON = 12  
GO