USE TF_KHJ
GO

DROP TABLE BAM085_MS_200404
GO

CREATE TABLE BAM085_MS_200404
(IDN CHAR(6),
 MS315_3M Float, MS315_6M Float, MS315_9M Float, MS315_12M Float, 
 MS316_3M Float, MS316_6M Float, MS316_9M Float, MS316_12M Float, 
 MS317_3M Float, MS317_6M Float, MS317_9M Float, MS317_12M Float, 
 MS318_3M Float, MS318_6M Float, MS318_9M Float, MS318_12M Float, 
 MS319_3M Float, MS319_6M Float, MS319_9M Float, MS319_12M Float, 
 MS320_3M Float, MS320_6M Float, MS320_9M Float, MS320_12M Float, 
 MS321_3M Float, MS321_6M Float, MS321_9M Float, MS321_12M Float, 
 MS322_3M Float, MS322_6M Float, MS322_9M Float, MS322_12M Float, 
 MS323_3M Float, MS323_6M Float, MS323_9M Float, MS323_12M Float, 
 MS324_3M Float, MS324_6M Float, MS324_9M Float, MS324_12M Float, 
 MS325_3M Float, MS325_6M Float, MS325_9M Float, MS325_12M Float, 
 MS326_3M Float, MS326_6M Float, MS326_9M Float, MS326_12M Float, 
 MS327_3M Float, MS327_6M Float, MS327_9M Float, MS327_12M Float, 
 MS328_3M Float, MS328_6M Float, MS328_9M Float, MS328_12M Float, 
 MS329_3M Float, MS329_6M Float, MS329_9M Float, MS329_12M Float, 
 MS330_3M Float, MS330_6M Float, MS330_9M Float, MS330_12M Float, 
 MS331_3M Float, MS331_6M Float, MS331_9M Float, MS331_12M Float, 
 MS332_3M Float, MS332_6M Float, MS332_9M Float, MS332_12M Float, 
 MS333_3M Float, MS333_6M Float, MS333_9M Float, MS333_12M Float, 
 MS334_3M Float, MS334_6M Float, MS334_9M Float, MS334_12M Float, 
 MS335_3M Float, MS335_6M Float, MS335_9M Float, MS335_12M Float, 
 MS336_3M Float, MS336_6M Float, MS336_9M Float, MS336_12M Float, 
 MS337_3M Float, MS337_6M Float, MS337_9M Float, MS337_12M Float, 
 MS338_3M Float, MS338_6M Float, MS338_9M Float, MS338_12M Float, 
 MS339_3M Float, MS339_6M Float, MS339_9M Float, MS339_12M Float, 
 MS340_3M Float, MS340_6M Float, MS340_9M Float, MS340_12M Float, 
 MS341_3M Float, MS341_6M Float, MS341_9M Float, MS341_12M Float, 
 MS342_3M Float, MS342_6M Float, MS342_9M Float, MS342_12M Float, 
 MS343_3M Float, MS343_6M Float, MS343_9M Float, MS343_12M Float, 
 MS344_3M Float, MS344_6M Float, MS344_9M Float, MS344_12M Float, 
 MS345_3M Float, MS345_6M Float, MS345_9M Float, MS345_12M Float, 
 MS346_3M Float, MS346_6M Float, MS346_9M Float, MS346_12M Float, 
 MS347_3M Float, MS347_6M Float, MS347_9M Float, MS347_12M Float, 
 MS348_3M Float, MS348_6M Float, MS348_9M Float, MS348_12M Float, 
 MS349_3M Float, MS349_6M Float, MS349_9M Float, MS349_12M Float, 
 MS350_3M Float, MS350_6M Float, MS350_9M Float, MS350_12M Float, 
 MS351_3M Float, MS351_6M Float, MS351_9M Float, MS351_12M Float, 
 MS352_3M Float, MS352_6M Float, MS352_9M Float, MS352_12M Float, 
 MS353_3M Float, MS353_6M Float, MS353_9M Float, MS353_12M Float, 
 MS354_3M Float, MS354_6M Float, MS354_9M Float, MS354_12M Float, 
 MS355_3M Float, MS355_6M Float, MS355_9M Float, MS355_12M Float, 
 MS356_3M Float, MS356_6M Float, MS356_9M Float, MS356_12M Float, 
 MS357_3M Float, MS357_6M Float, MS357_9M Float, MS357_12M Float, 
 MS358_3M Float, MS358_6M Float, MS358_9M Float, MS358_12M Float, 
 MS359_3M Float, MS359_6M Float, MS359_9M Float, MS359_12M Float,
 MS360_3M FLOAT, MS360_6M FLOAT, MS360_9M FLOAT, MS360_12M FLOAT,
 MS361_3M FLOAT, MS361_6M FLOAT, MS361_9M FLOAT, MS361_12M FLOAT,
 MS363_3M FLOAT, MS363_6M FLOAT, MS363_9M FLOAT, MS363_12M FLOAT,
 MS364_3M FLOAT, MS364_6M FLOAT, MS364_9M FLOAT, MS364_12M FLOAT,
 MS365_3M FLOAT, MS365_6M FLOAT, MS365_9M FLOAT, MS365_12M FLOAT,
 MS366_3M FLOAT, MS366_6M FLOAT, MS366_9M FLOAT, MS366_12M FLOAT,
 MS367_3M FLOAT, MS367_6M FLOAT, MS367_9M FLOAT, MS367_12M FLOAT,
 MS368_3M FLOAT, MS368_6M FLOAT, MS368_9M FLOAT, MS368_12M FLOAT,
 MS369_3M FLOAT, MS369_6M FLOAT, MS369_9M FLOAT, MS369_12M FLOAT,
 MS370_3M FLOAT, MS370_6M FLOAT, MS370_9M FLOAT, MS370_12M FLOAT,
 MS371_3M FLOAT, MS371_6M FLOAT, MS371_9M FLOAT, MS371_12M FLOAT,
 MS372_3M FLOAT, MS372_6M FLOAT, MS372_9M FLOAT, MS372_12M FLOAT,
 MS373_3M FLOAT, MS373_6M FLOAT, MS373_9M FLOAT, MS373_12M FLOAT,
 MS374_3M FLOAT, MS374_6M FLOAT, MS374_9M FLOAT, MS374_12M FLOAT,
 MS375_3M FLOAT, MS375_6M FLOAT, MS375_9M FLOAT, MS375_12M FLOAT,
 MS376_3M FLOAT, MS376_6M FLOAT, MS376_9M FLOAT, MS376_12M FLOAT,
 MS377_3M FLOAT, MS377_6M FLOAT, MS377_9M FLOAT, MS377_12M FLOAT,
 MS378_3M FLOAT, MS378_6M FLOAT, MS378_9M FLOAT, MS378_12M FLOAT,
 MS379_3M FLOAT, MS379_6M FLOAT, MS379_9M FLOAT, MS379_12M FLOAT,
 MS380_3M FLOAT, MS380_6M FLOAT, MS380_9M FLOAT, MS380_12M FLOAT,
 MS381_3M FLOAT, MS381_6M FLOAT, MS381_9M FLOAT, MS381_12M FLOAT,
 MS382_3M FLOAT, MS382_6M FLOAT, MS382_9M FLOAT, MS382_12M FLOAT,
 MS383_3M FLOAT, MS383_6M FLOAT, MS383_9M FLOAT, MS383_12M FLOAT,
 MS385_3M FLOAT, MS385_6M FLOAT, MS385_9M FLOAT, MS385_12M FLOAT,
 MS386_3M FLOAT, MS386_6M FLOAT, MS386_9M FLOAT, MS386_12M FLOAT,
 MS387_3M FLOAT, MS387_6M FLOAT, MS387_9M FLOAT, MS387_12M FLOAT,
 MS388_3M FLOAT, MS388_6M FLOAT, MS388_9M FLOAT, MS388_12M FLOAT,
 MS389_3M FLOAT, MS389_6M FLOAT, MS389_9M FLOAT, MS389_12M FLOAT,
 MS390_3M FLOAT, MS390_6M FLOAT, MS390_9M FLOAT, MS390_12M FLOAT,
 MS391_3M FLOAT, MS391_6M FLOAT, MS391_9M FLOAT, MS391_12M FLOAT,
 MS392_3M FLOAT, MS392_6M FLOAT, MS392_9M FLOAT, MS392_12M FLOAT,
 MS393_3M FLOAT, MS393_6M FLOAT, MS393_9M FLOAT, MS393_12M FLOAT,
 MS394_3M FLOAT, MS394_6M FLOAT, MS394_9M FLOAT, MS394_12M FLOAT,
 MS395_3M FLOAT, MS395_6M FLOAT, MS395_9M FLOAT, MS395_12M FLOAT,
 MS396_3M FLOAT, MS396_6M FLOAT, MS396_9M FLOAT, MS396_12M FLOAT,
 MS397_3M FLOAT, MS397_6M FLOAT, MS397_9M FLOAT, MS397_12M FLOAT,
 MS398_3M FLOAT, MS398_6M FLOAT, MS398_9M FLOAT, MS398_12M FLOAT,
 MS399_3M FLOAT, MS399_6M FLOAT, MS399_9M FLOAT, MS399_12M FLOAT,
 MS400_3M FLOAT, MS400_6M FLOAT, MS400_9M FLOAT, MS400_12M FLOAT,
 MS401_3M FLOAT, MS401_6M FLOAT, MS401_9M FLOAT, MS401_12M FLOAT,
 MS402_3M FLOAT, MS402_6M FLOAT, MS402_9M FLOAT, MS402_12M FLOAT,
 MS403_3M FLOAT, MS403_6M FLOAT, MS403_9M FLOAT, MS403_12M FLOAT,
 MS404_3M FLOAT, MS404_6M FLOAT, MS404_9M FLOAT, MS404_12M FLOAT) 
GO

INSERT INTO BAM085_MS_200404(IDN)
SELECT DISTINCT IDN
FROM BAM085_200404
GO

UPDATE BAM085_MS_200404
SET
MS315_3M=0, MS315_6M=0, MS315_9M=0, MS315_12M=0,
MS316_3M=0, MS316_6M=0, MS316_9M=0, MS316_12M=0,
MS317_3M=0, MS317_6M=0, MS317_9M=0, MS317_12M=0,
MS318_3M=0, MS318_6M=0, MS318_9M=0, MS318_12M=0,
MS319_3M=0, MS319_6M=0, MS319_9M=0, MS319_12M=0,
MS320_3M=0, MS320_6M=0, MS320_9M=0, MS320_12M=0,
MS321_3M=0, MS321_6M=0, MS321_9M=0, MS321_12M=0,
MS322_3M=0, MS322_6M=0, MS322_9M=0, MS322_12M=0,
MS323_3M=0, MS323_6M=0, MS323_9M=0, MS323_12M=0,
MS324_3M=0, MS324_6M=0, MS324_9M=0, MS324_12M=0,
MS325_3M=0, MS325_6M=0, MS325_9M=0, MS325_12M=0,
MS326_3M=0, MS326_6M=0, MS326_9M=0, MS326_12M=0,
MS327_3M=0, MS327_6M=0, MS327_9M=0, MS327_12M=0,
MS328_3M=0, MS328_6M=0, MS328_9M=0, MS328_12M=0,
MS329_3M=0, MS329_6M=0, MS329_9M=0, MS329_12M=0,
MS330_3M=0, MS330_6M=0, MS330_9M=0, MS330_12M=0,
MS331_3M=0, MS331_6M=0, MS331_9M=0, MS331_12M=0,
MS332_3M=0, MS332_6M=0, MS332_9M=0, MS332_12M=0,
MS333_3M=0, MS333_6M=0, MS333_9M=0, MS333_12M=0,
MS334_3M=0, MS334_6M=0, MS334_9M=0, MS334_12M=0,
MS335_3M=0, MS335_6M=0, MS335_9M=0, MS335_12M=0,
MS336_3M=0, MS336_6M=0, MS336_9M=0, MS336_12M=0,
MS337_3M=0, MS337_6M=0, MS337_9M=0, MS337_12M=0,
MS338_3M=0, MS338_6M=0, MS338_9M=0, MS338_12M=0,
MS339_3M=0, MS339_6M=0, MS339_9M=0, MS339_12M=0,
MS340_3M=0, MS340_6M=0, MS340_9M=0, MS340_12M=0,
MS341_3M=0, MS341_6M=0, MS341_9M=0, MS341_12M=0,
MS342_3M=0, MS342_6M=0, MS342_9M=0, MS342_12M=0,
MS343_3M=0, MS343_6M=0, MS343_9M=0, MS343_12M=0,
MS344_3M=0, MS344_6M=0, MS344_9M=0, MS344_12M=0,
MS345_3M=0, MS345_6M=0, MS345_9M=0, MS345_12M=0,
MS346_3M=0, MS346_6M=0, MS346_9M=0, MS346_12M=0,
MS347_3M=0, MS347_6M=0, MS347_9M=0, MS347_12M=0,
MS348_3M=0, MS348_6M=0, MS348_9M=0, MS348_12M=0,
MS349_3M=0, MS349_6M=0, MS349_9M=0, MS349_12M=0,
MS350_3M=0, MS350_6M=0, MS350_9M=0, MS350_12M=0,
MS351_3M=0, MS351_6M=0, MS351_9M=0, MS351_12M=0,
MS352_3M=0, MS352_6M=0, MS352_9M=0, MS352_12M=0,
MS353_3M=0, MS353_6M=0, MS353_9M=0, MS353_12M=0,
MS354_3M=0, MS354_6M=0, MS354_9M=0, MS354_12M=0,
MS355_3M=0, MS355_6M=0, MS355_9M=0, MS355_12M=0,
MS356_3M=0, MS356_6M=0, MS356_9M=0, MS356_12M=0,
MS357_3M=0, MS357_6M=0, MS357_9M=0, MS357_12M=0,
MS358_3M=0, MS358_6M=0, MS358_9M=0, MS358_12M=0,
MS359_3M=0, MS359_6M=0, MS359_9M=0, MS359_12M=0,
MS360_3M=0, MS360_6M=0, MS360_9M=0, MS360_12M=0,
MS361_3M=0, MS361_6M=0, MS361_9M=0, MS361_12M=0,
MS363_3M=0, MS363_6M=0, MS363_9M=0, MS363_12M=0,
MS364_3M=0, MS364_6M=0, MS364_9M=0, MS364_12M=0,
MS365_3M=0, MS365_6M=0, MS365_9M=0, MS365_12M=0,
MS366_3M=0, MS366_6M=0, MS366_9M=0, MS366_12M=0,
MS367_3M=0, MS367_6M=0, MS367_9M=0, MS367_12M=0,
MS368_3M=0, MS368_6M=0, MS368_9M=0, MS368_12M=0,
MS369_3M=0, MS369_6M=0, MS369_9M=0, MS369_12M=0,
MS370_3M=0, MS370_6M=0, MS370_9M=0, MS370_12M=0,
MS371_3M=0, MS371_6M=0, MS371_9M=0, MS371_12M=0,
MS372_3M=0, MS372_6M=0, MS372_9M=0, MS372_12M=0,
MS373_3M=0, MS373_6M=0, MS373_9M=0, MS373_12M=0,
MS374_3M=0, MS374_6M=0, MS374_9M=0, MS374_12M=0,
MS375_3M=0, MS375_6M=0, MS375_9M=0, MS375_12M=0,
MS376_3M=0, MS376_6M=0, MS376_9M=0, MS376_12M=0,
MS377_3M=0, MS377_6M=0, MS377_9M=0, MS377_12M=0,
MS378_3M=0, MS378_6M=0, MS378_9M=0, MS378_12M=0,
MS379_3M=0, MS379_6M=0, MS379_9M=0, MS379_12M=0,
MS380_3M=0, MS380_6M=0, MS380_9M=0, MS380_12M=0,
MS381_3M=0, MS381_6M=0, MS381_9M=0, MS381_12M=0,
MS382_3M=0, MS382_6M=0, MS382_9M=0, MS382_12M=0,
MS383_3M=0, MS383_6M=0, MS383_9M=0, MS383_12M=0,
MS385_3M=0, MS385_6M=0, MS385_9M=0, MS385_12M=0,
MS386_3M=0, MS386_6M=0, MS386_9M=0, MS386_12M=0,
MS387_3M=0, MS387_6M=0, MS387_9M=0, MS387_12M=0,
MS388_3M=0, MS388_6M=0, MS388_9M=0, MS388_12M=0,
MS389_3M=0, MS389_6M=0, MS389_9M=0, MS389_12M=0,
MS390_3M=0, MS390_6M=0, MS390_9M=0, MS390_12M=0,
MS391_3M=0, MS391_6M=0, MS391_9M=0, MS391_12M=0,
MS392_3M=0, MS392_6M=0, MS392_9M=0, MS392_12M=0,
MS393_3M=0, MS393_6M=0, MS393_9M=0, MS393_12M=0,
MS394_3M=0, MS394_6M=0, MS394_9M=0, MS394_12M=0,
MS395_3M=0, MS395_6M=0, MS395_9M=0, MS395_12M=0,
MS396_3M=0, MS396_6M=0, MS396_9M=0, MS396_12M=0,
MS397_3M=0, MS397_6M=0, MS397_9M=0, MS397_12M=0,
MS398_3M=0, MS398_6M=0, MS398_9M=0, MS398_12M=0,
MS399_3M=0, MS399_6M=0, MS399_9M=0, MS399_12M=0,
MS400_3M=0, MS400_6M=0, MS400_9M=0, MS400_12M=0,
MS401_3M=0, MS401_6M=0, MS401_9M=0, MS401_12M=0,
MS402_3M=0, MS402_6M=0, MS402_9M=0, MS402_12M=0,
MS403_3M=0, MS403_6M=0, MS403_9M=0, MS403_12M=0,
MS404_3M=0, MS404_6M=0, MS404_9M=0, MS404_12M=0
GO

DROP TABLE MS_TMP
GO
DROP TABLE MS_TMP1
GO

CREATE TABLE MS_TMP
(IDN Char(6),
 Mon INT,
 V1 float,
 V2 float,
 V3 float)
GO

CREATE TABLE MS_TMP1
(IDN Char(6),
 Mon INT,
 V1 float)
GO

----MS315----
--繳款紀錄在X月內的授信最高餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,CONVERT(INT, LOAN_AMT)) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i AND
        CONVERT(INT, PASS_DUE_AMT) = 0
  GROUP BY IDN
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS315_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS315_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS315_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS315_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS316----
--繳款紀錄在X月內的訂約總金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, SUM(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS316_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS316_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS316_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS316_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS317----
--繳款紀錄在X月內的訂約最高金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS317_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS317_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS317_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS317_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS318----
--繳款紀錄在X月內的還清訂約最高金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE (CONVERT(INT, LOAN_AMT) = 0) AND
        (CONVERT(INT, PASS_DUE_AMT) = 0) AND
        ACCOUNT_CODE != 'Y' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS318_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS318_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS318_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS318_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS319----
--繳款紀錄在X月內的有擔保貸款訂約最高金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE (account_code2 in ('S', 'W', 'M') OR (Account_code = 'K')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS319_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS319_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS319_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS319_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS320----
--繳款紀錄在X月內的有擔保貸款訂約最高金額 - 短期
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code in ('W','C','D','E') AND
        (account_code2 in ('S', 'W', 'M') OR (account_code = 'K')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS320_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS320_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS320_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS320_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS321----
--繳款紀錄在X月內的有擔保貸款訂約最高金額 - 中期
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code in ('H','S') AND
        account_code2 in ('S', 'W', 'M') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS321_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS321_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS321_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS321_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS322----
--繳款紀錄在X月內的有擔保貸款訂約最高金額 - 長期
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code in ('I','T') AND
        account_code2 in ('S', 'W', 'M') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS322_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS322_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS322_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS322_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS323----
--繳款紀錄在X月內的無擔保貸款訂約最高金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE ((account_code2 = '') or (account_code2 is null) or (account_code = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i AND
        Account_Code != 'K'
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS323_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS323_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS323_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS323_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS324----
--繳款紀錄在X月內的無擔保貸款訂約最高金額 - 短期
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code in ('W','C', 'D', 'E') AND
        ((account_code2 = '') or (account_code2 is null) or (account_code = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS324_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS324_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS324_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS324_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS325----
--繳款紀錄在X月內的無擔保貸款訂約最高金額 - 中期

DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code in ('H', 'S') AND
        ((account_code2 = '') or (account_code2 is null) or (account_code = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS325_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS325_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS325_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS325_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS326----
--繳款紀錄在X月內的無擔保貸款訂約最高金額 - 長期
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code in ('I', 'T') AND
        ((account_code2 = '') or (account_code2 is null) or (account_code = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS326_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS326_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS326_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS326_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS327----
--繳款紀錄在X月內的逾期訂約最高金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE CONVERT(INT, PASS_DUE_AMT) > 0 AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS327_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS327_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS327_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS327_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS328----
--繳款紀錄在X月內的催收訂約最高金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code = 'A' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS328_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS328_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS328_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS328_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS329----
--繳款紀錄在X月內的呆帳訂約最高金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code = 'B' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS329_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS329_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS329_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS329_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS330----
--繳款紀錄在X月內的財政部優惠貸款訂約最高金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code2 in ('V','W') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS330_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS330_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS330_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS330_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS331----
--繳款紀錄在X月內的不動產貸款訂約最高金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE purpose_code = '1' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS331_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS331_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS331_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS331_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS332----
--繳款紀錄在X月內的動產貸款訂約最高金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE purpose_code = '2' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS332_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS332_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS332_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS332_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS333----
--繳款紀錄在X月內的企業投資貸款訂約最高金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE purpose_code = '3' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS333_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS333_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS333_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS333_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO


----MS334----
--繳款紀錄在X月內的週轉金貸款訂約最高金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE purpose_code = '4' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS334_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS334_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS334_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS334_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS335----
--繳款紀錄在X月內的助學貸款訂約最高金額 (無擔保)
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code='Z' AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        purpose_code = '4' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS335_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS335_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS335_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS335_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS336----
--繳款紀錄在X月內的存保單質押訂約最高金額 (無擔保)
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code='K' AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        purpose_code = '4' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS336_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS336_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS336_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS336_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS337----
--繳款紀錄在X月內的現金卡訂約最高金額 (無擔保)
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code = 'Y' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS337_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS337_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS337_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS337_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO


----MS338----
--繳款紀錄在X月內的Co-Loan 訂約最高金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE Co_Loan = 'Y' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS338_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS338_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS338_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS338_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS339----
--繳款紀錄在X月內的貸放最高餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS339_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS339_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS339_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS339_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS340----
--繳款紀錄在X月內的有擔保貸款最高餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE (account_code2 in ('S', 'W', 'M') OR (account_code = 'K')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS340_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS340_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS340_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS340_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO


----MS341----
--繳款紀錄在X月內的有擔保貸款最高餘額 - 短期
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE account_code2 in ('S', 'W', 'M') AND
        account_code in ('W','C','D','E') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS341_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS341_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS341_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS341_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS342----
--繳款紀錄在X月內的有擔保貸款最高餘額 - 中期
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE account_code2 in ('S', 'W', 'M') AND
        account_code in ('H','S') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS342_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS342_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS342_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS342_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS343----
--繳款紀錄在X月內的有擔保貸款最高餘額 - 長期
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE account_code2 in ('S', 'W', 'M') AND
        account_code in ('I','T') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS343_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS343_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS343_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS343_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS344----
--繳款紀錄在X月內的無擔保貸款最高餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i AND
        Account_Code != 'K'
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS344_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS344_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS344_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS344_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS345----
--繳款紀錄在X月內的無擔保貸款最高餘額 - 短期
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        account_code IN ('W','C', 'D', 'E') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS345_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS345_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS345_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS345_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS346----
--繳款紀錄在X月內的無擔保貸款最高餘額 - 中期
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        account_code in ('H','S') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS346_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS346_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS346_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS346_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS347----
--繳款紀錄在X月內的無擔保貸款最高餘額 - 長期
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        account_code in ('I','T') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS347_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS347_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS347_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS347_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS348----
--繳款紀錄在X月內的逾期最高餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE CONVERT(INT, PASS_DUE_AMT) > 0 AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS348_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS348_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS348_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS348_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO


----MS349----
--繳款紀錄在X月內的催收最高餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE account_code = 'A' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS349_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS349_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS349_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS349_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS350----
--繳款紀錄在X月內的呆帳最高餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE account_code = 'B' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS350_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS350_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS350_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS350_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS351----
--繳款紀錄在X月內的財政部優惠貸款最高餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE account_code2 in ('V','W') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS351_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS351_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS351_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS351_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS352----
--繳款紀錄在X月內的不動產貸款最高餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE purpose_code = '1' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS352_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS352_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS352_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS352_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS353----
--繳款紀錄在X月內的動產貸款最高餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE purpose_code = '2' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS353_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS353_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS353_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS353_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS354----
--繳款紀錄在X月內的企業投資貸款最高餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE purpose_code = '3' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS354_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS354_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS354_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS354_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS355----
--繳款紀錄在X月內的週轉金貸款最高餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE purpose_code = '4' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS355_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS355_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS355_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS355_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO


----MS356----
--繳款紀錄在X月內的助學貸款最高餘額 (無擔保)
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        (account_code = 'Z') AND
        (purpose_code ='4') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS356_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS356_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS356_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS356_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO


----MS357----
--繳款紀錄在X月內的存保單質押最高餘額 (無擔保)
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        (account_code = 'K') AND
        (purpose_code ='4') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS357_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS357_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS357_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS357_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS358----
--繳款紀錄在X月內的現金卡最高餘額 (無擔保)
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE account_code = 'Y' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS358_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS358_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS358_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS358_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS359----
--繳款紀錄在X月內的Co-Loan 最高餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE (Co_Loan = 'Y') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, MAX(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS359_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS359_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS359_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS359_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS360----
--繳款紀錄在X月內的授信平均餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,CONVERT(INT, LOAN_AMT)) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS360_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS360_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS360_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS360_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS361----
--繳款紀錄在X月內的訂約平均金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS361_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS361_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS361_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS361_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS363----
--繳款紀錄在X月內的還清訂約平均金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE (CONVERT(INT, LOAN_AMT) = 0) AND
        (CONVERT(INT, PASS_DUE_AMT) = 0) AND
        ACCOUNT_CODE != 'Y' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS363_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS363_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS363_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS363_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS364----
--繳款紀錄在X月內的有擔保貸款訂約平均金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE (account_code2 in ('S', 'W', 'M') OR (account_code = 'K')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS364_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS364_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS364_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS364_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS365----
--繳款紀錄在X月內的有擔保貸款訂約平均金額 - 短期
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code in ('W','C','D','E') AND
        account_code2 in ('S', 'W', 'M') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS365_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS365_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS365_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS365_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS366----
--繳款紀錄在X月內的有擔保貸款訂約平均金額 - 中期
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code in ('H','S') AND
        account_code2 in ('S', 'W', 'M') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS366_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS366_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS366_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS366_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS367----
--繳款紀錄在X月內的有擔保貸款訂約平均金額 - 長期
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code in ('I','T') AND
        account_code2 in ('S', 'W', 'M') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS367_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS367_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS367_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS367_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS368----
--繳款紀錄在X月內的無擔保貸款訂約平均金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i AND
        Account_Code != 'K'
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS368_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS368_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS368_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS368_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS369----
--繳款紀錄在X月內的無擔保貸款訂約平均金額 - 短期
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code in ('W','C', 'D', 'E') AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS369_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS369_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS369_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS369_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS370----
--繳款紀錄在X月內的無擔保貸款訂約平均金額 - 中期

DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code in ('H', 'S') AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS370_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS370_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS370_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS370_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS371----
--繳款紀錄在X月內的無擔保貸款訂約平均金額 - 長期
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code in ('I', 'T') AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS371_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS371_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS371_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS371_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS372----
--繳款紀錄在X月內的逾期訂約平均金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE CONVERT(INT, PASS_DUE_AMT) > 0 AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS372_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS372_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS372_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS372_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS373----
--繳款紀錄在X月內的催收訂約平均金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code = 'A' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS373_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS373_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS373_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS373_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS374----
--繳款紀錄在X月內的呆帳訂約平均金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code = 'B' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS374_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS374_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS374_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS374_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS375----
--繳款紀錄在X月內的財政部優惠貸款訂約平均金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code2 in ('V','W') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS375_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS375_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS375_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS375_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO


----MS376----
--繳款紀錄在X月內的不動產貸款訂約平均金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE purpose_code = '1' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS376_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS376_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS376_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS376_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS377----
--繳款紀錄在X月內的動產貸款訂約平均金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE purpose_code = '2' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS377_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS377_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS377_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS377_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS378----
--繳款紀錄在X月內的企業投資貸款訂約平均金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE purpose_code = '3' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS378_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS378_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS378_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS378_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO


----MS379----
--繳款紀錄在X月內的週轉金貸款訂約平均金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE purpose_code = '4' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS379_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS379_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS379_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS379_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS380----
--繳款紀錄在X月內的助學貸款訂約平均金額 (無擔保)
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code='Z' AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        purpose_code = '4' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS380_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS380_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS380_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS380_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS381----
--繳款紀錄在X月內的存保單質押訂約平均金額 (無擔保)
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code='K' AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        purpose_code = '4' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS381_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS381_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS381_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS381_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS382----
--繳款紀錄在X月內的類現金卡訂約平均金額 (無擔保)
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE account_code = 'Y' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS382_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS382_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS382_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS382_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS383----
--繳款紀錄在X月內的Co-Loan 訂約平均金額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT,Contract_Amt))
  FROM BAM085_200404
  WHERE Co_Loan = 'Y' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS383_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS383_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS383_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS383_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS385----
--繳款紀錄在X月內的有擔保貸款平均餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE (account_code2 in ('S', 'W', 'M') OR (account_code = 'K')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS385_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS385_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS385_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS385_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO


----MS386----
--繳款紀錄在X月內的有擔保貸款平均餘額 - 短期
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE account_code2 in ('S', 'W', 'M') AND
        account_code in ('W','C','D','E') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS386_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS386_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS386_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS386_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS387----
--繳款紀錄在X月內的有擔保貸款平均餘額 - 中期
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE account_code2 in ('S', 'W', 'M') AND
        account_code in ('H','S') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS387_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS387_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS387_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS387_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS388----
--繳款紀錄在X月內的有擔保貸款平均餘額 - 長期
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE account_code2 in ('S', 'W', 'M') AND
        account_code in ('I','T') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS388_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS388_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS388_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS388_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS389----
--繳款紀錄在X月內的無擔保貸款平均餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i AND
        Account_Code != 'K'
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS389_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS389_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS389_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS389_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS390----
--繳款紀錄在X月內的無擔保貸款平均餘額 - 短期
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        account_code IN ('W','C', 'D', 'E') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS390_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS390_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS390_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS390_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS391----
--繳款紀錄在X月內的無擔保貸款平均餘額 - 中期
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        account_code in ('H','S') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS391_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS391_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS391_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS391_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS392----
--繳款紀錄在X月內的無擔保貸款平均餘額 - 長期
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        account_code in ('I','T') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS392_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS392_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS392_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS392_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS393----
--繳款紀錄在X月內的逾期平均餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE CONVERT(INT, PASS_DUE_AMT) > 0 AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS393_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS393_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS393_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS393_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO


----MS394----
--繳款紀錄在X月內的催收平均餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE account_code = 'A' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS394_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS394_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS394_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS394_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS395----
--繳款紀錄在X月內的呆帳平均餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE account_code = 'B' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS395_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS395_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS395_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS395_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS396----
--繳款紀錄在X月內的財政部優惠貸款平均餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE account_code2 in ('V','W') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS396_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS396_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS396_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS396_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS397----
--繳款紀錄在X月內的不動產貸款平均餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE purpose_code = '1' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS397_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS397_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS397_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS397_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS398----
--繳款紀錄在X月內的動產貸款平均餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE purpose_code = '2' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS398_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS398_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS398_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS398_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS399----
--繳款紀錄在X月內的企業投資貸款平均餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE purpose_code = '3' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS399_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS399_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS399_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS399_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS400----
--繳款紀錄在X月內的週轉金貸款平均餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE purpose_code = '4' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS400_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS400_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS400_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS400_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO


----MS401----
--繳款紀錄在X月內的助學貸款平均餘額 (無擔保)
DELETE FROM MS_TMP
DELETE FROM MS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        (account_code = 'Z') AND
        (purpose_code ='4') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS401_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS401_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS401_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS401_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO


----MS402----
--繳款紀錄在X月內的存保單質押平均餘額 (無擔保)
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        (account_code = 'K') AND
        (purpose_code ='4') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS402_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS402_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS402_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS402_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS403----
--繳款紀錄在X月內的現金卡平均餘額 (無擔保)
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE account_code = 'Y' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS403_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS403_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS403_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS403_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

----MS404----
--繳款紀錄在X月內的Co-Loan 平均餘額
DELETE FROM MS_TMP
DELETE FROM MS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 4

SET @i = 1

WHILE @i <= 11
BEGIN
  INSERT INTO MS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(CONVERT(INT, LOAN_AMT) + CONVERT(INT, PASS_DUE_AMT))
  FROM BAM085_200404
  WHERE (Co_Loan = 'Y') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
  GROUP BY IDN  
  SET @i = @i + 1
END

SET @i = 3

WHILE @i <= 12
BEGIN
  INSERT INTO MS_TMP(IDN, MON , V1)
  SELECT IDN, @i, AVG(V1)
  FROM MS_TMP1
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END
 
UPDATE BAM085_MS_200404
SET
MS404_3M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 3

UPDATE BAM085_MS_200404
SET
MS404_6M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 6

UPDATE BAM085_MS_200404
SET
MS404_9M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 9

UPDATE BAM085_MS_200404
SET
MS404_12M = V1
FROM MS_TMP AS A
WHERE A.IDN = BAM085_MS_200404.IDN AND
      A.MON = 12
GO

