USE TF_KHJ
GO

DROP TABLE BAM085_FS_200411
GO

CREATE TABLE BAM085_FS_200411
(IDN CHAR(6),
 FS334 Float, FS315 Float, FS316 Float, FS317 Float, 
 FS318 Float, FS319 Float, FS320 Float, FS321 Float, 
 FS322 Float, FS323 Float, FS324 Float, FS325 Float, 
 FS326 Float, FS327 Float, FS328 Float, FS329 Float, 
 FS330 Float, FS331 Float, FS332 Float, FS333 Float, 
-- FS334 Float, FS335 Float, FS336 Float, FS337 Float, 
-- FS338 Float, FS339 Float, FS340 Float, FS341 Float, 
-- FS342 Float, FS343 Float, FS344 Float, FS345 Float, 
-- FS346 Float, FS347 Float, FS348 Float, FS349 Float, 
-- FS350 Float, FS351 Float, FS352 Float, FS353 Float, 
 FS354_3M Float, FS354_6M Float, FS354_9M Float, FS354_12M Float, 
 FS355_3M Float, FS355_6M Float, FS355_9M Float, FS355_12M Float, 
 FS356_3M Float, FS356_6M Float, FS356_9M Float, FS356_12M Float, 
 FS357_3M Float, FS357_6M Float, FS357_9M Float, FS357_12M Float, 
 FS358_3M Float, FS358_6M Float, FS358_9M Float, FS358_12M Float, 
 FS359_3M Float, FS359_6M Float, FS359_9M Float, FS359_12M Float, 
 FS360_3M Float, FS360_6M Float, FS360_9M Float, FS360_12M Float, 
 FS361_3M Float, FS361_6M Float, FS361_9M Float, FS361_12M Float, 
 FS362_3M Float, FS362_6M Float, FS362_9M Float, FS362_12M Float, 
 FS363_3M Float, FS363_6M Float, FS363_9M Float, FS363_12M Float, 
 FS364_3M Float, FS364_6M Float, FS364_9M Float, FS364_12M Float, 
 FS365_3M Float, FS365_6M Float, FS365_9M Float, FS365_12M Float, 
 FS366_3M Float, FS366_6M Float, FS366_9M Float, FS366_12M Float, 
 FS367_3M Float, FS367_6M Float, FS367_9M Float, FS367_12M Float, 
 FS368_3M Float, FS368_6M Float, FS368_9M Float, FS368_12M Float, 
 FS369_3M Float, FS369_6M Float, FS369_9M Float, FS369_12M Float, 
 FS370_3M Float, FS370_6M Float, FS370_9M Float, FS370_12M Float, 
 FS371_3M Float, FS371_6M Float, FS371_9M Float, FS371_12M Float, 
 FS372_3M Float, FS372_6M Float, FS372_9M Float, FS372_12M Float, 
 FS373_3M Float, FS373_6M Float, FS373_9M Float, FS373_12M Float, 
 FS374_3M Float, FS374_6M Float, FS374_9M Float, FS374_12M Float, 
 FS375_3M Float, FS375_6M Float, FS375_9M Float, FS375_12M Float, 
 FS376_3M Float, FS376_6M Float, FS376_9M Float, FS376_12M Float, 
 FS377_3M Float, FS377_6M Float, FS377_9M Float, FS377_12M Float, 
 FS378_3M Float, FS378_6M Float, FS378_9M Float, FS378_12M Float, 
 FS379_3M Float, FS379_6M Float, FS379_9M Float, FS379_12M Float, 
 FS380_3M Float, FS380_6M Float, FS380_9M Float, FS380_12M Float, 
 FS381_3M Float, FS381_6M Float, FS381_9M Float, FS381_12M Float, 
 FS382_3M Float, FS382_6M Float, FS382_9M Float, FS382_12M Float, 
 FS383_3M Float, FS383_6M Float, FS383_9M Float, FS383_12M Float, 
 FS384_3M Float, FS384_6M Float, FS384_9M Float, FS384_12M Float, 
 FS385_3M Float, FS385_6M Float, FS385_9M Float, FS385_12M Float, 
 FS386_3M Float, FS386_6M Float, FS386_9M Float, FS386_12M Float, 
 FS387_3M Float, FS387_6M Float, FS387_9M Float, FS387_12M Float, 
 FS388_3M Float, FS388_6M Float, FS388_9M Float, FS388_12M Float, 
 FS389_3M Float, FS389_6M Float, FS389_9M Float, FS389_12M Float, 
 FS390_3M Float, FS390_6M Float, FS390_9M Float, FS390_12M Float, 
 FS391_3M Float, FS391_6M Float, FS391_9M Float, FS391_12M Float, 
 FS392_3M Float, FS392_6M Float, FS392_9M Float, FS392_12M Float,
 FS393_3M Float, FS393_6M Float, FS393_9M Float, FS393_12M Float,
 FS394_3M Float, FS394_6M Float, FS394_9M Float, FS394_12M Float,
 FS395_3M Float, FS395_6M Float, FS395_9M Float, FS395_12M Float,
 FS396_3M Float, FS396_6M Float, FS396_9M Float, FS396_12M Float,
 FS397_3M Float, FS397_6M Float, FS397_9M Float, FS397_12M Float,
 FS398_3M Float, FS398_6M Float, FS398_9M Float, FS398_12M Float,
 FS399_3M Float, FS399_6M Float, FS399_9M Float, FS399_12M Float,
 FS400_3M Float, FS400_6M Float, FS400_9M Float, FS400_12M Float,
 FS401_3M Float, FS401_6M Float, FS401_9M Float, FS401_12M Float,
 FS402_3M Float, FS402_6M Float, FS402_9M Float, FS402_12M Float,
 FS403_3M Float, FS403_6M Float, FS403_9M Float, FS403_12M Float,
 FS404_3M Float, FS404_6M Float, FS404_9M Float, FS404_12M Float,
 FS405_3M Float, FS405_6M Float, FS405_9M Float, FS405_12M Float,
 FS406_3M Float, FS406_6M Float, FS406_9M Float, FS406_12M Float,
 FS407_3M Float, FS407_6M Float, FS407_9M Float, FS407_12M Float,
 FS408_3M Float, FS408_6M Float, FS408_9M Float, FS408_12M Float,
 FS409_3M Float, FS409_6M Float, FS409_9M Float, FS409_12M Float,
 FS410_3M Float, FS410_6M Float, FS410_9M Float, FS410_12M Float,
 FS411_3M Float, FS411_6M Float, FS411_9M Float, FS411_12M Float,
 FS412_3M Float, FS412_6M Float, FS412_9M Float, FS412_12M Float,
 FS413_3M Float, FS413_6M Float, FS413_9M Float, FS413_12M Float,
 FS414_3M Float, FS414_6M Float, FS414_9M Float, FS414_12M Float,
 FS415_3M Float, FS415_6M Float, FS415_9M Float, FS415_12M Float,
 FS416_3M Float, FS416_6M Float, FS416_9M Float, FS416_12M Float,
 FS417_3M Float, FS417_6M Float, FS417_9M Float, FS417_12M Float,
 FS418_3M Float, FS418_6M Float, FS418_9M Float, FS418_12M Float,
 FS419_3M Float, FS419_6M Float, FS419_9M Float, FS419_12M Float,
 FS420_3M Float, FS420_6M Float, FS420_9M Float, FS420_12M Float,
 FS421_3M Float, FS421_6M Float, FS421_9M Float, FS421_12M Float,
 FS422_3M Float, FS422_6M Float, FS422_9M Float, FS422_12M Float,
 FS423_3M Float, FS423_6M Float, FS423_9M Float, FS423_12M Float,
 FS424_3M Float, FS424_6M Float, FS424_9M Float, FS424_12M Float,
 FS425_3M Float, FS425_6M Float, FS425_9M Float, FS425_12M Float,
 FS426_3M Float, FS426_6M Float, FS426_9M Float, FS426_12M Float,
 FS427_3M Float, FS427_6M Float, FS427_9M Float, FS427_12M Float,
 FS428_3M Float, FS428_6M Float, FS428_9M Float, FS428_12M Float,
 FS429_3M Float, FS429_6M Float, FS429_9M Float, FS429_12M Float,
 FS430_3M Float, FS430_6M Float, FS430_9M Float, FS430_12M Float,
 FS431_3M Float, FS431_6M Float, FS431_9M Float, FS431_12M Float,
 FS432_3M Float, FS432_6M Float, FS432_9M Float, FS432_12M Float,
 FS433_3M Float, FS433_6M Float, FS433_9M Float, FS433_12M Float,
 FS434_3M Float, FS434_6M Float, FS434_9M Float, FS434_12M Float,
 FS435_3M Float, FS435_6M Float, FS435_9M Float, FS435_12M Float,
 FS436_3M Float, FS436_6M Float, FS436_9M Float, FS436_12M Float,
 FS437_3M Float, FS437_6M Float, FS437_9M Float, FS437_12M Float,
 FS438_3M Float, FS438_6M Float, FS438_9M Float, FS438_12M Float,
 FS439_3M Float, FS439_6M Float, FS439_9M Float, FS439_12M Float,
 FS440_3M Float, FS440_6M Float, FS440_9M Float, FS440_12M Float,
 FS441_3M Float, FS441_6M Float, FS441_9M Float, FS441_12M Float,
 FS442_3M Float, FS442_6M Float, FS442_9M Float, FS442_12M Float,
 FS443_3M Float, FS443_6M Float, FS443_9M Float, FS443_12M Float,
 FS444_3M Float, FS444_6M Float, FS444_9M Float, FS444_12M Float,
 FS445_3M Float, FS445_6M Float, FS445_9M Float, FS445_12M Float,
 FS446_3M Float, FS446_6M Float, FS446_9M Float, FS446_12M Float,
 FS447_3M Float, FS447_6M Float, FS447_9M Float, FS447_12M Float,
 FS448_3M Float, FS448_6M Float, FS448_9M Float, FS448_12M Float,
 FS449_3M Float, FS449_6M Float, FS449_9M Float, FS449_12M Float,
 FS450_3M Float, FS450_6M Float, FS450_9M Float, FS450_12M Float,
 FS451_3M Float, FS451_6M Float, FS451_9M Float, FS451_12M Float,
 FS452_3M Float, FS452_6M Float, FS452_9M Float, FS452_12M Float,
 FS453_3M Float, FS453_6M Float, FS453_9M Float, FS453_12M Float,
 FS454_3M Float, FS454_6M Float, FS454_9M Float, FS454_12M Float,
 FS455_3M Float, FS455_6M Float, FS455_9M Float, FS455_12M Float,
 FS456_3M Float, FS456_6M Float, FS456_9M Float, FS456_12M Float,
 FS457_3M Float, FS457_6M Float, FS457_9M Float, FS457_12M Float,
 FS458_3M Float, FS458_6M Float, FS458_9M Float, FS458_12M Float,
 FS459_3M Float, FS459_6M Float, FS459_9M Float, FS459_12M Float,
 FS460_3M Float, FS460_6M Float, FS460_9M Float, FS460_12M Float,
 FS461_3M Float, FS461_6M Float, FS461_9M Float, FS461_12M Float,
 FS462_3M Float, FS462_6M Float, FS462_9M Float, FS462_12M Float,
 FS463_3M Float, FS463_6M Float, FS463_9M Float, FS463_12M Float,
 FS464_3M Float, FS464_6M Float, FS464_9M Float, FS464_12M Float,
 FS465_3M Float, FS465_6M Float, FS465_9M Float, FS465_12M Float,
 FS466_3M Float, FS466_6M Float, FS466_9M Float, FS466_12M Float,
 FS467_3M Float, FS467_6M Float, FS467_9M Float, FS467_12M Float,
 FS468_3M Float, FS468_6M Float, FS468_9M Float, FS468_12M Float,
 FS469_3M Float, FS469_6M Float, FS469_9M Float, FS469_12M Float,
 FS470_3M Float, FS470_6M Float, FS470_9M Float, FS470_12M Float,
 FS471_3M Float, FS471_6M Float, FS471_9M Float, FS471_12M Float,
 FS472_3M Float, FS472_6M Float, FS472_9M Float, FS472_12M Float,
 FS473_3M Float, FS473_6M Float, FS473_9M Float, FS473_12M Float,
 FS474_3M Float, FS474_6M Float, FS474_9M Float, FS474_12M Float,
 FS475_3M Float, FS475_6M Float, FS475_9M Float, FS475_12M Float,
 FS476_3M Float, FS476_6M Float, FS476_9M Float, FS476_12M Float,
 FS477_3M Float, FS477_6M Float, FS477_9M Float, FS477_12M Float,
 FS478_3M Float, FS478_6M Float, FS478_9M Float, FS478_12M Float,
 FS479_3M Float, FS479_6M Float, FS479_9M Float, FS479_12M Float,
 FS480_3M Float, FS480_6M Float, FS480_9M Float, FS480_12M Float,
 FS481_3M Float, FS481_6M Float, FS481_9M Float, FS481_12M Float,
 FS482_3M Float, FS482_6M Float, FS482_9M Float, FS482_12M Float,
 FS483_3M Float, FS483_6M Float, FS483_9M Float, FS483_12M Float,
 FS484_3M Float, FS484_6M Float, FS484_9M Float, FS484_12M Float,
 FS485_3M Float, FS485_6M Float, FS485_9M Float, FS485_12M Float,
 FS486_3M Float, FS486_6M Float, FS486_9M Float, FS486_12M Float,
 FS487_3M Float, FS487_6M Float, FS487_9M Float, FS487_12M Float,
 FS488_3M Float, FS488_6M Float, FS488_9M Float, FS488_12M Float,
 FS489_3M Float, FS489_6M Float, FS489_9M Float, FS489_12M Float,
 FS490_3M Float, FS490_6M Float, FS490_9M Float, FS490_12M Float,
 FS491_3M Float, FS491_6M Float, FS491_9M Float, FS491_12M Float,
 FS492_3M Float, FS492_6M Float, FS492_9M Float, FS492_12M Float,
 FS493_3M Float, FS493_6M Float, FS493_9M Float, FS493_12M Float,
 FS494_3M Float, FS494_6M Float, FS494_9M Float, FS494_12M Float,
 FS495_3M Float, FS495_6M Float, FS495_9M Float, FS495_12M Float,
 FS496_3M Float, FS496_6M Float, FS496_9M Float, FS496_12M Float,
 FS497_3M Float, FS497_6M Float, FS497_9M Float, FS497_12M Float,
 FS498_3M Float, FS498_6M Float, FS498_9M Float, FS498_12M Float,
 FS499_3M Float, FS499_6M Float, FS499_9M Float, FS499_12M Float,
 FS500_3M Float, FS500_6M Float, FS500_9M Float, FS500_12M Float,
 FS501_3M Float, FS501_6M Float, FS501_9M Float, FS501_12M Float,
 FS502_3M Float, FS502_6M Float, FS502_9M Float, FS502_12M Float,
 FS503_3M Float, FS503_6M Float, FS503_9M Float, FS503_12M Float,
 FS504_3M Float, FS504_6M Float, FS504_9M Float, FS504_12M Float,
 FS505_3M Float, FS505_6M Float, FS505_9M Float, FS505_12M Float,
 FS506_3M Float, FS506_6M Float, FS506_9M Float, FS506_12M Float,
 FS507_3M Float, FS507_6M Float, FS507_9M Float, FS507_12M Float,
 FS508_3M Float, FS508_6M Float, FS508_9M Float, FS508_12M Float,
 FS509_3M Float, FS509_6M Float, FS509_9M Float, FS509_12M Float,
 FS510_3M Float, FS510_6M Float, FS510_9M Float, FS510_12M Float,
 FS511_3M Float, FS511_6M Float, FS511_9M Float, FS511_12M Float,
 FS512_3M Float, FS512_6M Float, FS512_9M Float, FS512_12M Float,
 FS513_3M Float, FS513_6M Float, FS513_9M Float, FS513_12M Float,
 FS514_3M Float, FS514_6M Float, FS514_9M Float, FS514_12M Float,
 FS515_3M Float, FS515_6M Float, FS515_9M Float, FS515_12M Float,
 FS516_3M Float, FS516_6M Float, FS516_9M Float, FS516_12M Float,
 FS517_3M Float, FS517_6M Float, FS517_9M Float, FS517_12M Float,
 FS518_3M Float, FS518_6M Float, FS518_9M Float, FS518_12M Float,
 FS519_3M Float, FS519_6M Float, FS519_9M Float, FS519_12M Float,
 FS520_3M Float, FS520_6M Float, FS520_9M Float, FS520_12M Float,
 FS521_3M Float, FS521_6M Float, FS521_9M Float, FS521_12M Float,
 FS522_3M Float, FS522_6M Float, FS522_9M Float, FS522_12M Float,
 FS523_3M Float, FS523_6M Float, FS523_9M Float, FS523_12M Float,
 FS524_3M Float, FS524_6M Float, FS524_9M Float, FS524_12M Float,
 FS525_3M Float, FS525_6M Float, FS525_9M Float, FS525_12M Float,
 FS526_3M Float, FS526_6M Float, FS526_9M Float, FS526_12M Float,
 FS527_3M Float, FS527_6M Float, FS527_9M Float, FS527_12M Float,
 FS528_3M Float, FS528_6M Float, FS528_9M Float, FS528_12M Float,
 FS529_3M Float, FS529_6M Float, FS529_9M Float, FS529_12M Float,
 FS530_3M Float, FS530_6M Float, FS530_9M Float, FS530_12M Float,
 FS531_3M Float, FS531_6M Float, FS531_9M Float, FS531_12M Float,
 FS532_3M Float, FS532_6M Float, FS532_9M Float, FS532_12M Float,
 FS533_3M Float, FS533_6M Float, FS533_9M Float, FS533_12M Float,
 FS534_3M Float, FS534_6M Float, FS534_9M Float, FS534_12M Float,
 FS535_3M Float, FS535_6M Float, FS535_9M Float, FS535_12M Float,
 FS536_3M Float, FS536_6M Float, FS536_9M Float, FS536_12M Float,
 FS537_3M Float, FS537_6M Float, FS537_9M Float, FS537_12M Float,
 FS538_3M Float, FS538_6M Float, FS538_9M Float, FS538_12M Float,
 FS539_3M Float, FS539_6M Float, FS539_9M Float, FS539_12M Float,
 FS540_3M Float, FS540_6M Float, FS540_9M Float, FS540_12M Float,
 FS541_3M Float, FS541_6M Float, FS541_9M Float, FS541_12M Float,
 FS542_3M Float, FS542_6M Float, FS542_9M Float, FS542_12M Float,
 FS543_3M Float, FS543_6M Float, FS543_9M Float, FS543_12M Float,
 FS544_3M Float, FS544_6M Float, FS544_9M Float, FS544_12M Float,
 FS545_3M Float, FS545_6M Float, FS545_9M Float, FS545_12M Float,
 FS546_3M Float, FS546_6M Float, FS546_9M Float, FS546_12M Float,
 FS547_3M Float, FS547_6M Float, FS547_9M Float, FS547_12M Float,
 FS548_3M Float, FS548_6M Float, FS548_9M Float, FS548_12M Float,
 FS549_3M Float, FS549_6M Float, FS549_9M Float, FS549_12M Float,
 FS550_3M Float, FS550_6M Float, FS550_9M Float, FS550_12M Float,
 FS551_3M Float, FS551_6M Float, FS551_9M Float, FS551_12M Float,
 FS552_3M Float, FS552_6M Float, FS552_9M Float, FS552_12M Float,
 FS553_3M Float, FS553_6M Float, FS553_9M Float, FS553_12M Float,
 FS554_3M Float, FS554_6M Float, FS554_9M Float, FS554_12M Float)
GO

INSERT INTO BAM085_FS_200411(IDN)
SELECT DISTINCT IDN
FROM BAM085_200411
GO

UPDATE BAM085_FS_200411
SET
FS334=0,
FS315=0,
FS316=0,
FS317=0,
FS318=0,
FS319=0,
FS320=0,
FS321=0,
FS322=0,
FS323=0,
FS324=0,
FS325=0,
FS326=0,
FS327=0,
FS328=0,
FS329=0,
FS330=0,
FS331=0,
FS332=0,
FS333=0,
FS354_3M=0, FS354_6M=0, FS354_9M=0, FS354_12M=0,
FS355_3M=0, FS355_6M=0, FS355_9M=0, FS355_12M=0,
FS356_3M=0, FS356_6M=0, FS356_9M=0, FS356_12M=0,
FS357_3M=0, FS357_6M=0, FS357_9M=0, FS357_12M=0,
FS358_3M=0, FS358_6M=0, FS358_9M=0, FS358_12M=0,
FS359_3M=0, FS359_6M=0, FS359_9M=0, FS359_12M=0,
FS360_3M=0, FS360_6M=0, FS360_9M=0, FS360_12M=0,
FS361_3M=0, FS361_6M=0, FS361_9M=0, FS361_12M=0,
FS362_3M=0, FS362_6M=0, FS362_9M=0, FS362_12M=0,
FS363_3M=0, FS363_6M=0, FS363_9M=0, FS363_12M=0,
FS364_3M=0, FS364_6M=0, FS364_9M=0, FS364_12M=0,
FS365_3M=0, FS365_6M=0, FS365_9M=0, FS365_12M=0,
FS366_3M=0, FS366_6M=0, FS366_9M=0, FS366_12M=0,
FS367_3M=0, FS367_6M=0, FS367_9M=0, FS367_12M=0,
FS368_3M=0, FS368_6M=0, FS368_9M=0, FS368_12M=0,
FS369_3M=0, FS369_6M=0, FS369_9M=0, FS369_12M=0,
FS370_3M=0, FS370_6M=0, FS370_9M=0, FS370_12M=0,
FS371_3M=0, FS371_6M=0, FS371_9M=0, FS371_12M=0,
FS372_3M=0, FS372_6M=0, FS372_9M=0, FS372_12M=0,
FS373_3M=0, FS373_6M=0, FS373_9M=0, FS373_12M=0,
FS374_3M=0, FS374_6M=0, FS374_9M=0, FS374_12M=0,
FS375_3M=0, FS375_6M=0, FS375_9M=0, FS375_12M=0,
FS376_3M=0, FS376_6M=0, FS376_9M=0, FS376_12M=0,
FS377_3M=0, FS377_6M=0, FS377_9M=0, FS377_12M=0,
FS378_3M=0, FS378_6M=0, FS378_9M=0, FS378_12M=0,
FS379_3M=0, FS379_6M=0, FS379_9M=0, FS379_12M=0,
FS380_3M=0, FS380_6M=0, FS380_9M=0, FS380_12M=0,
FS381_3M=0, FS381_6M=0, FS381_9M=0, FS381_12M=0,
FS382_3M=0, FS382_6M=0, FS382_9M=0, FS382_12M=0,
FS383_3M=0, FS383_6M=0, FS383_9M=0, FS383_12M=0,
FS384_3M=0, FS384_6M=0, FS384_9M=0, FS384_12M=0,
FS385_3M=0, FS385_6M=0, FS385_9M=0, FS385_12M=0,
FS386_3M=0, FS386_6M=0, FS386_9M=0, FS386_12M=0,
FS387_3M=0, FS387_6M=0, FS387_9M=0, FS387_12M=0,
FS388_3M=0, FS388_6M=0, FS388_9M=0, FS388_12M=0,
FS389_3M=0, FS389_6M=0, FS389_9M=0, FS389_12M=0,
FS390_3M=0, FS390_6M=0, FS390_9M=0, FS390_12M=0,
FS391_3M=0, FS391_6M=0, FS391_9M=0, FS391_12M=0,
FS392_3M=0, FS392_6M=0, FS392_9M=0, FS392_12M=0,
FS393_3M=0, FS393_6M=0, FS393_9M=0, FS393_12M=0,
FS394_3M=0, FS394_6M=0, FS394_9M=0, FS394_12M=0,
FS395_3M=0, FS395_6M=0, FS395_9M=0, FS395_12M=0,
FS396_3M=0, FS396_6M=0, FS396_9M=0, FS396_12M=0,
FS397_3M=0, FS397_6M=0, FS397_9M=0, FS397_12M=0,
FS398_3M=0, FS398_6M=0, FS398_9M=0, FS398_12M=0,
FS399_3M=0, FS399_6M=0, FS399_9M=0, FS399_12M=0,
FS400_3M=0, FS400_6M=0, FS400_9M=0, FS400_12M=0,
FS401_3M=0, FS401_6M=0, FS401_9M=0, FS401_12M=0,
FS402_3M=0, FS402_6M=0, FS402_9M=0, FS402_12M=0,
FS403_3M=0, FS403_6M=0, FS403_9M=0, FS403_12M=0,
FS404_3M=0, FS404_6M=0, FS404_9M=0, FS404_12M=0,
FS405_3M=0, FS405_6M=0, FS405_9M=0, FS405_12M=0,
FS406_3M=0, FS406_6M=0, FS406_9M=0, FS406_12M=0,
FS407_3M=0, FS407_6M=0, FS407_9M=0, FS407_12M=0,
FS408_3M=0, FS408_6M=0, FS408_9M=0, FS408_12M=0,
FS409_3M=0, FS409_6M=0, FS409_9M=0, FS409_12M=0,
FS410_3M=0, FS410_6M=0, FS410_9M=0, FS410_12M=0,
FS411_3M=0, FS411_6M=0, FS411_9M=0, FS411_12M=0,
FS412_3M=0, FS412_6M=0, FS412_9M=0, FS412_12M=0,
FS413_3M=0, FS413_6M=0, FS413_9M=0, FS413_12M=0,
FS414_3M=0, FS414_6M=0, FS414_9M=0, FS414_12M=0,
FS415_3M=0, FS415_6M=0, FS415_9M=0, FS415_12M=0,
FS416_3M=0, FS416_6M=0, FS416_9M=0, FS416_12M=0,
FS417_3M=0, FS417_6M=0, FS417_9M=0, FS417_12M=0,
FS418_3M=0, FS418_6M=0, FS418_9M=0, FS418_12M=0,
FS419_3M=0, FS419_6M=0, FS419_9M=0, FS419_12M=0,
FS420_3M=0, FS420_6M=0, FS420_9M=0, FS420_12M=0,
FS421_3M=0, FS421_6M=0, FS421_9M=0, FS421_12M=0,
FS422_3M=0, FS422_6M=0, FS422_9M=0, FS422_12M=0,
FS423_3M=0, FS423_6M=0, FS423_9M=0, FS423_12M=0,
FS424_3M=0, FS424_6M=0, FS424_9M=0, FS424_12M=0,
FS425_3M=0, FS425_6M=0, FS425_9M=0, FS425_12M=0,
FS426_3M=0, FS426_6M=0, FS426_9M=0, FS426_12M=0,
FS427_3M=0, FS427_6M=0, FS427_9M=0, FS427_12M=0,
FS428_3M=0, FS428_6M=0, FS428_9M=0, FS428_12M=0,
FS429_3M=0, FS429_6M=0, FS429_9M=0, FS429_12M=0,
FS430_3M=0, FS430_6M=0, FS430_9M=0, FS430_12M=0,
FS431_3M=0, FS431_6M=0, FS431_9M=0, FS431_12M=0,
FS432_3M=0, FS432_6M=0, FS432_9M=0, FS432_12M=0,
FS433_3M=0, FS433_6M=0, FS433_9M=0, FS433_12M=0,
FS434_3M=0, FS434_6M=0, FS434_9M=0, FS434_12M=0,
FS435_3M=0, FS435_6M=0, FS435_9M=0, FS435_12M=0,
FS436_3M=0, FS436_6M=0, FS436_9M=0, FS436_12M=0,
FS437_3M=0, FS437_6M=0, FS437_9M=0, FS437_12M=0,
FS438_3M=0, FS438_6M=0, FS438_9M=0, FS438_12M=0,
FS439_3M=0, FS439_6M=0, FS439_9M=0, FS439_12M=0,
FS440_3M=0, FS440_6M=0, FS440_9M=0, FS440_12M=0,
FS441_3M=0, FS441_6M=0, FS441_9M=0, FS441_12M=0,
FS442_3M=0, FS442_6M=0, FS442_9M=0, FS442_12M=0,
FS443_3M=0, FS443_6M=0, FS443_9M=0, FS443_12M=0,
FS444_3M=0, FS444_6M=0, FS444_9M=0, FS444_12M=0,
FS445_3M=0, FS445_6M=0, FS445_9M=0, FS445_12M=0,
FS446_3M=0, FS446_6M=0, FS446_9M=0, FS446_12M=0,
FS447_3M=0, FS447_6M=0, FS447_9M=0, FS447_12M=0,
FS448_3M=0, FS448_6M=0, FS448_9M=0, FS448_12M=0,
FS449_3M=0, FS449_6M=0, FS449_9M=0, FS449_12M=0,
FS450_3M=0, FS450_6M=0, FS450_9M=0, FS450_12M=0,
FS451_3M=0, FS451_6M=0, FS451_9M=0, FS451_12M=0,
FS452_3M=0, FS452_6M=0, FS452_9M=0, FS452_12M=0,
FS453_3M=0, FS453_6M=0, FS453_9M=0, FS453_12M=0,
FS454_3M=0, FS454_6M=0, FS454_9M=0, FS454_12M=0,
FS455_3M=0, FS455_6M=0, FS455_9M=0, FS455_12M=0,
FS456_3M=0, FS456_6M=0, FS456_9M=0, FS456_12M=0,
FS457_3M=0, FS457_6M=0, FS457_9M=0, FS457_12M=0,
FS458_3M=0, FS458_6M=0, FS458_9M=0, FS458_12M=0,
FS459_3M=0, FS459_6M=0, FS459_9M=0, FS459_12M=0,
FS460_3M=0, FS460_6M=0, FS460_9M=0, FS460_12M=0,
FS461_3M=0, FS461_6M=0, FS461_9M=0, FS461_12M=0,
FS462_3M=0, FS462_6M=0, FS462_9M=0, FS462_12M=0,
FS463_3M=0, FS463_6M=0, FS463_9M=0, FS463_12M=0,
FS464_3M=0, FS464_6M=0, FS464_9M=0, FS464_12M=0,
FS465_3M=0, FS465_6M=0, FS465_9M=0, FS465_12M=0,
FS466_3M=0, FS466_6M=0, FS466_9M=0, FS466_12M=0,
FS467_3M=0, FS467_6M=0, FS467_9M=0, FS467_12M=0,
FS468_3M=0, FS468_6M=0, FS468_9M=0, FS468_12M=0,
FS469_3M=0, FS469_6M=0, FS469_9M=0, FS469_12M=0,
FS470_3M=0, FS470_6M=0, FS470_9M=0, FS470_12M=0,
FS471_3M=0, FS471_6M=0, FS471_9M=0, FS471_12M=0,
FS472_3M=0, FS472_6M=0, FS472_9M=0, FS472_12M=0,
FS473_3M=0, FS473_6M=0, FS473_9M=0, FS473_12M=0,
FS474_3M=0, FS474_6M=0, FS474_9M=0, FS474_12M=0,
FS475_3M=0, FS475_6M=0, FS475_9M=0, FS475_12M=0,
FS476_3M=0, FS476_6M=0, FS476_9M=0, FS476_12M=0,
FS477_3M=0, FS477_6M=0, FS477_9M=0, FS477_12M=0,
FS478_3M=0, FS478_6M=0, FS478_9M=0, FS478_12M=0,
FS479_3M=0, FS479_6M=0, FS479_9M=0, FS479_12M=0,
FS480_3M=0, FS480_6M=0, FS480_9M=0, FS480_12M=0,
FS481_3M=0, FS481_6M=0, FS481_9M=0, FS481_12M=0,
FS482_3M=0, FS482_6M=0, FS482_9M=0, FS482_12M=0,
FS483_3M=0, FS483_6M=0, FS483_9M=0, FS483_12M=0,
FS484_3M=0, FS484_6M=0, FS484_9M=0, FS484_12M=0,
FS485_3M=0, FS485_6M=0, FS485_9M=0, FS485_12M=0,
FS486_3M=0, FS486_6M=0, FS486_9M=0, FS486_12M=0,
FS487_3M=0, FS487_6M=0, FS487_9M=0, FS487_12M=0,
FS488_3M=0, FS488_6M=0, FS488_9M=0, FS488_12M=0,
FS489_3M=0, FS489_6M=0, FS489_9M=0, FS489_12M=0,
FS490_3M=0, FS490_6M=0, FS490_9M=0, FS490_12M=0,
FS491_3M=0, FS491_6M=0, FS491_9M=0, FS491_12M=0,
FS492_3M=0, FS492_6M=0, FS492_9M=0, FS492_12M=0,
FS493_3M=0, FS493_6M=0, FS493_9M=0, FS493_12M=0,
FS494_3M=0, FS494_6M=0, FS494_9M=0, FS494_12M=0,
FS495_3M=0, FS495_6M=0, FS495_9M=0, FS495_12M=0,
FS496_3M=0, FS496_6M=0, FS496_9M=0, FS496_12M=0,
FS497_3M=0, FS497_6M=0, FS497_9M=0, FS497_12M=0,
FS498_3M=0, FS498_6M=0, FS498_9M=0, FS498_12M=0,
FS499_3M=0, FS499_6M=0, FS499_9M=0, FS499_12M=0,
FS500_3M=0, FS500_6M=0, FS500_9M=0, FS500_12M=0,
FS501_3M=0, FS501_6M=0, FS501_9M=0, FS501_12M=0,
FS502_3M=0, FS502_6M=0, FS502_9M=0, FS502_12M=0,
FS503_3M=0, FS503_6M=0, FS503_9M=0, FS503_12M=0,
FS504_3M=0, FS504_6M=0, FS504_9M=0, FS504_12M=0,
FS505_3M=0, FS505_6M=0, FS505_9M=0, FS505_12M=0,
FS506_3M=0, FS506_6M=0, FS506_9M=0, FS506_12M=0,
FS507_3M=0, FS507_6M=0, FS507_9M=0, FS507_12M=0,
FS508_3M=0, FS508_6M=0, FS508_9M=0, FS508_12M=0,
FS509_3M=0, FS509_6M=0, FS509_9M=0, FS509_12M=0,
FS510_3M=0, FS510_6M=0, FS510_9M=0, FS510_12M=0,
FS511_3M=0, FS511_6M=0, FS511_9M=0, FS511_12M=0,
FS512_3M=0, FS512_6M=0, FS512_9M=0, FS512_12M=0,
FS513_3M=0, FS513_6M=0, FS513_9M=0, FS513_12M=0,
FS514_3M=0, FS514_6M=0, FS514_9M=0, FS514_12M=0,
FS515_3M=0, FS515_6M=0, FS515_9M=0, FS515_12M=0,
FS516_3M=0, FS516_6M=0, FS516_9M=0, FS516_12M=0,
FS517_3M=0, FS517_6M=0, FS517_9M=0, FS517_12M=0,
FS518_3M=0, FS518_6M=0, FS518_9M=0, FS518_12M=0,
FS519_3M=0, FS519_6M=0, FS519_9M=0, FS519_12M=0,
FS520_3M=0, FS520_6M=0, FS520_9M=0, FS520_12M=0,
FS521_3M=0, FS521_6M=0, FS521_9M=0, FS521_12M=0,
FS522_3M=0, FS522_6M=0, FS522_9M=0, FS522_12M=0,
FS523_3M=0, FS523_6M=0, FS523_9M=0, FS523_12M=0,
FS524_3M=0, FS524_6M=0, FS524_9M=0, FS524_12M=0,
FS525_3M=0, FS525_6M=0, FS525_9M=0, FS525_12M=0,
FS526_3M=0, FS526_6M=0, FS526_9M=0, FS526_12M=0,
FS527_3M=0, FS527_6M=0, FS527_9M=0, FS527_12M=0,
FS528_3M=0, FS528_6M=0, FS528_9M=0, FS528_12M=0,
FS529_3M=0, FS529_6M=0, FS529_9M=0, FS529_12M=0,
FS530_3M=0, FS530_6M=0, FS530_9M=0, FS530_12M=0,
FS531_3M=0, FS531_6M=0, FS531_9M=0, FS531_12M=0,
FS532_3M=0, FS532_6M=0, FS532_9M=0, FS532_12M=0,
FS533_3M=0, FS533_6M=0, FS533_9M=0, FS533_12M=0,
FS534_3M=0, FS534_6M=0, FS534_9M=0, FS534_12M=0,
FS535_3M=0, FS535_6M=0, FS535_9M=0, FS535_12M=0,
FS536_3M=0, FS536_6M=0, FS536_9M=0, FS536_12M=0,
FS537_3M=0, FS537_6M=0, FS537_9M=0, FS537_12M=0,
FS538_3M=0, FS538_6M=0, FS538_9M=0, FS538_12M=0,
FS539_3M=0, FS539_6M=0, FS539_9M=0, FS539_12M=0,
FS540_3M=0, FS540_6M=0, FS540_9M=0, FS540_12M=0,
FS541_3M=0, FS541_6M=0, FS541_9M=0, FS541_12M=0,
FS542_3M=0, FS542_6M=0, FS542_9M=0, FS542_12M=0,
FS543_3M=0, FS543_6M=0, FS543_9M=0, FS543_12M=0,
FS544_3M=0, FS544_6M=0, FS544_9M=0, FS544_12M=0,
FS545_3M=0, FS545_6M=0, FS545_9M=0, FS545_12M=0,
FS546_3M=0, FS546_6M=0, FS546_9M=0, FS546_12M=0,
FS547_3M=0, FS547_6M=0, FS547_9M=0, FS547_12M=0,
FS548_3M=0, FS548_6M=0, FS548_9M=0, FS548_12M=0,
FS549_3M=0, FS549_6M=0, FS549_9M=0, FS549_12M=0,
FS550_3M=0, FS550_6M=0, FS550_9M=0, FS550_12M=0,
FS551_3M=0, FS551_6M=0, FS551_9M=0, FS551_12M=0,
FS552_3M=0, FS552_6M=0, FS552_9M=0, FS552_12M=0,
FS553_3M=0, FS553_6M=0, FS553_9M=0, FS553_12M=0,
FS554_3M=0, FS554_6M=0, FS554_9M=0, FS554_12M=0
GO

DROP TABLE FS_TMP
GO
DROP TABLE FS_TMP1
GO
DROP TABLE FS_TMP2
GO

CREATE TABLE FS_TMP
(IDN Char(6),
 Mon INT,
 V1 FLOAT,
 V2 FLOAT,
 V3 FLOAT)
GO

CREATE TABLE FS_TMP1
(IDN Char(6),
 Mon INT,
 V1 FLOAT)
GO

CREATE TABLE FS_TMP2
(IDN Char(6),
 Issuer char(3),
 Mon int,
 Line int)
GO

----FS334----
--曾經最高逾期月數
DELETE FROM FS_TMP1

INSERT INTO FS_TMP1(IDN, V1)
SELECT IDN, MAX(Bucket)
FROM y_BAM085_tmp_200411
GROUP BY IDN  
 
UPDATE BAM085_FS_200411
SET
FS334 = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN
GO

----FS315----
--有擔保貸款 曾經最高遲繳月數
DELETE FROM FS_TMP1

INSERT INTO FS_TMP1(IDN, V1)
SELECT IDN, MAX(Bucket)
FROM y_BAM085_tmp_200411
WHERE account_code2 in ('S', 'W', 'M') OR
      ACCOUNT_CODE = 'K'
GROUP BY IDN  
 
UPDATE BAM085_FS_200411
SET
FS315 = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN
GO

----FS316----
--有擔保貸款 - 短期 曾經最高遲繳月數
DELETE FROM FS_TMP1

INSERT INTO FS_TMP1(IDN, V1)
SELECT IDN, MAX(Bucket)
FROM y_BAM085_tmp_200411
WHERE account_code in ('W','C','D','E') AND
      account_code2 in ('S', 'W', 'M')
GROUP BY IDN  
 
UPDATE BAM085_FS_200411
SET
FS316 = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN
GO

----FS317----
--有擔保貸款 - 中期 曾經最高遲繳月數
DELETE FROM FS_TMP1

INSERT INTO FS_TMP1(IDN, V1)
SELECT IDN, MAX(Bucket)
FROM y_BAM085_tmp_200411
WHERE account_code in ('H','S') AND
      account_code2 in ('S', 'W', 'M')
GROUP BY IDN  
 
UPDATE BAM085_FS_200411
SET
FS317 = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN
GO

----FS318----
--有擔保貸款 - 長期 曾經最高遲繳月數
DELETE FROM FS_TMP1

INSERT INTO FS_TMP1(IDN, V1)
SELECT IDN, MAX(Bucket)
FROM y_BAM085_tmp_200411
WHERE account_code in ('I','T') AND
      account_code2 in ('S', 'W', 'M')
GROUP BY IDN  
 
UPDATE BAM085_FS_200411
SET
FS318 = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN
GO

----FS319----
--無擔保貸款 曾經最高遲繳月數
DELETE FROM FS_TMP1

INSERT INTO FS_TMP1(IDN, V1)
SELECT IDN, MAX(Bucket)
FROM y_BAM085_tmp_200411
WHERE ((account_code2 is null) OR (account_code2 = '') OR (account_code = 'N')) AND
       Account_Code != 'K'
GROUP BY IDN  
 
UPDATE BAM085_FS_200411
SET
FS319 = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN
GO

----FS320----
--無擔保貸款 - 短期 曾經最高遲繳月數
DELETE FROM FS_TMP1

INSERT INTO FS_TMP1(IDN, V1)
SELECT IDN, MAX(Bucket)
FROM y_BAM085_tmp_200411
WHERE account_code in ('W','C', 'D', 'E') AND
      ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N'))
GROUP BY IDN  
 
UPDATE BAM085_FS_200411
SET
FS320 = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN
GO

----FS321----
--無擔保貸款 - 中期 曾經最高遲繳月數
DELETE FROM FS_TMP1

INSERT INTO FS_TMP1(IDN, V1)
SELECT IDN, MAX(Bucket)
FROM y_BAM085_tmp_200411
WHERE account_code in ('H','S') AND
      ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N'))
GROUP BY IDN  
 
UPDATE BAM085_FS_200411
SET
FS321 = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN
GO

----FS322----
--無擔保貸款 - 長期 曾經最高遲繳月數
DELETE FROM FS_TMP1

INSERT INTO FS_TMP1(IDN, V1)
SELECT IDN, MAX(Bucket)
FROM y_BAM085_tmp_200411
WHERE account_code in ('I','T') AND
      ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N'))
GROUP BY IDN  
 
UPDATE BAM085_FS_200411
SET
FS322 = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN
GO

----FS323----
--財政部優惠貸款筆數 曾經最高遲繳月數
DELETE FROM FS_TMP1

INSERT INTO FS_TMP1(IDN, V1)
SELECT IDN, MAX(Bucket)
FROM y_BAM085_tmp_200411
WHERE account_code2 in ('V','W')
GROUP BY IDN  
 
UPDATE BAM085_FS_200411
SET
FS323 = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN
GO

----FS324----
--不動產貸款筆數 曾經最高遲繳月數
DELETE FROM FS_TMP1

INSERT INTO FS_TMP1(IDN, V1)
SELECT IDN, MAX(Bucket)
FROM y_BAM085_tmp_200411
WHERE purpose_code = '1'
GROUP BY IDN  
 
UPDATE BAM085_FS_200411
SET
FS324 = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN
GO

----FS325----
--動產貸款筆數 曾經最高遲繳月數
DELETE FROM FS_TMP1

INSERT INTO FS_TMP1(IDN, V1)
SELECT IDN, MAX(Bucket)
FROM y_BAM085_tmp_200411
WHERE purpose_code = '2'
GROUP BY IDN  
 
UPDATE BAM085_FS_200411
SET
FS325 = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN
GO

----FS326----
--週轉金貸款筆數 曾經最高遲繳月數
DELETE FROM FS_TMP1

INSERT INTO FS_TMP1(IDN, V1)
SELECT IDN, MAX(Bucket)
FROM y_BAM085_tmp_200411
WHERE purpose_code = '4'
GROUP BY IDN  
 
UPDATE BAM085_FS_200411
SET
FS326 = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN
GO

----FS327----
--存保單質押筆數 (無擔保) 曾經最高遲繳月數

DELETE FROM FS_TMP1

INSERT INTO FS_TMP1(IDN, V1)
SELECT IDN, MAX(Bucket)
FROM y_BAM085_tmp_200411
WHERE account_code='K' AND
      ((account_code2 is null) OR (account_code2 = '') OR (account_code = 'N')) AND
      purpose_code = '4'
GROUP BY IDN  
 
UPDATE BAM085_FS_200411
SET
FS327 = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN
GO

----FS328----
--現金卡筆數 (無擔保) 曾經最高遲繳月數
DELETE FROM FS_TMP1

INSERT INTO FS_TMP1(IDN, V1)
SELECT IDN, MAX(Bucket)
FROM y_BAM085_tmp_200411
WHERE account_code = 'Y'
GROUP BY IDN  
 
UPDATE BAM085_FS_200411
SET
FS328 = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN
GO

----FS329----
--Co-Loan 曾經最高遲繳月數
DELETE FROM FS_TMP1

INSERT INTO FS_TMP1(IDN, V1)
SELECT IDN, MAX(Bucket)
FROM y_BAM085_tmp_200411
WHERE Co_Loan = 'Y'
GROUP BY IDN  
 
UPDATE BAM085_FS_200411
SET
FS329 = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN
GO

----FS330----
--在同一金融機構沒有房貸的購屋用無擔保貸款  曾經最高遲繳月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP2

INSERT INTO FS_TMP2(IDN, ISSUER)
SELECT IDN, BANK_CODE2
FROM BAM085_200411
WHERE PURPOSE_CODE = '1' AND
      account_code2 in ('S', 'W', 'M')

INSERT INTO FS_TMP1(IDN, V1)
SELECT IDN, MAX(Bucket)
FROM y_BAM085_tmp_200411
WHERE NOT EXISTS
(SELECT * FROM FS_TMP2
 WHERE y_BAM085_tmp_200411.IDN = FS_TMP2.IDN AND
       y_BAM085_tmp_200411.BANK_CODE2 = FS_TMP2.ISSUER) AND
      PURPOSE_CODE = '1' AND
      ((account_code2 is null) OR (account_code2 = '') OR (account_code = 'N')) AND
      ACCOUNT_CODE != 'K'
GROUP BY IDN  
 
UPDATE BAM085_FS_200411
SET
FS330 = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN
GO

----FS331----
--除在同一金融機構沒有房貸的購屋用無擔保貸款外的無擔保貸款  曾經最高遲繳月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP
DELETE FROM FS_TMP2

INSERT INTO FS_TMP(IDN, V1)
SELECT IDN, MAX(bucket)
FROM y_BAM085_tmp_200411
WHERE PURPOSE_CODE != '1' AND
      ((account_code2 is null) OR (account_code2 = '') OR (account_code = 'N')) AND
      Account_Code != 'K'
GROUP BY IDN
      
INSERT INTO FS_TMP2(IDN, ISSUER)
SELECT IDN, BANK_CODE2
FROM BAM085_200411
WHERE PURPOSE_CODE = '1' AND
      account_code2 in ('S', 'W', 'M')

INSERT INTO FS_TMP1(IDN, V1)
SELECT IDN, MAX(bucket)
FROM y_BAM085_tmp_200411
WHERE Bucket > 0 AND
      EXISTS
(SELECT * FROM FS_TMP2
 WHERE y_BAM085_tmp_200411.IDN = FS_TMP2.IDN AND
       y_BAM085_tmp_200411.BANK_CODE2 = FS_TMP2.ISSUER) AND
      PURPOSE_CODE = '1' AND
      ((account_code2 is null) OR (account_code2 = '') OR (account_code = 'N')) AND
      ACCOUNT_CODE != 'K'
GROUP BY IDN  

INSERT INTO FS_TMP(IDN)
SELECT IDN FROM FS_TMP1
WHERE IDN NOT IN (SELECT IDN FROM FS_TMP)

UPDATE FS_TMP
SET
V2 = A.V1
FROM FS_TMP1 AS A INNER JOIN FS_TMP AS B
ON A.IDN = B.IDN

UPDATE FS_TMP
SET
V3 = (CASE WHEN ISNULL(V1, 0) > ISNULL(V2, 0) THEN ISNULL(V1, 0) ELSE ISNULL(V2, 0) END)            

UPDATE BAM085_FS_200411
SET
FS331 = V3
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN
GO

----FS332----
--有擔保購屋貸款  曾經最高遲繳月數
DELETE FROM FS_TMP1

INSERT INTO FS_TMP1(IDN, V1)
SELECT IDN, MAX(Bucket)
FROM y_BAM085_tmp_200411
WHERE PURPOSE_CODE = '1' AND
      (account_code2 in ('S', 'W', 'M') OR ACCOUNT_CODE = 'K')
GROUP BY IDN

UPDATE BAM085_FS_200411
SET
FS332 = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN
GO

----FS333----
--無擔保非購屋貸款  曾經最高遲繳月數
DELETE FROM FS_TMP1

INSERT INTO FS_TMP1(IDN, V1)
SELECT IDN, MAX(Bucket)
FROM y_BAM085_tmp_200411
WHERE PURPOSE_CODE != '1' AND
      ((account_code2 is null) OR (account_code2 = '') OR (account_code = 'N')) AND
      Account_Code != 'K'
GROUP BY IDN

UPDATE BAM085_FS_200411
SET
FS333 = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN
GO

----FS354----
--總放款曾經cured最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END
 
UPDATE BAM085_FS_200411
SET
FS354_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS354_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS354_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS354_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS355----
--有擔保貸款曾經cured最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      ((B.account_code2 in ('S', 'W', 'M')) OR
       (B.Account_Code = 'K'))
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS355_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS355_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS355_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS355_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS356----
--有擔保貸款曾經cured最多筆數 - 短期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.account_code in ('W','C','D','E') AND
      B.account_code2 in ('S', 'W', 'M')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS356_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS356_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS356_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS356_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS357----
--有擔保貸款曾經cured最多筆數 - 中期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.account_code in ('H','S') AND
      B.account_code2 in ('S', 'W', 'M')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS357_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS357_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS357_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS357_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS358----
--有擔保貸款曾經cured最多筆數 - 長期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.account_code in ('I','T') AND
      B.account_code2 in ('S', 'W', 'M')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS358_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS358_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS358_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS358_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS359----
--無擔保貸款曾經cured最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.Account_Code != 'K'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS359_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS359_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS359_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS359_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS360----
--無擔保貸款曾經cured最多筆數 - 短期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.account_code in ('W','C', 'D', 'E') AND
      A.Account_Code != 'K'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS360_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS360_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS360_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS360_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS361----
--無擔保貸款曾經cured最多筆數 - 中期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.account_code in ('H','S')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS361_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS361_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS361_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS361_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS362----
--無擔保貸款曾經cured最多筆數 - 長期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.account_code in ('I','T')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS362_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS362_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS362_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS362_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS363----
--財政部優惠貸款曾經cured最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.account_code2 in ('V','W')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS363_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS363_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS363_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS363_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS364----
--不動產貸款曾經cured最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.purpose_code = '1'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS364_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS364_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS364_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS364_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS365----
--動產貸款曾經cured最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.purpose_code = '2'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS365_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS365_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS365_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS365_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS366----
--週轉金貸款曾經cured最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.purpose_code = '4'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS366_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS366_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS366_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS366_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS367----
--存保單質押曾經cured最多筆數 (無擔保)
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.account_code='K' AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.purpose_code = '4'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS367_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS367_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS367_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS367_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS368----
--現金卡曾經cured最多筆數 (無擔保)
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.account_code = 'Y'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS368_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS368_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS368_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS368_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS369----
--Co-Loan 曾經cured最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.Co_Loan = 'Y'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS369_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS369_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS369_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS369_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS370----
--在同一金融機構沒有房貸的購屋用無擔保貸款曾經cured最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP
DELETE FROM FS_TMP2

INSERT INTO FS_TMP2(IDN, ISSUER)
SELECT IDN, BANK_CODE2
FROM BAM085_200411
WHERE PURPOSE_CODE = '1' AND
      account_code2 in ('S', 'W', 'M')

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      NOT EXISTS
(SELECT * FROM FS_TMP2
 WHERE B.IDN = FS_TMP2.IDN AND
       B.BANK_CODE2 = FS_TMP2.ISSUER) AND
       B.PURPOSE_CODE = '1' AND
       ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
       B.ACCOUNT_CODE != 'K'
GROUP BY B.IDN, B.cycle  

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN
  SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS370_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS370_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS370_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS370_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO
 
----FS371----
--除在同一金融機構沒有房貸的購屋用無擔保貸款外的無擔保貸款曾經cured最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP
DELETE FROM FS_TMP2

INSERT INTO FS_TMP(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.PURPOSE_CODE != 1 AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      A.Account_Code != 'K'
GROUP BY B.IDN, B.cycle
            
INSERT INTO FS_TMP2(IDN, ISSUER)
SELECT IDN, BANK_CODE2
FROM BAM085_200411
WHERE PURPOSE_CODE = '1' AND
      account_code2 in ('S', 'W', 'M')

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      EXISTS
(SELECT * FROM FS_TMP2
 WHERE B.IDN = FS_TMP2.IDN AND
       B.BANK_CODE2 = FS_TMP2.ISSUER) AND
       B.PURPOSE_CODE = '1' AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
       B.ACCOUNT_CODE != 'K'
GROUP BY B.IDN, B.cycle  

INSERT INTO FS_TMP(IDN, MON)
SELECT IDN, MON FROM FS_TMP1
WHERE NOT EXISTS (SELECT * FROM FS_TMP 
                  WHERE FS_TMP1.IDN = FS_TMP.IDN AND
                  FS_TMP1.MON = FS_TMP.MON)

UPDATE FS_TMP
SET
V2 = A.V1
FROM FS_TMP1 AS A INNER JOIN FS_TMP AS B
ON A.IDN = B.IDN AND
   A.MON = B.MON

UPDATE FS_TMP
SET
V3 = ISNULL(V1, 0) + ISNULL(V2, 0)
      
DELETE FROM FS_TMP1
      
DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, MAX(V3)
  FROM FS_TMP
  WHERE MON >= @i
  GROUP BY IDN
  SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS371_3M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS371_6M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS371_9M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS371_12M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS372----
--有擔保購屋貸款曾經cured最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.PURPOSE_CODE = '1' AND
      ((B.account_code2 in ('S', 'W', 'M')) OR (B.ACCOUNT_CODE = 'K'))
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS372_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS372_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS372_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS372_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS373----
--無擔保非購屋貸款曾經cured最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.PURPOSE_CODE != '1' AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      A.Account_Code != 'K'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS373_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS373_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS373_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS373_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS374----
--總放款曾經cured平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END
 
UPDATE BAM085_FS_200411
SET
FS374_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS374_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS374_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS374_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS375----
--有擔保貸款曾經cured平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      ((B.account_code2 in ('S', 'W', 'M')) OR
     (B.Account_Code = 'K'))
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS375_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS375_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS375_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS375_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS376----
--有擔保貸款曾經cured平均筆數 - 短期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.account_code in ('W','C','D','E') AND
      B.account_code2 in ('S', 'W', 'M')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS376_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS376_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS376_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS376_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS377----
--有擔保貸款曾經cured平均筆數 - 中期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.account_code in ('H','S') AND
      B.account_code2 in ('S', 'W', 'M')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS377_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS377_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS377_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS377_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS378----
--有擔保貸款曾經cured平均筆數 - 長期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.account_code in ('I','T') AND
      B.account_code2 in ('S', 'W', 'M')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS378_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS378_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS378_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS378_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS379----
--無擔保貸款曾經cured平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.Account_Code != 'K'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS379_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS379_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS379_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS379_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS380----
--無擔保貸款曾經cured平均筆數 - 短期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.account_code in ('W','C', 'D', 'E')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS380_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS380_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS380_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS380_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS381----
--無擔保貸款曾經cured平均筆數 - 中期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.account_code in ('H','S')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS381_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS381_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS381_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS381_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS382----
--無擔保貸款曾經cured平均筆數 - 長期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.account_code in ('I','T')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS382_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS382_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS382_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS382_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS383----
--財政部優惠貸款曾經cured平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.account_code2 in ('V','W')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS383_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS383_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS383_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS383_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS384----
--不動產貸款曾經cured平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.purpose_code = '1'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS384_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS384_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS384_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS384_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS385----
--動產貸款曾經cured平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.purpose_code = '2'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS385_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS385_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS385_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS385_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS386----
--週轉金貸款曾經cured平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.purpose_code = '4'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS386_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS386_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS386_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS386_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS387----
--存保單質押曾經cured平均筆數 (無擔保)
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.account_code='K' AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.purpose_code = '4'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS387_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS387_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS387_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS387_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS388----
--現金卡曾經cured平均筆數 (無擔保)
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.account_code = 'Y'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS388_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS388_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS388_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS388_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS389----
--Co-Loan 曾經cured平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.Co_Loan = 'Y'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS389_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS389_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS389_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS389_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS390----
--在同一金融機構沒有房貸的購屋用無擔保貸款曾經cured平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP
DELETE FROM FS_TMP2

INSERT INTO FS_TMP2(IDN, ISSUER)
SELECT IDN, BANK_CODE2
FROM BAM085_200411
WHERE PURPOSE_CODE = '1' AND
      account_code2 in ('S', 'W', 'M')

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      NOT EXISTS
(SELECT * FROM FS_TMP2
 WHERE B.IDN = FS_TMP2.IDN AND
       B.BANK_CODE2 = FS_TMP2.ISSUER) AND
       B.PURPOSE_CODE = '1' AND
       ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
       B.ACCOUNT_CODE != 'K'
GROUP BY B.IDN, B.cycle  

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN
  SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS390_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS390_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS390_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS390_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS391
--除在同一金融機構沒有房貸的購屋用無擔保貸款外的無擔保貸款曾經cured平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP
DELETE FROM FS_TMP2

INSERT INTO FS_TMP(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.PURPOSE_CODE != 1 AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      A.Account_Code != 'K'
GROUP BY B.IDN, B.cycle
            
INSERT INTO FS_TMP2(IDN, ISSUER)
SELECT IDN, BANK_CODE2
FROM BAM085_200411
WHERE PURPOSE_CODE = '1' AND
      account_code2 in ('S', 'W', 'M')

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      EXISTS
(SELECT * FROM FS_TMP2
 WHERE B.IDN = FS_TMP2.IDN AND
       B.BANK_CODE2 = FS_TMP2.ISSUER) AND
       B.PURPOSE_CODE = '1' AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
       B.ACCOUNT_CODE != 'K'
GROUP BY B.IDN, B.cycle  

INSERT INTO FS_TMP(IDN, MON)
SELECT IDN, MON FROM FS_TMP1
WHERE NOT EXISTS (SELECT * FROM FS_TMP 
                  WHERE FS_TMP1.IDN = FS_TMP.IDN AND
                  FS_TMP1.MON = FS_TMP.MON)
UPDATE FS_TMP
SET
V2 = A.V1
FROM FS_TMP1 AS A INNER JOIN FS_TMP AS B
ON A.IDN = B.IDN AND
   A.MON = B.MON

UPDATE FS_TMP
SET
V3 = ISNULL(V1, 0) + ISNULL(V2, 0)
      
DELETE FROM FS_TMP1
      
DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, AVG(V3)
  FROM FS_TMP
  WHERE MON >= @i
  GROUP BY IDN
  SET @i = @i - 3
END


UPDATE BAM085_FS_200411
SET
FS391_3M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS391_6M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS391_9M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS391_12M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS392----
--有擔保購屋貸款曾經cured平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.PURPOSE_CODE = '1' AND
      ((B.account_code2 in ('S', 'W', 'M')) OR (B.ACCOUNT_CODE = 'K'))
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS392_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS392_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS392_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS392_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS393----
--無擔保非購屋貸款曾經cured平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE B.bucket = 0 AND
      A.bucket >  0 AND
      B.PURPOSE_CODE != '1' AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      A.Account_Code != 'K'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS393_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS393_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS393_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS393_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS394----
--總放款曾經bucket decrease 最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END
 
UPDATE BAM085_FS_200411
SET
FS394_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS394_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS394_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS394_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS395----
--有擔保貸款曾經bucket decrease 最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      ((B.account_code2 in ('S', 'W', 'M')) OR
     (B.Account_Code = 'K'))
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS395_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS395_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS395_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS395_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS396----
--有擔保貸款曾經bucket decrease 最多筆數 - 短期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code in ('W','C','D','E') AND
      B.account_code2 in ('S', 'W', 'M')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS396_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS396_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS396_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS396_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS397----
--有擔保貸款曾經bucket decrease 最多筆數 - 中期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code in ('H','S') AND
      B.account_code2 in ('S', 'W', 'M')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS397_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS397_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS397_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS397_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS398----
--有擔保貸款曾經bucket decrease 最多筆數 - 長期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code in ('I','T') AND
      B.account_code2 in ('S', 'W', 'M')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS398_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS398_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS398_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS398_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS399----
--無擔保貸款曾經bucket decrease 最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.Account_Code != 'K'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS399_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS399_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS399_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS399_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS400----
--無擔保貸款曾經bucket decrease 最多筆數 - 短期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.account_code in ('W','C', 'D', 'E')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS400_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS400_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS400_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS400_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS401----
--無擔保貸款曾經bucket decrease 最多筆數 - 中期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.account_code in ('H','S')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS401_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS401_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS401_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS401_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS402----
--無擔保貸款曾經bucket decrease 最多筆數 - 長期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.account_code in ('I','T')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS402_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS402_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS402_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS402_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS403----
--財政部優惠貸款曾經bucket decrease 最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code2 in ('V','W')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS403_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS403_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS403_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS403_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS404----
--不動產貸款曾經bucket decrease 最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.purpose_code = '1'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS404_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS404_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS404_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS404_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS405----
--動產貸款曾經bucket decrease 最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.purpose_code = '2'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS405_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS405_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS405_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS405_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS406----
--週轉金貸款曾經bucket decrease 最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.purpose_code = '4'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS406_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS406_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS406_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS406_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS407----
--存保單質押曾經bucket decrease 最多筆數 (無擔保)
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code='K' AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.purpose_code = '4'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS407_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS407_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS407_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS407_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS408----
--現金卡曾經bucket decrease 最多筆數 (無擔保)
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code = 'Y'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS408_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS408_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS408_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS408_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS409----
--Co-Loan 曾經bucket decrease 最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.Co_Loan = 'Y'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS409_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS409_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS409_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS409_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS410----
--在同一金融機構沒有房貸的購屋用無擔保貸款曾經bucket decrease 最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP
DELETE FROM FS_TMP2

INSERT INTO FS_TMP2(IDN, ISSUER)
SELECT IDN, BANK_CODE2
FROM BAM085_200411
WHERE PURPOSE_CODE = '1' AND
      account_code2 in ('S', 'W', 'M')

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      NOT EXISTS
(SELECT * FROM FS_TMP2
 WHERE B.IDN = FS_TMP2.IDN AND
       B.BANK_CODE2 = FS_TMP2.ISSUER) AND
       B.PURPOSE_CODE = '1' AND
       ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
       B.ACCOUNT_CODE != 'K'
GROUP BY B.IDN, B.cycle  

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN
  SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS410_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS410_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS410_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS410_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO
 
----FS411----
--除在同一金融機構沒有房貸的購屋用無擔保貸款外的無擔保貸款曾經bucket decrease 最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP
DELETE FROM FS_TMP2

INSERT INTO FS_TMP(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.PURPOSE_CODE != 1 AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      A.Account_Code != 'K'
GROUP BY B.IDN, B.cycle
            
INSERT INTO FS_TMP2(IDN, ISSUER)
SELECT IDN, BANK_CODE2
FROM BAM085_200411
WHERE PURPOSE_CODE = '1' AND
      account_code2 in ('S', 'W', 'M')

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      EXISTS
(SELECT * FROM FS_TMP2
 WHERE B.IDN = FS_TMP2.IDN AND
       B.BANK_CODE2 = FS_TMP2.ISSUER) AND
       B.PURPOSE_CODE = '1' AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
       B.ACCOUNT_CODE != 'K'
GROUP BY B.IDN, B.cycle  

INSERT INTO FS_TMP(IDN, MON)
SELECT IDN, MON FROM FS_TMP1
WHERE NOT EXISTS (SELECT * FROM FS_TMP 
                  WHERE FS_TMP1.IDN = FS_TMP.IDN AND
                  FS_TMP1.MON = FS_TMP.MON)

UPDATE FS_TMP
SET
V2 = A.V1
FROM FS_TMP1 AS A INNER JOIN FS_TMP AS B
ON A.IDN = B.IDN AND
   A.MON = B.MON

UPDATE FS_TMP
SET
V3 = ISNULL(V1, 0) + ISNULL(V2, 0)
      
DELETE FROM FS_TMP1
      
DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, MAX(V3)
  FROM FS_TMP
  WHERE MON >= @i
  GROUP BY IDN
  SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS411_3M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS411_6M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS411_9M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS411_12M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS412----
--有擔保購屋貸款曾經bucket decrease 最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.PURPOSE_CODE = '1' AND
      ((B.account_code2 in ('S', 'W', 'M')) OR (B.ACCOUNT_CODE = 'K'))
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS412_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS412_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS412_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS412_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS413----
--無擔保非購屋貸款曾經bucket decrease 最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.PURPOSE_CODE != '1' AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      A.Account_Code != 'K'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS413_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS413_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS413_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS413_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS414----
--總放款曾經bucket decrease 平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END
 
UPDATE BAM085_FS_200411
SET
FS414_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS414_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS414_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS414_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS415----
--有擔保貸款曾經bucket decrease 平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      ((B.account_code2 in ('S', 'W', 'M')) OR
     (B.Account_Code = 'K'))
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS415_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS415_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS415_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS415_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS416----
--有擔保貸款曾經bucket decrease 平均筆數 - 短期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code in ('W','C','D','E') AND
      B.account_code2 in ('S', 'W', 'M')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS416_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS416_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS416_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS416_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS417----
--有擔保貸款曾經bucket decrease 平均筆數 - 中期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code in ('H','S') AND
      B.account_code2 in ('S', 'W', 'M')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS417_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS417_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS417_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS417_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS418----
--有擔保貸款曾經bucket decrease 平均筆數 - 長期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code in ('I','T') AND
      B.account_code2 in ('S', 'W', 'M')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS418_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS418_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS418_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS418_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS419----
--無擔保貸款曾經bucket decrease 平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.Account_Code != 'K'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS419_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS419_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS419_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS419_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS420----
--無擔保貸款曾經bucket decrease 平均筆數 - 短期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.account_code in ('W','C', 'D', 'E')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS420_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS420_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS420_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS420_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS421----
--無擔保貸款曾經bucket decrease 平均筆數 - 中期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.account_code in ('H','S')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS421_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS421_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS421_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS421_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS422----
--無擔保貸款曾經bucket decrease 平均筆數 - 長期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.account_code in ('I','T')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS422_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS422_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS422_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS422_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS423----
--財政部優惠貸款曾經bucket decrease 平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code2 in ('V','W')
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS423_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS423_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS423_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS423_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS424----
--不動產貸款曾經bucket decrease 平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.purpose_code = '1'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS424_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS424_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS424_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS424_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS425----
--動產貸款曾經bucket decrease 平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.purpose_code = '2'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS425_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS425_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS425_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS425_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS426----
--週轉金貸款曾經bucket decrease 平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.purpose_code = '4'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS426_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS426_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS426_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS426_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS427----
--存保單質押曾經bucket decrease 平均筆數 (無擔保)
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code='K' AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.purpose_code = '4'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS427_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS427_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS427_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS427_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS428----
--現金卡曾經bucket decrease 平均筆數 (無擔保)
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code ='Y'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS428_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS428_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS428_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS428_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS429----
--Co-Loan 曾經bucket decrease 平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.Co_Loan = 'Y'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS429_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS429_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS429_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS429_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS430----
--在同一金融機構沒有房貸的購屋用無擔保貸款曾經bucket decrease 平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP
DELETE FROM FS_TMP2

INSERT INTO FS_TMP2(IDN, ISSUER)
SELECT IDN, BANK_CODE2
FROM BAM085_200411
WHERE PURPOSE_CODE = '1' AND
      account_code2 in ('S', 'W', 'M')

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      NOT EXISTS
(SELECT * FROM FS_TMP2
 WHERE B.IDN = FS_TMP2.IDN AND
       B.BANK_CODE2 = FS_TMP2.ISSUER) AND
       B.PURPOSE_CODE = '1' AND
       ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
       B.ACCOUNT_CODE != 'K'
GROUP BY B.IDN, B.cycle  

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN
  SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS430_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS430_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS430_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS430_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO
 
----FS431----
--除在同一金融機構沒有房貸的購屋用無擔保貸款外的無擔保貸款曾經bucket decrease 平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP
DELETE FROM FS_TMP2

INSERT INTO FS_TMP(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.PURPOSE_CODE != 1 AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      A.Account_Code != 'K'
GROUP BY B.IDN, B.cycle
            
INSERT INTO FS_TMP2(IDN, ISSUER)
SELECT IDN, BANK_CODE2
FROM BAM085_200411
WHERE PURPOSE_CODE = '1' AND
      account_code2 in ('S', 'W', 'M')

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      EXISTS
(SELECT * FROM FS_TMP2
 WHERE B.IDN = FS_TMP2.IDN AND
       B.BANK_CODE2 = FS_TMP2.ISSUER) AND
       B.PURPOSE_CODE = '1' AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
       B.ACCOUNT_CODE != 'K'
GROUP BY B.IDN, B.cycle  

INSERT INTO FS_TMP(IDN, MON)
SELECT IDN, MON FROM FS_TMP1
WHERE NOT EXISTS (SELECT * FROM FS_TMP 
                  WHERE FS_TMP1.IDN = FS_TMP.IDN AND
                  FS_TMP1.MON = FS_TMP.MON)
UPDATE FS_TMP
SET
V2 = A.V1
FROM FS_TMP1 AS A INNER JOIN FS_TMP AS B
ON A.IDN = B.IDN AND
   A.MON = B.MON

UPDATE FS_TMP
SET
V3 = ISNULL(V1, 0) + ISNULL(V2, 0)
      
DELETE FROM FS_TMP1
      
DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, AVG(V3)
  FROM FS_TMP
  WHERE MON >= @i
  GROUP BY IDN
  SET @i = @i - 3
END


UPDATE BAM085_FS_200411
SET
FS431_3M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS431_6M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS431_9M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS431_12M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS432----
--有擔保購屋貸款曾經bucket decrease 平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.PURPOSE_CODE = '1' AND
      ((B.account_code2 in ('S', 'W', 'M')) OR (B.ACCOUNT_CODE = 'K'))
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS432_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS432_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS432_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS432_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS433----
--無擔保非購屋貸款曾經bucket decrease 平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, COUNT(*)
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.PURPOSE_CODE != '1' AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      A.Account_Code != 'K'
GROUP BY B.IDN, B.cycle

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS433_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS433_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS433_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS433_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS434----
--總放款曾經bucket decrease 最高月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket 
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END
 
UPDATE BAM085_FS_200411
SET
FS434_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS434_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS434_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS434_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS435----
--有擔保貸款曾經bucket decrease 最高月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      ((B.account_code2 in ('S', 'W', 'M')) OR
     (B.Account_Code = 'K'))

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS435_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS435_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS435_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS435_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS436----
--有擔保貸款曾經bucket decrease 最高月數 - 短期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code in ('W','C','D','E') AND
      B.account_code2 in ('S', 'W', 'M')

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS436_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS436_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS436_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS436_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS437----
--有擔保貸款曾經bucket decrease 最高月數 - 中期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code in ('H','S') AND
      B.account_code2 in ('S', 'W', 'M')

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS437_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS437_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS437_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS437_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS438----
--有擔保貸款曾經bucket decrease 最高月數 - 長期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code in ('I','T') AND
      B.account_code2 in ('S', 'W', 'M')

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS438_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS438_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS438_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS438_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS439----
--無擔保貸款曾經bucket decrease 最高月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.Account_Code != 'K'

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS439_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS439_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS439_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS439_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS440----
--無擔保貸款曾經bucket decrease 最高月數 - 短期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.account_code in ('W','C', 'D', 'E')

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS440_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS440_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS440_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS440_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS441----
--無擔保貸款曾經bucket decrease 最高月數 - 中期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.account_code in ('H','S')

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS441_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS441_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS441_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS441_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS442----
--無擔保貸款曾經bucket decrease 最高月數 - 長期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.account_code in ('I','T')

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS442_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS442_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS442_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS442_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS443----
--財政部優惠貸款曾經bucket decrease 最高月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code2 in ('V','W')

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS443_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS443_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS443_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS443_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS444----
--不動產貸款曾經bucket decrease 最高月數
--Initialization rules:
--  1.) people have loans with purpose_code = '1' but no bucket decrease will be 0
--  2.) others will be null
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.purpose_code = '1'

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS444_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS444_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS444_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS444_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS445----
--動產貸款曾經bucket decrease 最高月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.purpose_code = '2'

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS445_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS445_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS445_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS445_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS446----
--週轉金貸款曾經bucket decrease 最高月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.purpose_code = '4'

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS446_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS446_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS446_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS446_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS447----
--存保單質押曾經bucket decrease 最高月數 (無擔保)
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code='K' AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.purpose_code = '4'

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS447_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS447_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS447_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS447_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS448----
--現金卡曾經bucket decrease 最高月數 (無擔保)
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code = 'Y' 

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS448_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS448_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS448_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS448_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS449----
--Co-Loan 曾經bucket decrease 最高月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.Co_Loan = 'Y'

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS449_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS449_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS449_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS449_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS450----
--在同一金融機構沒有房貸的購屋用無擔保貸款曾經bucket decrease 最高月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP
DELETE FROM FS_TMP2

INSERT INTO FS_TMP2(IDN, ISSUER)
SELECT IDN, BANK_CODE2
FROM BAM085_200411
WHERE PURPOSE_CODE = '1' AND
      account_code2 in ('S', 'W', 'M')

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      NOT EXISTS
(SELECT * FROM FS_TMP2
 WHERE B.IDN = FS_TMP2.IDN AND
       B.BANK_CODE2 = FS_TMP2.ISSUER) AND
       B.PURPOSE_CODE = '1' AND
       ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
       B.ACCOUNT_CODE != 'K'

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN
  SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS450_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS450_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS450_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS450_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO
 
----FS451----
--除在同一金融機構沒有房貸的購屋用無擔保貸款外的無擔保貸款曾經bucket decrease 最高月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP
DELETE FROM FS_TMP2

INSERT INTO FS_TMP(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.PURPOSE_CODE != 1 AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      A.Account_Code != 'K'
            
INSERT INTO FS_TMP2(IDN, ISSUER)
SELECT IDN, BANK_CODE2
FROM BAM085_200411
WHERE PURPOSE_CODE = '1' AND
      account_code2 in ('S', 'W', 'M')

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   A.BANK_CODE = B.BANK_CODE AND
   A.CONTRACT_AMT = B.CONTRACT_AMT AND
   A.DATA_YYY = B.DATA_YYY AND
   A.DATA_MM = A.DATA_MM AND
   A.ACCOUNT_CODE = B.ACCOUNT_CODE AND
   A.ACCOUNT_CODE2 = B.ACCOUNT_CODE2 AND
   A.PURPOSE_CODE = B.PURPOSE_CODE AND
   A.LOAN_AMT = B.LOAN_AMT AND
   A.PASS_DUE_AMT = B.PASS_DUE_AMT AND
    A.CO_LOAN = B.CO_LOAN
WHERE A.bucket > B.bucket AND
      EXISTS
(SELECT * FROM FS_TMP2
 WHERE B.IDN = FS_TMP2.IDN AND
       B.BANK_CODE2 = FS_TMP2.ISSUER) AND
       B.PURPOSE_CODE = '1' AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
       B.ACCOUNT_CODE != 'K'

INSERT INTO FS_TMP(IDN, MON)
SELECT IDN, MON FROM FS_TMP1
WHERE NOT EXISTS (SELECT * FROM FS_TMP 
                  WHERE FS_TMP1.IDN = FS_TMP.IDN AND
                  FS_TMP1.MON = FS_TMP.MON)
UPDATE FS_TMP
SET
V2 = A.V1
FROM FS_TMP1 AS A INNER JOIN FS_TMP AS B
ON A.IDN = B.IDN AND
   A.MON = B.MON

UPDATE FS_TMP
SET
V3 = ISNULL(V1, 0) + ISNULL(V2, 0)
      
DELETE FROM FS_TMP1
      
DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, MAX(V3)
  FROM FS_TMP
  WHERE MON >= @i
  GROUP BY IDN
  SET @i = @i - 3
END


UPDATE BAM085_FS_200411
SET
FS451_3M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS451_6M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS451_9M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS451_12M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS452----
--有擔保購屋貸款曾經bucket decrease 最高月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.PURPOSE_CODE = '1' AND
      ((B.account_code2 in ('S', 'W', 'M')) OR (B.ACCOUNT_CODE = 'K'))

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS452_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS452_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS452_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS452_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS453----
--無擔保非購屋貸款曾經bucket decrease 最高月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.PURPOSE_CODE != '1' AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      A.Account_Code != 'K'

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, MAX(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS453_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS453_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS453_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS453_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS454----
--總放款曾經bucket decrease 平均月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket 
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END
 
UPDATE BAM085_FS_200411
SET
FS454_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS454_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS454_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS454_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS455----
--有擔保貸款曾經bucket decrease 平均月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      ((B.account_code2 in ('S', 'W', 'M')) OR
     (B.Account_Code = 'K'))

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS455_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS455_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS455_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS455_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS456----
--有擔保貸款曾經bucket decrease 平均月數 - 短期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code in ('W','C','D','E') AND
      B.account_code2 in ('S', 'W', 'M')

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS456_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS456_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS456_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS456_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS457----
--有擔保貸款曾經bucket decrease 平均月數 - 中期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code in ('H','S') AND
      B.account_code2 in ('S', 'W', 'M')

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS457_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS457_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS457_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS457_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS458----
--有擔保貸款曾經bucket decrease 平均月數 - 長期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code in ('I','T') AND
      B.account_code2 in ('S', 'W', 'M')

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS458_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS458_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS458_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS458_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS459----
--無擔保貸款曾經bucket decrease 平均月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.Account_Code != 'K'

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS459_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS459_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS459_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS459_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS460----
--無擔保貸款曾經bucket decrease 平均月數 - 短期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.account_code in ('W','C', 'D', 'E')

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS460_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS460_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS460_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS460_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS461----
--無擔保貸款曾經bucket decrease 平均月數 - 中期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.account_code in ('H','S')

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS461_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS461_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS461_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS461_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS462----
--無擔保貸款曾經bucket decrease 平均月數 - 長期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.account_code in ('I','T')

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS462_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS462_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS462_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS462_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS463----
--財政部優惠貸款曾經bucket decrease 平均月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code2 in ('V','W')

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS463_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS463_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS463_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS463_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS464----
--不動產貸款曾經bucket decrease 平均月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.purpose_code = '1'

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS464_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS464_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS464_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS464_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS465----
--動產貸款曾經bucket decrease 平均月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.purpose_code = '2'

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS465_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS465_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS465_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS465_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS466----
--週轉金貸款曾經bucket decrease 平均月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.purpose_code = '4'

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS466_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS466_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS466_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS466_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS467----
--存保單質押曾經bucket decrease 平均月數 (無擔保)
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code='K' AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      B.purpose_code = '4'

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS467_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS467_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS467_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS467_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS468----
--現金卡曾經bucket decrease 平均月數 (無擔保)
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.account_code ='Y'

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS468_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS468_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS468_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS468_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS469----
--Co-Loan 曾經bucket decrease 平均月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.Co_Loan = 'Y'

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS469_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS469_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS469_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS469_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS470----
--在同一金融機構沒有房貸的購屋用無擔保貸款曾經bucket decrease 平均月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP
DELETE FROM FS_TMP2

INSERT INTO FS_TMP2(IDN, ISSUER)
SELECT IDN, BANK_CODE2
FROM BAM085_200411
WHERE PURPOSE_CODE = '1' AND
      account_code2 in ('S', 'W', 'M')

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      NOT EXISTS
(SELECT * FROM FS_TMP2
 WHERE B.IDN = FS_TMP2.IDN AND
       B.BANK_CODE2 = FS_TMP2.ISSUER) AND
       B.PURPOSE_CODE = '1' AND
       ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
       B.ACCOUNT_CODE != 'K'

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN
  SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS470_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS470_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS470_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS470_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO
 
----FS471----
--除在同一金融機構沒有房貸的購屋用無擔保貸款外的無擔保貸款曾經bucket decrease 平均月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP
DELETE FROM FS_TMP2

INSERT INTO FS_TMP(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.PURPOSE_CODE != 1 AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      A.Account_Code != 'K'
            
INSERT INTO FS_TMP2(IDN, ISSUER)
SELECT IDN, BANK_CODE2
FROM BAM085_200411
WHERE PURPOSE_CODE = '1' AND
      account_code2 in ('S', 'W', 'M')

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
   ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      EXISTS
(SELECT * FROM FS_TMP2
 WHERE B.IDN = FS_TMP2.IDN AND
       B.BANK_CODE2 = FS_TMP2.ISSUER) AND
       B.PURPOSE_CODE = '1' AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
       B.ACCOUNT_CODE != 'K'

INSERT INTO FS_TMP(IDN, MON)
SELECT IDN, MON FROM FS_TMP1
WHERE NOT EXISTS (SELECT * FROM FS_TMP 
                  WHERE FS_TMP1.IDN = FS_TMP.IDN AND
                  FS_TMP1.MON = FS_TMP.MON)
UPDATE FS_TMP
SET
V2 = A.V1
FROM FS_TMP1 AS A INNER JOIN FS_TMP AS B
ON A.IDN = B.IDN AND
   A.MON = B.MON

UPDATE FS_TMP
SET
V3 = ISNULL(V1, 0) + ISNULL(V2, 0)
      
DELETE FROM FS_TMP1
      
DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, AVG(V3)
  FROM FS_TMP
  WHERE MON >= @i
  GROUP BY IDN
  SET @i = @i - 3
END


UPDATE BAM085_FS_200411
SET
FS471_3M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS471_6M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS471_9M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS471_12M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS472----
--有擔保購屋貸款曾經bucket decrease 平均月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.PURPOSE_CODE = '1' AND
      ((B.account_code2 in ('S', 'W', 'M')) OR (B.ACCOUNT_CODE = 'K'))

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS472_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS472_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS472_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS472_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS473----
--無擔保非購屋貸款曾經bucket decrease 平均月數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

INSERT INTO FS_TMP1(IDN, MON, V1)
SELECT B.IDN, B.cycle, A.bucket - B.bucket
FROM y_BAM085_tmp_200411 AS A INNER JOIN y_BAM085_tmp_200411 AS B
ON A.IDN = B.IDN AND
   A.cycle = B.cycle - 1 AND
      ISNULL(A.BANK_CODE,'') = ISNULL(B.BANK_CODE,'') AND
   ISNULL(A.CONTRACT_AMT,0) = ISNULL(B.CONTRACT_AMT,0) AND
   ISNULL(A.DATA_YYY,'') = ISNULL(B.DATA_YYY, '') AND
   ISNULL(A.DATA_MM, '') = ISNULL(A.DATA_MM, '') AND
   ISNULL(A.ACCOUNT_CODE, '') = ISNULL(B.ACCOUNT_CODE, '') AND
   ISNULL(A.ACCOUNT_CODE2,'') = ISNULL(B.ACCOUNT_CODE2,'') AND
   ISNULL(A.PURPOSE_CODE,'') = ISNULL(B.PURPOSE_CODE,'') AND
   ISNULL(A.LOAN_AMT,0) = ISNULL(B.LOAN_AMT,0) AND
   ISNULL(A.PASS_DUE_AMT,0) = ISNULL(B.PASS_DUE_AMT,0) AND
   ISNULL(A.CO_LOAN,'') = ISNULL(B.CO_LOAN,'')
WHERE A.bucket > B.bucket AND
      B.PURPOSE_CODE != '1' AND
      ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
      A.Account_Code != 'K'

DECLARE @i INT
SET @i = 10
WHILE @i >= 1
BEGIN
  INSERT INTO FS_TMP(IDN, MON, V1)
  SELECT IDN, @i, AVG(V1)
  FROM FS_TMP1
  WHERE MON >= @i
  GROUP BY IDN  
SET @i = @i - 3
END

UPDATE BAM085_FS_200411
SET
FS473_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 10

UPDATE BAM085_FS_200411
SET
FS473_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 7
      
UPDATE BAM085_FS_200411
SET
FS473_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 4      

UPDATE BAM085_FS_200411
SET
FS473_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 1
GO

----FS474----
--繳款紀錄在X月內的總放款最多筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS474_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS474_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS474_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS474_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS475----
--繳款紀錄在X月內的總放款最多銀行數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(DISTINCT Bank_Code2)
 FROM BAM085_200411
 WHERE LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS475_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS475_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS475_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS475_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS476----
--繳款紀錄在X月內的還清最多筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE (CONVERT(INT, LOAN_AMT) = 0) AND
        (CONVERT(INT, PASS_DUE_AMT) = 0) AND
        ACCOUNT_CODE != 'Y' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END  
 
UPDATE BAM085_FS_200411
SET
FS476_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS476_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS476_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS476_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO


----FS477----
--繳款紀錄在X月內的有擔保貸款最多筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE ((account_code2 in ('S', 'W', 'M')) OR
        (Account_Code = 'K'))  AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END  
 
UPDATE BAM085_FS_200411
SET
FS477_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS477_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS477_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS477_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO


----FS478----
--繳款紀錄在X月內的有擔保貸款最多筆數 - 短期
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code in ('W','C','D','E') AND
        account_code2 in ('S', 'W', 'M') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END 
 
UPDATE BAM085_FS_200411
SET
FS478_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS478_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS478_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS478_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO


----FS479----
--繳款紀錄在X月內的有擔保貸款最多筆數 - 中期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code in ('H','S') AND
        account_code2 in ('S', 'W', 'M') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END 
 
UPDATE BAM085_FS_200411
SET
FS479_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS479_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS479_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS479_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO


----FS480----
--繳款紀錄在X月內的有擔保貸款最多筆數 - 長期
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code in ('I','T') AND
        account_code2 in ('S', 'W', 'M') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END 
 
 
UPDATE BAM085_FS_200411
SET
FS480_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS480_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS480_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS480_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS481----
--繳款紀錄在X月內的無擔保貸款最多筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code != 'K' AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END 
 
UPDATE BAM085_FS_200411
SET
FS481_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS481_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS481_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS481_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS482----
--繳款紀錄在X月內的無擔保貸款最多筆數 - 短期
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code in ('W','C', 'D', 'E') AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS482_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS482_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS482_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS482_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO


----FS483----
--繳款紀錄在X月內的無擔保貸款最多筆數 - 中期
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code in ('H','S') AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS483_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS483_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS483_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS483_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS484----
--繳款紀錄在X月內的無擔保貸款最多筆數 - 長期
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code in ('I','T') AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS484_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS484_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS484_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS484_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO


----FS485----
--繳款紀錄在X月內的逾期最多筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE Pass_Due_Amt > 0 AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS485_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS485_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS485_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS485_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO


----FS486----
--繳款紀錄在X月內的催收最多筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE  account_code = 'A' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS486_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS486_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS486_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS486_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS487----
--繳款紀錄在X月內的呆帳最多筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE  account_code = 'B' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS487_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS487_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS487_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS487_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS488----
--繳款紀錄在X月內的財政部優惠貸款最多筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code2 in ('V','W') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS488_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS488_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS488_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS488_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO


----FS489----
--繳款紀錄在X月內的不動產貸款最多筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE purpose_code = '1' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS489_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS489_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS489_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS489_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO


----FS490----
--繳款紀錄在X月內的動產貸款最多筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE purpose_code = '2' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS490_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS490_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS490_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS490_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS491----
--繳款紀錄在X月內的企業投資貸款最多筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE purpose_code = '3' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS491_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS491_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS491_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS491_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS492----
--繳款紀錄在X月內的週轉金貸款最多筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE purpose_code = '4' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS492_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS492_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS492_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS492_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO


----FS493----
--繳款紀錄在X月內的助學貸款最多筆數 (無擔保)
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code='Z' AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code = 'N')) AND
        purpose_code = '4' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS493_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS493_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS493_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS493_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO


----FS494----
--繳款紀錄在X月內的存保單質押最多筆數 (無擔保)
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code='K' AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code = 'N')) AND
        purpose_code = '4' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS494_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS494_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS494_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS494_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS495----
--繳款紀錄在X月內的現金卡最多筆數 (無擔保)
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code ='Y' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END

UPDATE BAM085_FS_200411
SET
FS495_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS495_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS495_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS495_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS496----
--繳款紀錄在X月內的Co-Loan 最多筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE CO_LOAN = 'Y' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END

UPDATE BAM085_FS_200411
SET
FS496_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS496_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS496_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS496_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS497----
--繳款紀錄在X月內的在同一金融機構沒有房貸的購屋用無擔保貸款最多筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1
DELETE FROM FS_TMP2

INSERT INTO FS_TMP2(IDN, ISSUER)
SELECT IDN, BANK_CODE2
FROM BAM085_200411
WHERE PURPOSE_CODE = '1' AND
      account_code2 in ('S', 'W', 'M')

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE NOT EXISTS
 (SELECT * FROM FS_TMP2
   WHERE BAM085_200411.IDN = FS_TMP2.IDN AND
         BAM085_200411.BANK_CODE2 = FS_TMP2.ISSUER) AND
         PURPOSE_CODE = '1' AND
         ((account_code2 is null) OR (account_code2 = '') OR (account_code = 'N')) AND
         ACCOUNT_CODE != 'K' AND
         LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, MAX(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS497_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS497_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS497_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS497_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS498----
--繳款紀錄在X月內的除在同一金融機構沒有房貸的購屋用無擔保貸款外的無擔保貸款最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP
DELETE FROM FS_TMP2

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1

WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE PURPOSE_CODE != '1' AND
       ((account_code2 is null) OR (account_code2 = '') OR (account_code = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i AND
        Account_Code != 'K'
 GROUP BY IDN
        SET @i = @i + 1
END
      
INSERT INTO FS_TMP2(IDN, ISSUER)
SELECT IDN, BANK_CODE2
FROM BAM085_200411
WHERE PURPOSE_CODE = '1' AND
      account_code2 in ('S', 'W', 'M')

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411 AS B
 WHERE EXISTS
 (SELECT * FROM FS_TMP2
         WHERE B.IDN = FS_TMP2.IDN AND
          B.BANK_CODE2 = FS_TMP2.ISSUER) AND
          B.PURPOSE_CODE = '1' AND
          ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
          B.ACCOUNT_CODE != 'K' AND
          LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
 GROUP BY IDN  
 SET @i = @i + 1
END

INSERT INTO FS_TMP(IDN, MON)
SELECT IDN, MON FROM FS_TMP1
WHERE NOT EXISTS (SELECT * FROM FS_TMP 
                  WHERE FS_TMP1.IDN = FS_TMP.IDN AND
                  FS_TMP1.MON = FS_TMP.MON)
UPDATE FS_TMP
SET
V2 = A.V1
FROM FS_TMP1 AS A INNER JOIN FS_TMP AS B
ON A.IDN = B.IDN AND
   A.MON = B.MON

UPDATE FS_TMP
SET
V3 = ISNULL(V1, 0) + ISNULL(V2, 0)
      
DELETE FROM FS_TMP1
      
SET @i = 3
WHILE @i <= 12
BEGIN
  INSERT INTO FS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, MAX(V3)
  FROM FS_TMP
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END

UPDATE BAM085_FS_200411
SET
FS498_3M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS498_6M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS498_9M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS498_12M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS499----
--繳款紀錄在X月內的有擔保購屋貸款最多筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1


WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE PURPOSE_CODE = '1' AND
         ((account_code2 in ('S', 'W', 'M')) OR (ACCOUNT_CODE = 'K')) AND
       LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
        GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
INSERT INTO FS_TMP(IDN, MON, V1)
SELECT IDN, @i, MAX(V1)
FROM FS_TMP1
WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END

UPDATE BAM085_FS_200411
SET
FS499_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS499_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS499_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS499_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS500----
--繳款紀錄在X月內的無擔保非購屋貸款最多筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1

WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE PURPOSE_CODE != '1' AND
       ((account_code2 is null) OR (account_code2 = '') OR (account_code = 'N')) AND
       LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i AND
        Account_Code != 'K'
        GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
INSERT INTO FS_TMP(IDN, MON, V1)
SELECT IDN, @i, MAX(V1)
FROM FS_TMP1
WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END

UPDATE BAM085_FS_200411
SET
FS500_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS500_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS500_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS500_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS501----
--繳款紀錄在X月內的總放款平均筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS501_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS501_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS501_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS501_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS502----
--繳款紀錄在X月內的總放款平均銀行數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(DISTINCT Bank_Code2)
 FROM BAM085_200411
 WHERE LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS502_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS502_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS502_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS502_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS503----
--繳款紀錄在X月內的還清平均筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE (CONVERT(INT, LOAN_AMT) = 0) AND
        (CONVERT(INT, PASS_DUE_AMT) = 0) AND
        ACCOUNT_CODE != 'Y' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END  
 
UPDATE BAM085_FS_200411
SET
FS503_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS503_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS503_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS503_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS504----
--繳款紀錄在X月內的有擔保貸款平均筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE ((account_code2 in ('S', 'W', 'M')) OR
        (Account_Code = 'K'))  AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END  
 
UPDATE BAM085_FS_200411
SET
FS504_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS504_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS504_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS504_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS505----
--繳款紀錄在X月內的有擔保貸款平均筆數 - 短期
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code in ('W','C','D','E') AND
        account_code2 in ('S', 'W', 'M') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END 
 
UPDATE BAM085_FS_200411
SET
FS505_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS505_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS505_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS505_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS506----
--繳款紀錄在X月內的有擔保貸款平均筆數 - 中期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code in ('H','S') AND
        account_code2 in ('S', 'W', 'M') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END 
 
UPDATE BAM085_FS_200411
SET
FS506_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS506_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS506_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS506_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS507----
--繳款紀錄在X月內的有擔保貸款平均筆數 - 長期
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code in ('I','T') AND
        account_code2 in ('S', 'W', 'M') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END 
 
 
UPDATE BAM085_FS_200411
SET
FS507_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS507_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS507_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS507_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS508----
--繳款紀錄在X月內的無擔保貸款平均筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code != 'K' AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END 
 
UPDATE BAM085_FS_200411
SET
FS508_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS508_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS508_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS508_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS509----
--繳款紀錄在X月內的無擔保貸款平均筆數 - 短期
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code in ('W','C', 'D', 'E') AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS509_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS509_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS509_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS509_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS510----
--繳款紀錄在X月內的無擔保貸款平均筆數 - 中期
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code in ('H','S') AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS510_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS510_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS510_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS510_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS511----
--繳款紀錄在X月內的無擔保貸款平均筆數 - 長期
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code in ('I','T') AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS511_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS511_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS511_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS511_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS512----
--繳款紀錄在X月內的逾期平均筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE Pass_Due_Amt > 0 AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS512_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS512_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS512_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS512_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS513----
--繳款紀錄在X月內的催收平均筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE  account_code = 'A' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS513_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS513_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS513_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS513_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS514----
--繳款紀錄在X月內的呆帳平均筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE  account_code = 'B' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS514_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS514_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS514_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS514_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS515----
--繳款紀錄在X月內的財政部優惠貸款平均筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code2 in ('V','W') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS515_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS515_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS515_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS515_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS516----
--繳款紀錄在X月內的不動產貸款平均筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE purpose_code = '1' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS516_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS516_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS516_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS516_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS517----
--繳款紀錄在X月內的動產貸款平均筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE purpose_code = '2' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS517_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS517_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS517_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS517_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS518----
--繳款紀錄在X月內的企業投資貸款平均筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE purpose_code = '3' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS518_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS518_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS518_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS518_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS519----
--繳款紀錄在X月內的週轉金貸款平均筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE purpose_code = '4' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS519_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS519_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS519_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS519_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS520----
--繳款紀錄在X月內的助學貸款平均筆數 (無擔保)
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code='Z' AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code = 'N')) AND
        purpose_code = '4' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS520_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS520_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS520_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS520_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO


----FS521----
--繳款紀錄在X月內的存保單質押平均筆數 (無擔保)
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code='K' AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code = 'N')) AND
        purpose_code = '4' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS521_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS521_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS521_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS521_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO


----FS522----
--繳款紀錄在X月內的現金卡平均筆數 (無擔保)
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code = 'Y' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END

UPDATE BAM085_FS_200411
SET
FS522_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS522_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS522_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS522_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS523----
--繳款紀錄在X月內的Co-Loan 平均筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE CO_LOAN = 'Y' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END

UPDATE BAM085_FS_200411
SET
FS523_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS523_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS523_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS523_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS524----
--繳款紀錄在X月內的在同一金融機構沒有房貸的購屋用無擔保貸款平均筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1
DELETE FROM FS_TMP2

INSERT INTO FS_TMP2(IDN, ISSUER)
SELECT IDN, BANK_CODE2
FROM BAM085_200411
WHERE PURPOSE_CODE = '1' AND
      account_code2 in ('S', 'W', 'M')

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE NOT EXISTS
 (SELECT * FROM FS_TMP2
   WHERE BAM085_200411.IDN = FS_TMP2.IDN AND
         BAM085_200411.BANK_CODE2 = FS_TMP2.ISSUER) AND
         PURPOSE_CODE = '1' AND
         ((account_code2 is null) OR (account_code2 = '') OR (account_code = 'N')) AND
         ACCOUNT_CODE != 'K' AND
         LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, AVG(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS524_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS524_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS524_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS524_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS525----
--繳款紀錄在X月內的除在同一金融機構沒有房貸的購屋用無擔保貸款外的無擔保貸款平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP
DELETE FROM FS_TMP2

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1

WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE PURPOSE_CODE != '1' AND
       ((account_code2 is null) OR (account_code2 = '') OR (account_code = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i AND
        Account_Code != 'K'
 GROUP BY IDN
        SET @i = @i + 1
END
      
INSERT INTO FS_TMP2(IDN, ISSUER)
SELECT IDN, BANK_CODE2
FROM BAM085_200411
WHERE PURPOSE_CODE = '1' AND
      account_code2 in ('S', 'W', 'M')

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411 AS B
 WHERE EXISTS
 (SELECT * FROM FS_TMP2
  WHERE B.IDN = FS_TMP2.IDN AND
         B.BANK_CODE2 = FS_TMP2.ISSUER) AND
           B.PURPOSE_CODE = '1' AND
             ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
             B.ACCOUNT_CODE != 'K' AND
             LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
 GROUP BY IDN  
 SET @i = @i + 1
END

INSERT INTO FS_TMP(IDN, MON)
SELECT IDN, MON FROM FS_TMP1
WHERE NOT EXISTS (SELECT * FROM FS_TMP 
                  WHERE FS_TMP1.IDN = FS_TMP.IDN AND
                  FS_TMP1.MON = FS_TMP.MON)

UPDATE FS_TMP
SET
V2 = A.V1
FROM FS_TMP1 AS A INNER JOIN FS_TMP AS B
ON A.IDN = B.IDN AND
   A.MON = B.MON

UPDATE FS_TMP
SET
V3 = ISNULL(V1,0) + ISNULL(V2,0)
      
DELETE FROM FS_TMP1
      
SET @i = 3
WHILE @i <= 12
BEGIN
  INSERT INTO FS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, AVG(V3)
  FROM FS_TMP
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END

UPDATE BAM085_FS_200411
SET
FS525_3M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS525_6M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS525_9M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS525_12M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS526----
--繳款紀錄在X月內的有擔保購屋貸款平均筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1

WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE PURPOSE_CODE = '1' AND
       ((account_code2 in ('S', 'W', 'M')) OR (ACCOUNT_CODE = 'K')) AND
       LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
        GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
INSERT INTO FS_TMP(IDN, MON, V1)
SELECT IDN, @i, AVG(V1)
FROM FS_TMP1
WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END

UPDATE BAM085_FS_200411
SET
FS526_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS526_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS526_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS526_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS527----
--繳款紀錄在X月內的無擔保非購屋貸款平均筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1

WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE PURPOSE_CODE != '1' AND
         ((account_code2 is null) OR (account_code2 = '') OR (account_code = 'N')) AND
       LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i AND
        Account_Code != 'K'
        GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
INSERT INTO FS_TMP(IDN, MON, V1)
SELECT IDN, @i, AVG(V1)
FROM FS_TMP1
WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END

UPDATE BAM085_FS_200411
SET
FS527_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS527_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS527_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS527_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS528----
--繳款紀錄在X月內的總放款總筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS528_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS528_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS528_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS528_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS529----
--繳款紀錄在X月內的總放款總銀行數
DELETE FROM FS_TMP

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 3
WHILE @i <= 9
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, COUNT(DISTINCT BANK_CODE2)
 FROM BAM085_200411
 WHERE LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) <= @i
GROUP BY IDN 
SET @i = @i + 3
END

INSERT INTO FS_TMP(IDN, MON, V1)
SELECT IDN, 11, COUNT(DISTINCT BANK_CODE2)
FROM BAM085_200411
WHERE LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) <= 11
GROUP BY IDN 

UPDATE BAM085_FS_200411
SET
FS529_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS529_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS529_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS529_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 11
GO

----FS530----
--繳款紀錄在X月內的還清總筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE (CONVERT(INT, LOAN_AMT) = 0) AND
        (CONVERT(INT, PASS_DUE_AMT) = 0) AND
        ACCOUNT_CODE != 'Y' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END  
 
UPDATE BAM085_FS_200411
SET
FS530_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS530_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS530_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS530_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS531----
--繳款紀錄在X月內的有擔保貸款總筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE ((account_code2 in ('S', 'W', 'M')) OR
        (Account_Code = 'K'))  AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END  
 
UPDATE BAM085_FS_200411
SET
FS531_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS531_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS531_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS531_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS532----
--繳款紀錄在X月內的有擔保貸款總筆數 - 短期
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code in ('W','C','D','E') AND
        account_code2 in ('S', 'W', 'M') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END 
 
UPDATE BAM085_FS_200411
SET
FS532_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS532_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS532_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS532_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS533----
--繳款紀錄在X月內的有擔保貸款總筆數 - 中期
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code in ('H','S') AND
        account_code2 in ('S', 'W', 'M') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END 
 
UPDATE BAM085_FS_200411
SET
FS533_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS533_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS533_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS533_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS534----
--繳款紀錄在X月內的有擔保貸款總筆數 - 長期
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code in ('I','T') AND
        account_code2 in ('S', 'W', 'M') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END 
 
 
UPDATE BAM085_FS_200411
SET
FS534_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS534_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS534_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS534_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS535----
--繳款紀錄在X月內的無擔保貸款總筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1
 
DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code != 'K' AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END 
 
UPDATE BAM085_FS_200411
SET
FS535_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS535_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS535_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS535_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS536----
--繳款紀錄在X月內的無擔保貸款總筆數 - 短期
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code in ('W','C', 'D', 'E') AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS536_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS536_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS536_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS536_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS537----
--繳款紀錄在X月內的無擔保貸款總筆數 - 中期
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code in ('H','S') AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS537_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS537_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS537_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS537_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS538----
--繳款紀錄在X月內的無擔保貸款總筆數 - 長期
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code in ('I','T') AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS538_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS538_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS538_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS538_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS539----
--繳款紀錄在X月內的逾期總筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE Pass_Due_Amt > 0 AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS539_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS539_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS539_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS539_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS540----
--繳款紀錄在X月內的催收總筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE  account_code = 'A' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS540_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS540_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS540_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS540_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS541----
--繳款紀錄在X月內的呆帳總筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE  account_code = 'B' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS541_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS541_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS541_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS541_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS542----
--繳款紀錄在X月內的財政部優惠貸款總筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code2 in ('V','W') AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS542_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS542_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS542_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS542_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS543----
--繳款紀錄在X月內的不動產貸款總筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE purpose_code = '1' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS543_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS543_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS543_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS543_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS544----
--繳款紀錄在X月內的動產貸款總筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE purpose_code = '2' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS544_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS544_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS544_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS544_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS545----
--繳款紀錄在X月內的企業投資貸款總筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE purpose_code = '3' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS545_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS545_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS545_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS545_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS546----
--繳款紀錄在X月內的週轉金貸款總筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE purpose_code = '4' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS546_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS546_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS546_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS546_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS547----
--繳款紀錄在X月內的助學貸款總筆數 (無擔保)
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code='Z' AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code = 'N')) AND
        purpose_code = '4' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS547_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS547_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS547_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS547_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO


----FS548----
--繳款紀錄在X月內的存保單質押總筆數 (無擔保)
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code='K' AND
        ((account_code2 is null) OR (account_code2 = '') OR (account_code = 'N')) AND
        purpose_code = '4' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS548_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS548_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS548_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS548_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO


----FS549----
--繳款紀錄在X月內的現金卡總筆數 (無擔保)
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE account_code = 'Y' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END

UPDATE BAM085_FS_200411
SET
FS549_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS549_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS549_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS549_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS550----
--繳款紀錄在X月內的Co-Loan 總筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE CO_LOAN = 'Y' AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END

UPDATE BAM085_FS_200411
SET
FS550_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS550_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS550_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS550_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS551----
--繳款紀錄在X月內的在同一金融機構沒有房貸的購屋用無擔保貸款總筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1
DELETE FROM FS_TMP2

INSERT INTO FS_TMP2(IDN, ISSUER)
SELECT IDN, BANK_CODE2
FROM BAM085_200411
WHERE PURPOSE_CODE = '1' AND
      account_code2 in ('S', 'W', 'M')

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE NOT EXISTS
 (SELECT * FROM FS_TMP2
   WHERE BAM085_200411.IDN = FS_TMP2.IDN AND
         BAM085_200411.BANK_CODE2 = FS_TMP2.ISSUER) AND
         PURPOSE_CODE = '1' AND
         ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
         ACCOUNT_CODE != 'K' AND
         LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, SUM(V1)
 FROM FS_TMP1
 WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END
 
UPDATE BAM085_FS_200411
SET
FS551_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS551_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS551_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS551_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS552----
--繳款紀錄在X月內的除在同一金融機構沒有房貸的購屋用無擔保貸款外的無擔保貸款總筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP
DELETE FROM FS_TMP2

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1

WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE PURPOSE_CODE != '1' AND
       ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
        LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i AND
        Account_Code != 'K'
 GROUP BY IDN
        SET @i = @i + 1
END
      
INSERT INTO FS_TMP2(IDN, ISSUER)
SELECT IDN, BANK_CODE2
FROM BAM085_200411
WHERE PURPOSE_CODE = '1' AND
      account_code2 in ('S', 'W', 'M')

SET @i = 1
WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411 AS B
 WHERE EXISTS
 (SELECT * FROM FS_TMP2
  WHERE B.IDN = FS_TMP2.IDN AND
         B.BANK_CODE2 = FS_TMP2.ISSUER) AND
           B.PURPOSE_CODE = '1' AND
             ((B.account_code2 is null) OR (B.account_code2 = '') OR (B.account_code = 'N')) AND
             B.ACCOUNT_CODE != 'K' AND
             LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
 GROUP BY IDN  
 SET @i = @i + 1
END

INSERT INTO FS_TMP(IDN, MON)
SELECT IDN, MON FROM FS_TMP1
WHERE NOT EXISTS (SELECT * FROM FS_TMP 
                  WHERE FS_TMP1.IDN = FS_TMP.IDN AND
                  FS_TMP1.MON = FS_TMP.MON)

UPDATE FS_TMP
SET
V2 = A.V1
FROM FS_TMP1 AS A INNER JOIN FS_TMP AS B
ON A.IDN = B.IDN AND
   A.MON = B.MON

UPDATE FS_TMP
SET
V3 = ISNULL(V1, 0) + ISNULL(V2, 0)

DELETE FROM FS_TMP1

SET @i = 3
WHILE @i <= 12
BEGIN
  INSERT INTO FS_TMP1(IDN, MON, V1)
  SELECT IDN, @i, SUM(V3)
  FROM FS_TMP
  WHERE MON <= @i
  GROUP BY IDN
  SET @i = @i + 3
END

UPDATE BAM085_FS_200411
SET
FS552_3M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS552_6M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS552_9M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS552_12M = V1
FROM FS_TMP1 AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS553----
--繳款紀錄在X月內的有擔保購屋貸款總筆數
DELETE FROM FS_TMP
DELETE FROM FS_TMP1

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1

WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE PURPOSE_CODE = '1' AND
       ((account_code2 in ('S', 'W', 'M')) OR (ACCOUNT_CODE = 'K')) AND
       LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i
        GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
INSERT INTO FS_TMP(IDN, MON, V1)
SELECT IDN, @i, SUM(V1)
FROM FS_TMP1
WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END

UPDATE BAM085_FS_200411
SET
FS553_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS553_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS553_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS553_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO

----FS554----
--繳款紀錄在X月內的無擔保非購屋貸款總筆數
DELETE FROM FS_TMP1
DELETE FROM FS_TMP

DECLARE @i INT
DECLARE @now INT
SET @now = 93 * 12 + 11

SET @i = 1

WHILE @i <= 11
BEGIN
 INSERT INTO FS_TMP1(IDN, MON, V1)
 SELECT IDN, @i, COUNT(*)
 FROM BAM085_200411
 WHERE PURPOSE_CODE != '1' AND
       ((account_code2 is null) OR (account_code2 = '') OR (account_code2 = 'N')) AND
       LEN(LTRIM(RTRIM(PAY_CODE_12))) + @now - 1 - cast(isnull(data_yyy, 0) as int) * 12 - cast(isnull(data_mm, 0) as int) = @i AND
        Account_Code != 'K'
        GROUP BY IDN
SET @i = @i + 1      
END

SET @i = 3
WHILE @i <= 12
BEGIN
INSERT INTO FS_TMP(IDN, MON, V1)
SELECT IDN, @i, SUM(V1)
FROM FS_TMP1
WHERE MON <= @i
GROUP BY IDN 
SET @i = @i + 3
END

UPDATE BAM085_FS_200411
SET
FS554_3M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 3

UPDATE BAM085_FS_200411
SET
FS554_6M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 6
      
UPDATE BAM085_FS_200411
SET
FS554_9M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 9
      
UPDATE BAM085_FS_200411
SET
FS554_12M = V1
FROM FS_TMP AS A
WHERE A.IDN = BAM085_FS_200411.IDN AND
      A.MON = 12
GO
 