CREATE TABLE REPORT_BASE(
APP_SN NVARCHAR(10), APP_DATA_TIME CHAR(14), TSN CHAR(12), DECISION_TIME CHAR(14), JCIC_DATE CHAR(8), TS_DATA_DATE CHAR(8),
PROMOTION_CODE NVARCHAR(10), SALES_REGION NVARCHAR(20), SALES_UNIT VARCHAR(20), SALES_USERNO NVARCHAR(10),
ADD_LOAN NVARCHAR(10), PRESCREEN_CODE INT,
PB DECIMAIL(4,3), APPLICATION_AMOUNT INT,
MODULE_AMOUNT INT, MODULE_NPV INT, MODULE_DECISION INT,
DECISION_AMOUNT INT, DECISION_NPV INT, FINAL_DECISION INT)
GO

CREATE TABLE TMP(
APP_SN NVARCHAR(10), V1 VARCHAR(14), V2 VARCHAR(14), V3 VARCHAR(12), V4 VARCHAR(8), V5 CHAR(8))
GO
CREATE TABLE TMP1(
APP_SN NVARCHAR(10), V1 VARCHAR(14), V2 VARCHAR(14), V3 VARCHAR(12), V4 VARCHAR(8))
GO
CREATE TABLE TMP2(
APP_SN NVARCHAR(10), V1 VARCHAR(14), V2 VARCHAR(14), V3 VARCHAR(12), V4 VARCHAR(8))
GO

INSERT INTO REPORT_BASE(APP_SN, APP_DATA_TIME)
SELECT APP_SN, MAX(DATA_TIME)
FROM APP_INFO
WHERE (LEFT(DATA_TIME, 8) BETWEEN :BEG_TIME AND :END_TIME) AND
      PRODUCT_TYPE :PRODUCT
GROUP BY APP_SN
GO

INSERT INTO TMP(APP_SN, V3)
SELECT APP_SN, MAX(TSN)
FROM LOAN_CONDITION
WHERE APP_SN IN (SELECT APP_SN FROM REPORT_BASE)
GROUP BY APP_SN
GO

UPDATE REPORT_BASE
SET
TSN = A.V3
FROM TMP AS A INNER JOIN REPORT_BASE AS B
ON A.APP_SN = B.APP_SN
GO

DELETE FROM TMP
GO

INSERT INTO TMP(APP_SN, V3)
SELECT APP_SN, MAX(TSN)
FROM APPROVAL_CAL
WHERE (LEFT(DATA_TIME, 8) BETWEEN :BEG_TIME AND :END_TIME) AND
      PRODUCT_TYPE :PRODUCT
GROUP BY APP_SN
GO

INSERT INTO TMP1(APP_SN, V1, V3)
SELECT A.APP_SN, MAX(DATA_DATE), V3
FROM TMP AS A INNER JOIN APPROVAL_CAL AS B
ON A.APP_SN = B.APP_SN AND
   A.V3 = B.TSN
WHERE (LEFT(DATA_TIME, 8) BETWEEN :BEG_TIME AND :END_TIME) AND
      PRODUCT_TYPE :PRODUCT
GROUP BY A.APP_SN, B.TSN
GO

INSERT INTO TMP2(APP_SN, V1, V3, V4)
SELECT A.APP_SN, V1, V3, MAX(JCIC_DATA_DATE)
FROM TMP1 AS A INNER JOIN APPROVAL_CAL AS B
ON A.APP_SN = B.APP_SN AND
   A.V1 = B.DATA_TIME AND
   A.V3 = B.TSN
WHERE (LEFT(DATA_TIME, 8) BETWEEN :BEG_TIME AND :END_TIME) AND
      PRODUCT_TYPE :PRODUCT
GROUP BY A.APP_SN, B.TSN, B.DATA_TIME
GO

UPDATE REPORT_BASE
SET
TSN = A.V3,
DATA_TIME = A.V1,
JCIC_DATE = A.V4
FROM TMP2 AS A INNER JOIN REPORT_BASE AS B
ON A.APP_SN = B.APP_SN
GO

DELETE FROM TMP
GO
DELETE FROM TMP1
GO
DELETE FROM TMP2
GO  

INSERT INTO TMP(APP_SN, V2)
SELECT APP_SN, MAX(EXECUTION_TIME)
FROM DECISION_CAL
WHERE (LEFT(DATA_TIME, 8) BETWEEN :BEG_TIME AND :END_TIME) AND
      PRODUCT_TYPE :PRODUCT
GROUP BY APP_SN
GO

UPDATE TMP
SET
V1 = A.APP_DATA_TIME,
V3 = A.TSN,
V4 = A.JCIC_DATA_DATE
FROM DECISION_CAL AS A INNER JOIN TMP AS B
ON A.APP_SN = B.APP_SN AND
   A.EXECUTION_TIME = B.V2
GO

UPDATE REPORT_BASE
SET
APP_DATA_TIME = A.V1,
EXECUTION_TIME = A.V2,
TSN = A.V3,
JCIC_DATA_DATE = A.V4
FROM TMP AS A INNER JOIN REPORT_BASE AS B
ON A.APP_SN = B.APP_SN
GO

DELETE FROM TMP1
GO

INSERT INTO TMP1(APP_SN, V4)
SELECT A.APP_SN, MAX(TS_DATA_DATE)
FROM APPROVAL_CAL AS A INNER JOIN TMP AS B
ON A.APP_SN = B.APP_SN AND
   A.DATA_DATE = B.V1 AND
   A.TSN = B.V3 AND
   A.JCIC_DATA_DATE = B.V4 
GO

UPDATE REPORT_BASE
SET
TS_DATA_DATE = A.V5
FROM TMP AS A INNER JOIN REPORT_BASE AS B
ON B.APP_SN = A.APP_SN AND
   B.APP_DATA_DATE = A.V1 AND
   B.TSN = A.V3 AND
   B.JCIC_DATA_DATE = A.V4 
GO

UPDATE REPORT_BASE
SET
PROMOTION_CODE = A.PROMOTION_CODE, 
SALES_REGION = A.SALES_REGION, 
SALES_UNIT = A.SALES_UNIT, 
SALES_USERNO =A.SALES_USERNO,
ADD_LOAN = A.ADD_LOAN
FROM APP_INFO AS A INNER JOIN REPORT_BASE AS B
ON A.APP_SN = B.APP_SN AND
   A.DATA_TIME = B.APP_DATA_TIME
GO

UPDATE REPORT_BASE
SET
APPLICATION_AMOUNT = A.LOAN_AMOUNT
FROM LOAN_CONDITION AS A INNER JOIN REPORT_BASE AS B
ON A.APP_SN = B.APP_SN AND
   A.TSN = B.TSN
GO

UPDATE REPORT_BASE
SET
PRESCREEN_CODE = A.REASON_CODE
FROM PRESCREEN AS A INNER JOIN REPORT_BASE
WHERE A.APP_SN = B.APP_SN AND
      A.JCIC_DATA_DATE = B.JCIC_DATA_DATE AND
      A.APP_DATA_DATE = B.APP_DATA_DATE
GO

UPDATE REPORT_BASE
SET
MODULE_AMOUNT = (CASE WHEN A.OPTIMAL_AMOUNT IS NULL THEN A.SPECIFIC_LENDING_AMOUNT ELSE A.OPTIMAL_AMOUNT END), 
MODULE_NPV = A.NPV, 
MODULE_DECISION = REASON_CODE,
PB = A.PB 
FROM APPROVAL_CAL AS A INNER JOIN REPORT_BASE AS B
ON A.APP_SN = B.APP_SN AND
   A.TSN = B.TSN AND
   A.DATA_TIME = B.APP_DATA_TIME AND
   A.JCIC_DATA = B.JCIC_DATE AND
   A.TS_DATA_DATE = B.TS_DATA_DATE
G0   

UPDATE REPORT_BASE
SET
DECISION_AMOUNT = A.APPROVED_AMOUNT, 
DECISION_NPV = A.NPV, 
FINAL_DECISION = A.DECISION,
PB = A.PB   
FROM DECISION_CAL AS A INNER JOIN REPORT_BASE AS B
ON A.APP_SN = B.APP_SN AND
   A.EXECUTION_TIME = B.EXECUTION_TIME
GO

