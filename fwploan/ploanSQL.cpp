//---------------------------------------------------------------------------
#pragma hdrstop

#include "ploanSQL.h"

//---------------------------------------------------------------------------
#pragma package(smart_init)
//---------------------------------------------------------------------------
/*
The sql comment, --, can not be used in a string. or the multiple lines of
   comment enclosed within a pair of a slash and a star and a pair of a star and a slash
   can not be used either.
*/
char *SQLCommands[] = {
/* Get_AppInfo_Record */
" select case_sn, idn, dac_sn, ltrim(rtrim(application_date)) as application_date, "
"  ltrim(rtrim(inquiry_date)) as inquiry_date, product_code, project_source, case_source, recommender,"
"  guarantor, principal, repayment, periods, grace_period, num_int_period, appropriation, zip, ltrim(rtrim(segment)) as segment,"
"  application_fee, risk_mgmt_fee, acct_mgmt_fee, bt_fee, early_close_period, ever_bad_check, ever_reject"
" from app_info"
" where case_sn = :v0 and idn = :v1 and dac_sn = :v2;",

/* Get_AppI_Record */
" select case_sn, idn, dac_sn, seq, apr, periods"
"  from app_i"
" where case_sn = :v0 and idn = :v1 and dac_sn = :v2 order by seq;",

/* Get_Maintenance_Record*/
" select cof, roe, query_fee, leverage_ratio, commission_ratio, m1_recovery_ratio,"
"   m1_avg_late_days, m1_penalty_rate, m6_recovery_ratio, m6_avg_late_days,"
"   m6_penalty_rate, early_closing_fee_pct, early_closing_fee_collectable_ratio,"
"   early_closing_period, acquisition_data_cost, acct_mgmt_cost, short_message_expense,"
"   phone_expense_north, phone_expense_central, phone_expense_south, legal_exec_north,"
"   legal_query_north, legal_detain_ratio_north, legal_auction_north, legal_staff_north,"
"   legal_exec_central, legal_query_central, legal_detain_ratio_central,"
"   legal_auction_central, legal_staff_central, legal_exec_south, legal_query_south,"
"   legal_detain_ratio_south, legal_auction_south, legal_staff_south, recovery_ratio,"
"   legal_action_period"
"  from ploan_maintenance",

/*Get_Filter_Result*/
" select idn, avail_flag, jas002_defect, krm021_hit, krm023_hit, max_bucket, fs044, cash_max_bucket, cash_utilization, ind001"
"  from #base"
" where idn = :v1",

/*Write_PreFilter_Result*/
" insert into ploan_result(case_sn, idn, dac_sn, application_date, return_msg, checksum1, checksum2, ev, pb)"
"  values (:v0, :v1, :v2, :v3, :v4, :v5, :v5, NULL, NULL);",

/*Write_PLoan_Result*/
" insert into ploan_result(case_sn, idn, dac_sn, application_date,  return_msg, ev, pb, checksum1, checksum2)"
"  values (:v0, :v1, :v2, :v3, :v4, %16.2f, %10.6f, %10.6f, %10.6f);",

/*Get_PD*/
" select riskscore, pd"
"  from #daco_v41_cal",
/*Get_Ploan_PD*/
" select [new_pd], [new_pd]"
"  from PLNPV2 where idn = :v0;",

/* jcic data preparation for a idn */
/* Create_Working_Tables */
" create table #bam085_dedup ("
" 	case_sn char(12),"
" 	idn char (11),"
" 	dac_sn decimal(3,0),"
" 	data_yyy char (3),"
" 	data_mm char (2),"
" 	bank_code char (7),"
" 	bank_name char (40),"
" 	account_code char (1),"
" 	account_code2 char (1),"
" 	purpose_code char (1),"
" 	contract_amt decimal (10),"
" 	loan_amt decimal (10),"
" 	pass_due_amt decimal (10),"
" 	pay_code_12 char (12),"
" 	co_loan char (1),"
" 	bank_code2 char (3),"
" 	cnt int"
" );"
" create table #krm021_dedup ("
" 	case_sn char(12),"
" 	idn char (11),"
" 	dac_sn decimal(3,0),"
" 	card_brand char (1),"
" 	card_type char (1),"
" 	issue char (3),"
" 	issue_name char (40),"
" 	start_date char (7),"
" 	stop_date char (7),"
" 	stop_code char (1),"
" 	ab_code char (1),"
" 	m_s char (1),"
" 	limit char (6),"
" 	start_mon_since int,"
" 	end_mon_since int,"
" 	cnt int"
" );"
" create table #krm023_dedup ("
" 	case_sn char(12),"
" 	idn char (11),"
" 	dac_sn decimal(3,0),"
" 	issue char (3),"
" 	issue_name char (40),"
" 	limit char (6),"
" 	yrmon char (5),"
" 	kr_code char (7),"
" 	payment char (3),"
" 	cash char (1),"
" 	pay_code char (1),"
" 	mon_since int,"
" 	payment_amt float,"
" 	bucket_def_1k int default 0,"
" 	bucket_ef_1k int default 0,"
" 	bucket_f_1k int default 0,"
" 	cnt int"
" );"
" create table #stm001_dedup ("
" 	case_sn char(12),"
" 	idn char (11),"
" 	dac_sn decimal(3,0),"
" 	bank_code char (7),"
" 	bank_name char (40),"
" 	query_date char (7),"
" 	item_list char (10),"
" 	query_mon_since int,"
" 	cnt int"
" );"
" create table #stm002_dedup ("
" 	case_sn char(12),"
" 	idn char (11),"
" 	dac_sn decimal(3,0),"
" 	query_date char (7),"
" 	bank_code char (7),"
" 	bank_name char (40),"
" 	query_item char (3),"
" 	query_mon_since int,"
" 	cnt int"
" );"
" create table #jas002_t ("
" 	case_sn char(12),"
" 	idn char (11),"
" 	dac_sn decimal(3,0),"
" 	reason char (1),"
" 	date_happen char (7),"
" 	mon_since int"
" );"
" create table #jas002_t_dedup ("
" 	case_sn char(12),"
" 	idn char (11),"
" 	dac_sn decimal(3,0),"
" 	reason char (1),"
" 	date_happen char (7),"
" 	mon_since int,"
" 	cnt int"
" );"
" create table #base ("
"  	idn char (11),"
" 	avail_flag int default 0,"
" 	jas002_defect int default 0,"
" 	krm021_hit int default 0,"
" 	krm023_hit int default 0,"
" 	max_bucket int default 0,"
" 	fs044 int default 0,"
" 	cash_max_bucket int default 0,"
" 	cash_utilization int default 0,"
"       ind001 int default 0"
" );"
"   create table #daco_v41_cal ("
"    case_sn		char(12),"
"    idn		char(11),"
"    dac_sn		decimal(3,0),"
"    inquiry_date	char(8),"
"    guarantor		char(1),"
"    sex		int,"
"    segment		varchar(7),"
"    apr_group		int,"
"    now		int,"
"    avail_flag		int,"
"    jas002_defect	int,"
"    krm021_hit		int,"
"    krm023_hit		int,"
"    max_bucket		int,"
"    fs044		int,"
"    cash_max_bucket	int,"
"    cash_utilization	int,"
"    ind001		int,"
"/* DACO4.1 variables*/"
"    ms056_6m_1k	decimal (16, 8),"
"    ms056_6m_1k_tran	decimal (16, 8),"
"    ms110_3m		decimal (16, 8),"
"    ms110_6m		decimal (16, 8),"
"    ms106_3m		decimal (16, 8),"
"    ms106_6m		decimal (16, 8),"
"    mt110_43		decimal (16, 8),"
"    mt110_43_tran	decimal (16, 8),"
"    fs002_6m_1k	decimal (16, 8),"
"    fs002_6m_1k_q	decimal (16, 8),"
"    fs002_6m_1k_q_tran	decimal (16, 8),"
"    fs016_9m		decimal (16, 8),"
"    fs101_9m		decimal (16, 8),"
"    fs040		decimal (16, 8),"
"    fs068		decimal (16, 8),"
"    fs069		decimal (16, 8),"
"    fs069_tran		decimal (16, 8),"
"    int015_9m		decimal (16, 8),"
"    int015_9m_tran	decimal (16, 8),"
"    fs031		decimal (16, 8),"
"    fs031_tran		decimal (16, 8),"
"    ms203_3m_1k	decimal (16, 8),"
"    ms203_6m_1k	decimal (16, 8),"
"    ms203_9m_1k	decimal (16, 8),"
"    mt203_42_1k	decimal (16, 8),"
"    mt203_42_1k_r	decimal (16, 8),"
"    mt203_42_1k_r_tran	decimal (16, 8),"
"    app_last_month_bucket	decimal (16, 8),"
"    app_last_month_bucket_t1	decimal (16, 8),"
"    fs008_12mplus	decimal (16, 8),"
"    fs008_12mplus_r	decimal (16, 8),"
"    fs008_12mplus_r_tran decimal (16, 8),"
"    ms011_3m		decimal (16, 8),"
"    ms011_6m		decimal (16, 8),"
"    ms011_9m		decimal (16, 8),"
"    ms011_12m		decimal (16, 8),"
"    mt011_31		decimal (16, 8),"
"    mt011_31_z		decimal (16, 8),"
"    ms009_3m		decimal (16, 8),"
"    ms009_6m		decimal (16, 8),"
"    mt009_43		decimal (16, 8),"
"    mt009_43_q		decimal (16, 8),"
"    mt009_43_q_tran2	decimal (16, 8),"
"    fs005_3m_1k	decimal (16, 8),"
"    sex_tran		int,"
"    rscore41		decimal (16, 8),"
"/*Fuhwa Ploan variables*/"
"    fs102_3m		decimal (16, 8),"
"    fs102_6m		decimal (16, 8),"
"    fs102_9m		decimal (16, 8),"
"    ft102_42		decimal (16, 8),"
"    ft102_42_r		decimal (16, 8),"
"    ft102_42_r_tran	decimal (16, 8),"
"    fs031_q		decimal (16, 8),"
"    fs031_q_tran	decimal (16, 8),"
"    gender_z		int,"
"    fs212_3m_1k	decimal (16, 8),"
"    fs212_6m_1k	decimal (16, 8),"
"    ft212_43_1k	decimal (16, 8),"
"    ft212_43_1k_q	decimal (16, 8),"
"    ft212_43_1k_q_tran	decimal (16, 8),"
"    ms120_9m		decimal (16, 8),"
"    ms120_9m_r		decimal (16, 8),"
"    ms120_9m_r_tran	decimal (16, 8),"
"    app_last_month_bucket_tran	decimal (16, 8),"
"    ms026_3m		decimal (16, 8),"
"    ms026_3m_r		decimal (16, 8),"
"    ms026_3m_r_tran	decimal (16, 8),"
"    fs059_3m_1k 	decimal (16, 8),"
"    fs059_6m_1k	decimal (16, 8),"
"    ft059_43_1k	decimal (16, 8),"
"    ft059_43_1k_q	decimal (16, 8),"
"    ft059_43_1k_q_tran	decimal (16, 8),"
"    fs063_12m_1k	decimal (16, 8),"
"    fs063_12m_1k_q	decimal (16, 8),"
"    ms024_3m		decimal (16, 8),"
"    ms024_3m_tran	decimal (16, 8),"
"    fs018_3m		decimal (16, 8),"
"    fs018_6m		decimal (16, 8),"
"    fs018_9m		decimal (16, 8),"
"    ft018_42		decimal (16, 8),"
"    ft018_42_tran	decimal (16, 8),"
"    ft018_42_tran_q	decimal (16, 8),"
"    rs017		decimal (16, 8),"
"    rs017_r		decimal (16, 8),"
"    rs017_r_tran	decimal (16, 8),"
"    fs005_12m_1k	decimal (16, 8),"
"    fs005_12m_1k_r	decimal (16, 8),"
"    ms119_12m		decimal (16, 8),"
"    ms119_12m_r	decimal (16, 8),"
"    ms119_12m_r_tran	decimal (16, 8),"
"    f_score1		decimal (16, 8),"
"    riskscore		decimal (16, 8),"
"    twentile		int,"
"    pd			decimal (16, 8)"
"    );",

/* Drop_Procedure_Prepare_Jcic_Data */
" if exists (select * from dbo.sysobjects where id = object_id(N'[prepare_jcic_data]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)"
" drop procedure prepare_jcic_data;",

/* Exec_Procedure_Prepare_Jcic_Data */
"Execute prepare_jcic_data :v0, :v1, :v2, :v3;",


/* Create_Procedure_Prepare_Jcic_Data */
" CREATE PROCEDURE prepare_jcic_data"
"  (@case_sn char(12),"
"   @idn char(11),"
"   @dac_sn int,"
"   @now int)"
"  AS"
" insert into #krm021_dedup (case_sn, idn, dac_sn, card_brand, card_type, issue, issue_name, start_date, stop_date, stop_code, ab_code, m_s, limit, cnt)"
"    select case_sn, idn, dac_sn, card_brand, card_type, issue, issue_name, start_date, stop_date, stop_code, ab_code, m_s, limit, count(*)"
"    from krm021"
"    where case_sn = @case_sn and idn = @idn and dac_sn = @dac_sn"
"    group by case_sn, idn, dac_sn, card_brand, card_type, issue, issue_name, start_date, stop_date, stop_code, ab_code, m_s, limit;"
/*start convert krm034 to krm023*/
" insert into #krm023_dedup (case_sn, idn, dac_sn, issue, issue_name, limit, yrmon, kr_code, payment, cash, pay_code, cnt)"
"    select case_sn, idn, dac_sn, issue, issue_name, limit, yrmon, kr_code, payment, cash, pay_code, count(*)"
"    from krm023"
"    where case_sn = @case_sn and idn = @idn and dac_sn = @dac_sn"
"      and cast(yrmon as int) <=9412 "
"    group by case_sn, idn, dac_sn, issue, issue_name, limit, yrmon, kr_code, payment, cash, pay_code;"

" insert into #krm034_dedup (case_sn, idn, dac_sn, idn_ban, bill_date, issue, "
"    issue_name, card_type, perm_limit, cash_yn, last_paya, pay_stat, pay_code, "
"    debt_code, close_code, clear_date, cnt) "
" select case_sn, idn, dac_sn, idn_ban, bill_date, issue, issue_name, card_type, "
"    perm_limit, cash_yn, last_paya, pay_stat, pay_code, debt_code, close_code, "
"    clear_date, count(*) "
" from krm034 "
" where case_sn = @case_sn and idn = @idn and dac_sn = @dac_sn"
"   and issue != 'TOT' "
" group by case_sn, idn, dac_sn, idn_ban, bill_date, issue, issue_name, card_type,"
"    perm_limit, cash_yn, last_paya, pay_stat, pay_code, debt_code, close_code, clear_date;"
" update #krm034_dedup "
"    set mon_since = (case when length(bill_date) = 4 and left(bill_date,1) between '1' and '9'"
"                               then cast(left(bill_date, 2) as int) * 12 + cast(right(bill_date, 2) as int)"
"                          when length(bill_date) = 7 and cast(right(bill_date,2) as int) > 15 "
"                               then cast(left(bill_date, 3)as int) * 12 + cast(substr(bill_date, 4, 2) as int) "
"                          when length(bill_date) = 7 then cast(left(bill_date, 3) as int) * 12 + cast(substr(bill_date, 4, 2) as int) - 1 "
"                          else null end) "
"    where case_sn = @case_sn and idn = @idn and dac_sn = @dac_sn;"
" insert into #krm023_dedup (case_sn, idn, dac_sn, issue, issue_name, limit, kr_code, "
"                           payment, cash, pay_code, mon_since) "
"    select case_sn, idn, dac_sn, "
"           (case when (issue = 'A82' and card_type = 'A') then 'AEA' "
"                 when (issue = 'A82' and card_type = 'E') then 'AEE' "
"                 when (issue = '021' and card_type = 'V') then 'CTV' "
"                 when (issue = '021' and card_type = 'M') then 'CTM' "
"                 when (issue = '021' and card_type = 'D') then 'CTD' "
"                 when issue = '150' then '103' "
"                 else issue end), "
"           issue_name, cast(cast(perm_limit as int) as char(5)), card_type, last_paya, 'N', "
"           (case when pay_stat = 'X' and pay_code = 'X' then 'X' "
"                 when pay_stat = '1' and pay_code = 'N' then 'A' "
"                 when pay_stat = '1' and pay_code = '0' then 'B' "
"                 when pay_stat = '2' and pay_code = 'N' then 'C' "
"                 when pay_stat = '2' and pay_code = '0' then 'D' "
"                 when pay_stat = '3' and pay_code between '1' and '7' then 'E' "
"                 when pay_stat = '4' and pay_code between '1' and '7' then 'F' "
"                 when debt_code in ('A', 'B') then 'F' else null end), mon_since "
"    from #krm034_dedup "
"    where mon_since > 1140 "
"      and case_sn = @case_sn and idn = @idn and dac_sn = @dac_sn;"
"     update #krm023_dedup "
"        set cash = 'Y' "
"        where case_sn = @case_sn and idn = @idn and dac_sn = @dac_sn "
"          and exists (select * "
"                      from #krm034_dedup s "
"                      where #krm023_dedup.idn = s.idn "
"                        and mon_since = cast(left(s.bill_date, 3) as int) * 12 * cast(substr(s.bill_date, 4, 2) as int)"
"                        and #krm023_dedup.issue = s.issue "
"                        and cash_YN = 'Y');"
/* end convert krm034 to krm023*/
/*
" insert into #stm001_dedup (case_sn, idn, dac_sn, bank_code, bank_name, query_date, item_list, cnt)"
"    select case_sn, idn, dac_sn, bank_code, bank_name, query_date, item_list, count(*)"
"    from stm001"
"    where case_sn = @case_sn and idn = @idn and dac_sn = @dac_sn"
"    group by case_sn, idn, dac_sn, bank_code, bank_name, query_date, item_list;"
*/
" insert into #stm002_dedup (case_sn, idn, dac_sn, query_date, bank_code, bank_name, query_item, cnt)"
"    select case_sn, idn, dac_sn, query_date, bank_code, bank_name, query_item, count(*)"
"    from stm002"
"    where case_sn = @case_sn and idn = @idn and dac_sn = @dac_sn"
"    group by case_sn, idn, dac_sn, bank_code, bank_name, query_date, query_item;"
" insert into #bam085_dedup (case_sn, idn, dac_sn, data_yyy, data_mm, bank_code, bank_name, account_code, account_code2, purpose_code, contract_amt, loan_amt, pass_due_amt, pay_code_12, co_loan, cnt)"
"    select case_sn, idn, dac_sn, data_yyy, data_mm, bank_code, bank_name, account_code, account_code2, purpose_code, contract_amt, loan_amt, pass_due_amt, pay_code_12, co_loan, count(*)"
"    from bam085"
"    where case_sn = @case_sn and idn = @idn and dac_sn = @dac_sn"
"    group by case_sn, idn, dac_sn, data_yyy, data_mm, bank_code, bank_name, account_code, account_code2, purpose_code, contract_amt, loan_amt, pass_due_amt, pay_code_12, co_loan;"
" insert into #jas002_t (case_sn, idn, dac_sn, reason, date_happen)"
"    select case_sn, idn, dac_sn, 'D', data_yyymmdd"
"    from bas001"
"    where data_yyymmdd is not null"
"      and case_sn = @case_sn and idn = @idn and dac_sn = @dac_sn;"
" insert into #jas002_t (case_sn, idn, dac_sn, reason, date_happen)"
"    select case_sn, idn, dac_sn, 'B', ck_date"
"    from dam103"
"    where ck_date is not null"
"      and case_sn = @case_sn and idn = @idn and dac_sn = @dac_sn;"
" insert into #jas002_t (case_sn, idn, dac_sn, reason, date_happen)"
"    select case_sn, idn, dac_sn, 'R', beg_date"
"    from dam203"
"    where beg_date is not null"
"      and case_sn = @case_sn and idn = @idn and dac_sn = @dac_sn;"
" insert into #jas002_t (case_sn, idn, dac_sn, reason, date_happen)"
"    select case_sn, idn, dac_sn, 'S', stop_date"
"    from krm021"
"    where stop_code = '3'"
"      and case_sn = @case_sn and idn = @idn and dac_sn = @dac_sn;"
" insert into #jas002_t_dedup (case_sn, idn, dac_sn, reason, date_happen, mon_since, cnt)"
"    select case_sn, idn, dac_sn, reason, date_happen, mon_since, count(*)"
"    from #jas002_t"
"    group by case_sn, idn, dac_sn, reason, date_happen, mon_since;"
" update #krm021_dedup set card_brand = (case when card_brand = '' then NULL else card_brand end),"
"                   card_type  = (case when card_type  = '' then NULL else card_type  end),"
"                   issue      = (case when issue      = '' then NULL else issue      end),"
"                   issue_name = (case when issue_name = '' then NULL else issue_name end),"
"                   start_date = (case when start_date = '' then NULL else start_date end),"
"                   stop_date  = (case when stop_date  = '' then NULL else stop_date  end),"
"                   stop_code  = (case when stop_code  = '' then NULL else stop_code  end),"
"                   ab_code    = (case when ab_code    = '' then NULL else ab_code    end),"
"                   m_s        = (case when m_s        = '' then NULL else m_s        end),"
"                   limit      = (case when limit      = '' then NULL else limit      end)"
" update #krm023_dedup set issue = (case when issue    = '' then NULL else issue      end),"
"                   issue_name = (case when issue_name = '' then NULL else issue_name end),"
"                   limit      = (case when limit      = '' then NULL else limit      end),"
"                   yrmon      = (case when yrmon      = '' then NULL else yrmon      end),"
"                   kr_code    = (case when kr_code    = '' then NULL else kr_code    end),"
"                   payment    = (case when payment    = '' then NULL else payment    end),"
"                   cash       = (case when cash       = '' then NULL else cash       end),"
"                   pay_code   = (case when pay_code   = '' then NULL else pay_code   end)"
" update #stm001_dedup set bank_code  = (case when bank_code  = '' then NULL else bank_code  end),"
"                   bank_name  = (case when bank_name  = '' then NULL else bank_name  end),"
"                   query_date = (case when query_date = '' then NULL else query_date end),"
"                   item_list  = (case when item_list  = '' then NULL else item_list  end)"
" update #stm002_dedup set bank_code  = (case when bank_code  = '' then NULL else bank_code  end),"
"                   bank_name  = (case when bank_name  = '' then NULL else bank_name  end),"
"                   query_date = (case when query_date = '' then NULL else query_date end),"
"                   query_item  = (case when query_item  = '' then NULL else query_item end)"
" update #bam085_dedup set data_yyy      = (case when data_yyy      = '' then NULL else data_yyy      end),"
"                   data_mm       = (case when data_mm       = '' then NULL else data_mm       end),"
"                   bank_code     = (case when bank_code     = '' then NULL else bank_code     end),"
"                   bank_name     = (case when bank_name     = '' then NULL else bank_name     end),"
"                   account_code  = (case when account_code  = '' then NULL else account_code  end),"
"                   account_code2 = (case when account_code2 = '' then NULL else account_code2 end),"
"                   purpose_code  = (case when purpose_code  = '' then NULL else purpose_code  end),"
"                   pay_code_12   = (case when pay_code_12   = '' then NULL else pay_code_12   end),"
"                   co_loan       = (case when co_loan       = '' then NULL else co_loan       end)"
" update #krm021_dedup"
"    set start_date = (case when left(start_date,1) not in ('1', '0', '*') then '0' + (start_date)"
" 		           else start_date"
" 		      end),"
"        stop_date =  (case when left(stop_date,1) not in ('1', '0', '*') then '0' + (stop_date)"
"  		           else stop_date"
" 	 	      end);"
" update #krm021_dedup"
"    set start_mon_since = (case when left(start_date,1) = '*' then null"
" 			        else left(start_date, 3) * 12 + right(left(start_date, 5), 2)"
" 		           end),"
"        end_mon_since = (case when left(stop_date, 1) = '*' then null"
" 			      else left(stop_date, 3) * 12 + right(left(stop_date, 5), 2)"
" 		         end);"
" update #krm021_dedup"
"    set end_mon_since = 12000   /*999 * 12 + 12*/"
"    where end_mon_since is null;"
" update #jas002_t_dedup"
"    set date_happen = (case when left(ltrim(date_happen),1) not in ('1', '0', '*') then '0' + (ltrim(date_happen))"
"  		            else date_happen"
"  		       end);"
" update #jas002_t_dedup"
"    set mon_since = (case when left(ltrim(date_happen),1) = '*' then null"
"    		          else left(ltrim(date_happen), 3) * 12 + right(left(rtrim(date_happen), 5), 2)"
"  		     end);"
" update #krm023_dedup"
"    set yrmon = (case when left(yrmon,1) not in ('1', '0', '*') then '0' + (yrmon)"
" 	              else yrmon"
" 	         end);"
" update #krm023_dedup"
"    set mon_since = (case when left(yrmon,1) = '*' then null"
" 		          else left(yrmon, 3) * 12 + right(left(yrmon, 5), 2)"
" 		     end);"
" update #stm001_dedup"
"    set query_date = (case when left(query_date,1) not in ('1', '0', '*') then '0' + (query_date)"
" 		           else query_date"
" 		      end);"
" update #stm001_dedup"
"    set query_mon_since = (case when left(query_date,1) = '*' then null"
" 			        else left(query_date, 3) * 12 + right(left(query_date, 5), 2)"
" 		           end);"
" update #stm002_dedup"
"    set query_date = (case when left(query_date,1) not in ('1', '0', '*') then '0' + (query_date)"
" 		           else query_date"
" 		      end);"
" update #stm002_dedup"
"    set query_mon_since = (case when left(query_date,1) = '*' then null"
" 			        else left(query_date, 3) * 12 + right(left(query_date, 5), 2)"
" 		           end);"
" update #krm023_dedup"
"    set payment = (case when right(left(payment,2),1) in ('H', 'M', 'L') then '0' + (left(payment,2))"
"                        else payment end);"
" update #krm023_dedup"
"    set payment_amt = (case right(payment,1) when 'L' then 2"
"                                             when 'M' then 5"
"                                             when 'H' then 8"
"                                             else 0 end)"
"                      * power(10, isnull(left(payment,2),0)-1) / 1000.0;"
" update #krm023_dedup "
"    set payment_amt = cast(limit as int) "
"    where payment_amt > cast(limit as int) "
"      and issue != 'AEE';"
" update #krm023_dedup"
"    set bucket_def_1k = (case when pay_code in ('D', 'E', 'F') and payment_amt > 1 then 1"
"                              else 0 end),"
"        bucket_ef_1k =  (case when pay_code in ('E', 'F') and payment_amt > 1 then 1"
"                              else 0 end),"
"        bucket_f_1k =   (case when pay_code = 'F' and payment_amt > 1 then 1"
"                              else 0 end);"
" declare @i int"
" set @i=12"
" while @i > 0"
"    begin"
"       update #krm023_dedup"
"          set bucket_def_1k = (case when #krm023_dedup.pay_code in ('D', 'E', 'F') and"
"                                         #krm023_dedup.payment_amt > 1 then a.bucket_def_1k + 1"
"                                    else 0 end),"
"              bucket_ef_1k =  (case when #krm023_dedup.pay_code in ('E', 'F') and"
"                                         #krm023_dedup.payment_amt > 1 then a.bucket_ef_1k + 1"
"                                    else 0 end),"
"              bucket_f_1k =   (case when #krm023_dedup.pay_code = 'F' and"
"                                         #krm023_dedup.payment_amt > 1 then a.bucket_f_1k + 1"
"                                    else 0 end)"
"          from #krm023_dedup as a inner join #krm023_dedup"
"            on a.idn =  #krm023_dedup.idn and"
"               a.issue =  #krm023_dedup.issue and"
"               a.mon_since = ( #krm023_dedup.mon_since - 1)"
"          where (@now - a.mon_since) = @i"
"       set @i = @i - 1"
"    end;"
" update #bam085_dedup"
"    set bank_code2 = left(bank_code,3);"
" /* risk filter process */"
" create table #base_tmp ("
"    idn varchar (14),"
"    avail_flag int"
" );"
" insert into #base_tmp(idn, avail_flag)"
"    values (@idn, 0);"
" insert into #base_tmp(idn, avail_flag)"
"    select distinct idn, 1"
"    from #krm021_dedup;"
" insert into #base_tmp(idn, avail_flag)"
"    select distinct idn, 2"
"    from #krm023_dedup;"
" insert into #base_tmp(idn, avail_flag)"
"    select distinct idn, 4"
"    from #bam085_dedup;"
" insert into #base_tmp(idn, avail_flag)"
"    select distinct idn, 8"
"    from #stm001_dedup;"
" insert into #base_tmp(idn, avail_flag)"
"    select distinct idn, 8"
"    from #stm002_dedup;"
" insert into #base_tmp(idn, avail_flag)"
"    select distinct idn, 16"
"    from bas001"
"    where case_sn = @case_sn and idn = @idn and dac_sn = @dac_sn;"
" insert into #base_tmp(idn, avail_flag)"
"    select distinct idn, 32"
"    from dam103"
"    where case_sn = @case_sn and idn = @idn and dac_sn = @dac_sn;"
" insert into #base_tmp(idn, avail_flag)"
"    select distinct idn, 64"
"    from dam203"
"    where case_sn = @case_sn and idn = @idn and dac_sn = @dac_sn;"
" insert into #base (idn, avail_flag)"
"    select idn, sum(avail_flag)"
"    from #base_tmp"
"    group by idn;"
" /* Update filter variable*/"
" create table #tmp ("
"    idn varchar(14),"
"    mon int,"
"    v1 decimal (16, 8),"
"    v2 decimal (16, 8),"
"    v3 decimal (16, 8));"
" select idn, count(*) as cnt"
"    into #major_defect"
" from #jas002_t_dedup"
" where @now - mon_since <= 36"
" group by idn;"
" update #base"
"    set jas002_defect = 1"
"    from #major_defect as a"
"    where a.idn = #base.idn"
"      and a.cnt > 0;"
" update #base"
"    set krm023_hit = 1"
"    where avail_flag & 0x02 = 0x02;"
" update #base"
"    set krm021_hit = 1"
"    where avail_flag & 0x01 = 0x01;"
" insert into #tmp(idn, v1)"
"    select idn, max(bucket_ef_1k)"
"    from #krm023_dedup"
"    group by idn;"
" update #base"
"    set max_bucket = v1"
"    from #tmp as a"
"    where a.idn = #base.idn"
" /*----FS044----*/"
" delete from #tmp;"
" insert into #tmp (idn, v1)"
"    select idn, count(*)"
"    from #bam085_dedup"
"    where pass_due_amt > 0"
"    group by idn;"
" update #base"
"    set fs044 = v1"
"    from #tmp as a"
"    where a.idn = #base.idn;"
" /*----cash card max bucket----*/"
" delete from #tmp;"
" insert into #tmp (idn, v1)"
"    select idn, count(*)"
"    from #bam085_dedup"
"    where account_code = 'Y'"
"      and ISNULL(left(pay_code_12, 1),'0') not in ('0', 'X')"
"    group by idn;"
" update #base"
"    set cash_max_bucket = v1"
"    from #tmp as a"
"    where a.idn = #base.idn;"
" /*----cash card utilization----*/"
" delete from #tmp;"
" insert into #tmp (idn, v1)"
"    select idn, count(*)"
"    from #bam085_dedup"
"    where account_code = 'Y'"
"      and ISNULL(loan_amt,0) / contract_amt >= 1"
"      and contract_amt > 0"
"    group by idn;"
" update #base"
"    set cash_utilization = v1"
"    from #tmp as a"
"    where a.idn = #base.idn;"
" /*----Ind001----*/"
" delete from #tmp;"
" insert into #tmp (idn, mon)"
"    select idn, min(start_mon_since)"
"    from #krm021_dedup"
"    group by idn;"
" update #base"
"    set ind001 = 1"
"    from #tmp as a"
"    where a.idn = #base.idn"
"      and (@now - a.mon) between 1 and 7;"
" drop table #base_tmp;"
" drop table #tmp;"
"/* -- end of procedure prepare_jcic_data --*/",

/* Insert_Daco_Table */
" insert into #daco_v41_cal(case_sn, idn, dac_sn, now)"
"    values (:v0, :v1, :v2, :v3)",

/* Update_Inquiry_Date*/
" update #daco_v41_cal"
"    set inquiry_date = a.inquiry_date,"
"        sex = (case when substring(a.idn,2,1) = '1' then 1 else 0 end),"
"        guarantor = a.guarantor,"
"        segment = ltrim(rtrim(a.segment))"
"    from app_info a"
"    where a.case_sn = #daco_v41_cal.case_sn"
"      and a.idn = #daco_v41_cal.idn"
"      and a.dac_sn = #daco_v41_cal.dac_sn;"
" update #daco_v41_cal"
"   set apr_group = (case when segment = '01' then 1"
"                         when segment = '02' then 2"
"                         when segment = '03' then 3"
"                         when segment = '04' then 4"
"                         when segment = '05' then 5"
"                         when segment = '06' then 6"
"                         when segment = '07' then 7"
"                         else 8 end)",

/* Update_Base*/
" update #daco_v41_cal"
"    set jas002_defect = a.jas002_defect,"
"        avail_flag = a.avail_flag,"
"        krm021_hit = a.krm021_hit,"
"        krm023_hit = a.krm023_hit,"
"        max_bucket = a.max_bucket,"
"        fs044 = a.fs044,"
"        cash_max_bucket = a.cash_max_bucket,"
"        cash_utilization = a.cash_utilization,"
"        ind001 = a.ind001"
"    from #base a"
"    where a.idn = #daco_v41_cal.idn;",

/* Insert_Audit_Table */
"if NOT exists (select * from dbo.sysobjects where id = object_id(N'dac_audit41')"
"   and objectproperty(id, N'IsUserTable') = 1)"
"  begin"
"  create table dac_audit41 ("
"    case_sn		char(12),"
"    idn		char(11),"
"    dac_sn		decimal(3,0),"
"    inquiry_date	char(8),"
"    guarantor		char(1),"
"    sex		int,"
"    segment		varchar(7),"
"    apr_group		int,"
"    now		int,"
"    avail_flag		int,"
"    jas002_defect	int,"
"    krm021_hit		int,"
"    krm023_hit		int,"
"    max_bucket		int,"
"    fs044		int,"
"    cash_max_bucket	int,"
"    cash_utilization	int,"
"    ind001		int,"
"/* DACO4.1 variables*/"
"    ms056_6m_1k	decimal (16, 8),"
"    ms056_6m_1k_tran	decimal (16, 8),"
"    ms110_3m		decimal (16, 8),"
"    ms110_6m		decimal (16, 8),"
"    ms106_3m		decimal (16, 8),"
"    ms106_6m		decimal (16, 8),"
"    mt110_43		decimal (16, 8),"
"    mt110_43_tran	decimal (16, 8),"
"    fs002_6m_1k	decimal (16, 8),"
"    fs002_6m_1k_q	decimal (16, 8),"
"    fs002_6m_1k_q_tran	decimal (16, 8),"
"    fs016_9m		decimal (16, 8),"
"    fs101_9m		decimal (16, 8),"
"    fs040		decimal (16, 8),"
"    fs068		decimal (16, 8),"
"    fs069		decimal (16, 8),"
"    fs069_tran		decimal (16, 8),"
"    int015_9m		decimal (16, 8),"
"    int015_9m_tran	decimal (16, 8),"
"    fs031		decimal (16, 8),"
"    fs031_tran		decimal (16, 8),"
"    ms203_3m_1k	decimal (16, 8),"
"    ms203_6m_1k	decimal (16, 8),"
"    ms203_9m_1k	decimal (16, 8),"
"    mt203_42_1k	decimal (16, 8),"
"    mt203_42_1k_r	decimal (16, 8),"
"    mt203_42_1k_r_tran	decimal (16, 8),"
"    app_last_month_bucket	decimal (16, 8),"
"    app_last_month_bucket_t1	decimal (16, 8),"
"    fs008_12mplus	decimal (16, 8),"
"    fs008_12mplus_r	decimal (16, 8),"
"    fs008_12mplus_r_tran decimal (16, 8),"
"    ms011_3m		decimal (16, 8),"
"    ms011_6m		decimal (16, 8),"
"    ms011_9m		decimal (16, 8),"
"    ms011_12m		decimal (16, 8),"
"    mt011_31		decimal (16, 8),"
"    mt011_31_z		decimal (16, 8),"
"    ms009_3m		decimal (16, 8),"
"    ms009_6m		decimal (16, 8),"
"    mt009_43		decimal (16, 8),"
"    mt009_43_q		decimal (16, 8),"
"    mt009_43_q_tran2	decimal (16, 8),"
"    fs005_3m_1k	decimal (16, 8),"
"    sex_tran		int,"
"    rscore41		decimal (16, 8),"
"/*Fuhwa Ploan variables*/"
"    fs102_3m		decimal (16, 8),"
"    fs102_6m		decimal (16, 8),"
"    fs102_9m		decimal (16, 8),"
"    ft102_42		decimal (16, 8),"
"    ft102_42_r		decimal (16, 8),"
"    ft102_42_r_tran	decimal (16, 8),"
"    fs031_q		decimal (16, 8),"
"    fs031_q_tran	decimal (16, 8),"
"    gender_z		int,"
"    fs212_3m_1k	decimal (16, 8),"
"    fs212_6m_1k	decimal (16, 8),"
"    ft212_43_1k	decimal (16, 8),"
"    ft212_43_1k_q	decimal (16, 8),"
"    ft212_43_1k_q_tran	decimal (16, 8),"
"    ms120_9m		decimal (16, 8),"
"    ms120_9m_r		decimal (16, 8),"
"    ms120_9m_r_tran	decimal (16, 8),"
"    app_last_month_bucket_tran	decimal (16, 8),"
"    ms026_3m		decimal (16, 8),"
"    ms026_3m_r		decimal (16, 8),"
"    ms026_3m_r_tran	decimal (16, 8),"
"    fs059_3m_1k 	decimal (16, 8),"
"    fs059_6m_1k	decimal (16, 8),"
"    ft059_43_1k	decimal (16, 8),"
"    ft059_43_1k_q	decimal (16, 8),"
"    ft059_43_1k_q_tran	decimal (16, 8),"
"    fs063_12m_1k	decimal (16, 8),"
"    fs063_12m_1k_q	decimal (16, 8),"
"    ms024_3m		decimal (16, 8),"
"    ms024_3m_tran	decimal (16, 8),"
"    fs018_3m		decimal (16, 8),"
"    fs018_6m		decimal (16, 8),"
"    fs018_9m		decimal (16, 8),"
"    ft018_42		decimal (16, 8),"
"    ft018_42_tran	decimal (16, 8),"
"    ft018_42_tran_q	decimal (16, 8),"
"    rs017		decimal (16, 8),"
"    rs017_r		decimal (16, 8),"
"    rs017_r_tran	decimal (16, 8),"
"    fs005_12m_1k	decimal (16, 8),"
"    fs005_12m_1k_r	decimal (16, 8),"
"    ms119_12m		decimal (16, 8),"
"    ms119_12m_r	decimal (16, 8),"
"    ms119_12m_r_tran	decimal (16, 8),"
"    f_score1		decimal (16, 8),"
"    riskscore		decimal (16, 8),"
"    twentile		int,"
"    pd			decimal (16, 8)"
"   );"
"  end "
" insert into dac_audit41(case_sn, idn, dac_sn, inquiry_date, guarantor, sex, segment, apr_group, now, avail_flag, jas002_defect,"
"  krm021_hit, krm023_hit, max_bucket, fs044, cash_max_bucket, cash_utilization, ind001,"
"  ms056_6m_1k, ms056_6m_1k_tran, ms110_3m, ms110_6m, ms106_3m, ms106_6m, mt110_43,"
"  mt110_43_tran, fs002_6m_1k, fs002_6m_1k_q, fs002_6m_1k_q_tran, fs016_9m, fs101_9m,"
"  fs040, fs068, fs069, fs069_tran, int015_9m, int015_9m_tran, fs031, fs031_tran,"
"  ms203_3m_1k, ms203_6m_1k, ms203_9m_1k, mt203_42_1k, mt203_42_1k_r, mt203_42_1k_r_tran,"
"  app_last_month_bucket, app_last_month_bucket_t1, fs008_12mplus, fs008_12mplus_r,"
"  fs008_12mplus_r_tran, ms011_3m, ms011_6m, ms011_9m, ms011_12m, mt011_31, mt011_31_z,"
"  ms009_3m, ms009_6m, mt009_43, mt009_43_q, mt009_43_q_tran2, fs005_3m_1k, sex_tran,"
"  rscore41, fs102_3m, fs102_6m, fs102_9m, ft102_42, ft102_42_r, ft102_42_r_tran, fs031_q,"
"  fs031_q_tran, gender_z, fs212_3m_1k, fs212_6m_1k, ft212_43_1k, ft212_43_1k_q,"
"  ft212_43_1k_q_tran, ms120_9m, ms120_9m_r, ms120_9m_r_tran, app_last_month_bucket_tran,"
"  ms026_3m, ms026_3m_r, ms026_3m_r_tran, fs059_3m_1k, fs059_6m_1k, ft059_43_1k,"
"  ft059_43_1k_q, ft059_43_1k_q_tran, fs063_12m_1k, fs063_12m_1k_q, ms024_3m, ms024_3m_tran,"
"  fs018_3m, fs018_6m, fs018_9m, ft018_42, ft018_42_tran, ft018_42_tran_q, rs017, rs017_r,"
"  rs017_r_tran, fs005_12m_1k, fs005_12m_1k_r, ms119_12m, ms119_12m_r, ms119_12m_r_tran,"
"  f_score1, riskscore, twentile, pd)"
" select case_sn, idn, dac_sn, inquiry_date, guarantor, sex, segment, apr_group, now, avail_flag, jas002_defect,"
"  krm021_hit, krm023_hit, max_bucket, fs044, cash_max_bucket, cash_utilization, ind001,"
"  ms056_6m_1k, ms056_6m_1k_tran, ms110_3m, ms110_6m, ms106_3m, ms106_6m, mt110_43,"
"  mt110_43_tran, fs002_6m_1k, fs002_6m_1k_q, fs002_6m_1k_q_tran, fs016_9m, fs101_9m,"
"  fs040, fs068, fs069, fs069_tran, int015_9m, int015_9m_tran, fs031, fs031_tran,"
"  ms203_3m_1k, ms203_6m_1k, ms203_9m_1k, mt203_42_1k, mt203_42_1k_r, mt203_42_1k_r_tran,"
"  app_last_month_bucket, app_last_month_bucket_t1, fs008_12mplus, fs008_12mplus_r,"
"  fs008_12mplus_r_tran, ms011_3m, ms011_6m, ms011_9m, ms011_12m, mt011_31, mt011_31_z,"
"  ms009_3m, ms009_6m, mt009_43, mt009_43_q, mt009_43_q_tran2, fs005_3m_1k, sex_tran,"
"  rscore41, fs102_3m, fs102_6m, fs102_9m, ft102_42, ft102_42_r, ft102_42_r_tran, fs031_q,"
"  fs031_q_tran, gender_z, fs212_3m_1k, fs212_6m_1k, ft212_43_1k, ft212_43_1k_q,"
"  ft212_43_1k_q_tran, ms120_9m, ms120_9m_r, ms120_9m_r_tran, app_last_month_bucket_tran,"
"  ms026_3m, ms026_3m_r, ms026_3m_r_tran, fs059_3m_1k, fs059_6m_1k, ft059_43_1k,"
"  ft059_43_1k_q, ft059_43_1k_q_tran, fs063_12m_1k, fs063_12m_1k_q, ms024_3m, ms024_3m_tran,"
"  fs018_3m, fs018_6m, fs018_9m, ft018_42, ft018_42_tran, ft018_42_tran_q, rs017, rs017_r,"
"  rs017_r_tran, fs005_12m_1k, fs005_12m_1k_r, ms119_12m, ms119_12m_r, ms119_12m_r_tran,"
"  f_score1, riskscore, twentile, pd from #daco_v41_cal",

/* Insert_Intermediate_Table */
"if NOT exists (select * from dbo.sysobjects where id = object_id(N'intermediate')"
"   and objectproperty(id, N'IsUserTable') = 1)"
"  begin"
"    create table intermediate ("
"     case_sn char(12),"
"     idn char (11),"
"     dac_sn decimal(3,0),"
"     inquiry_date char(8),"
"     x1 decimal (14, 5),"	//guarantor
"     x2 decimal (14, 5),"	//sex
"     x3 decimal (14, 5),"	//ms056_6m_1k
"     x4 decimal (14, 5),"	//ms110_3m
"     x5 decimal (14, 5),"	//ms110_6m
"     x6 decimal (14, 5),"	//ms106_3m
"     x7 decimal (14, 5),"	//ms106_6m
"     x8 decimal (14, 5),"	//fs002_6m_1k
"     x9 decimal (14, 5),"	//fs016_9m
"     x10 decimal (14, 5),"	//fs101_9m
"     x11 decimal (14, 5),"	//fs040
"     x12 decimal (14, 5),"	//fs068
"     x13 decimal (14, 5),"	//fs069
"     x14 decimal (14, 5),"	//int015_9m
"     x15 decimal (14, 5),"	//fs031
"     x16 decimal (14, 5),"	//ms203_3m_1k
"     x17 decimal (14, 5),"	//ms203_6m_1k
"     x18 decimal (14, 5),"	//ms203_9m_1k
"     x19 decimal (14, 5),"	//app_last_month_bucket
"     x20 decimal (14, 5),"	//fs008_12mplus
"     x21 decimal (14, 5),"	//ms011_3m
"     x22 decimal (14, 5),"	//ms011_6m
"     x23 decimal (14, 5),"	//ms011_9m
"     x24 decimal (14, 5),"	//ms011_12m
"     x25 decimal (14, 5),"	//ms009_3m
"     x26 decimal (14, 5),"	//ms009_6m
"     x27 decimal (14, 5),"	//fs005_3m_1k
"     x28 decimal (14, 5),"	//fs102_3m
"     x29 decimal (14, 5),"	//fs102_6m
"     x30 decimal (14, 5),"	//fs102_9m
"     x31 decimal (14, 5),"	//fs212_3m_1k
"     x32 decimal (14, 5),"	//fs212_6m_1k
"     x33 decimal (14, 5),"	//ms120_9m
"     x34 decimal (14, 5),"	//ms026_3m
"     x35 decimal (14, 5),"	//fs059_3m_1k
"     x36 decimal (14, 5),"	//fs059_6m_1k
"     x37 decimal (14, 5),"	//fs063_12m_1k
"     x38 decimal (14, 5),"	//ms024_3m
"     x39 decimal (14, 5),"	//fs018_3m
"     x40 decimal (14, 5),"	//fs018_6m
"     x41 decimal (14, 5),"	//fs018_9m
"     x42 decimal (14, 5),"	//rs017
"     x43 decimal (14, 5),"	//fs005_12m_1k
"     x44 decimal (14, 5),"	//ms119_12m
"     );"
"  end"
" insert into intermediate(case_sn, idn, dac_sn, inquiry_date, x1, x2, x3, x4, x5,"
"                         x6, x7, x8, x9, x10, x11, x12, x13, x14,"
"                         x15, x16, x17, x18, x19, x20,"
"                         x21, x22, x23, x24, x25, x26, x27, x28,"
"                         x29, x30, x31, x32, x33, x34, x35,"
"                         x36, x37, x38, x39, x40, x41, x42, x43,"
"                         x44)"
" select case_sn, idn, dac_sn, inquiry_date, convert(decimal(14,5),guarantor), sex, ms056_6m_1k, ms110_3m, ms110_6m,"
"  ms106_3m, ms106_6m, fs002_6m_1k, fs016_9m, fs101_9m, fs040, fs068, fs069, int015_9m,"
"  fs031, ms203_3m_1k, ms203_6m_1k, ms203_9m_1k, app_last_month_bucket, fs008_12mplus,"
"  ms011_3m, ms011_6m, ms011_9m, ms011_12m, ms009_3m, ms009_6m, fs005_3m_1k, fs102_3m,"
"  fs102_6m, fs102_9m, fs212_3m_1k, fs212_6m_1k, ms120_9m, ms026_3m, fs059_3m_1k,"
"  fs059_6m_1k, fs063_12m_1k, ms024_3m, fs018_3m, fs018_6m, fs018_9m, rs017, fs005_12m_1k,"
"  ms119_12m"
"  from #daco_v41_cal;"
"/* -- end of  Insert_Intermediate_Table --*/",

/* Drop_Procedure_generate_daco41_score */
" if exists (select * from dbo.sysobjects where id = object_id(N'[generate_daco41_score]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)"
" drop procedure generate_daco41_score;",

/* Exec_Procedure_generate_daco41_score */
" execute generate_daco41_score :v1;",

/* Create_Procedure_generate_daco41_score */
" CREATE PROCEDURE generate_daco41_score"
"   (@now int)"
" AS"
" declare @i int"
" declare @months int"
" create table #tmp ("
"    idn varchar(14),"
"    mon int,"
"    v1 decimal (16, 8),"
"    v2 decimal (16, 8),"
"    v3 decimal (16, 8));"
" create table #tmp1 ("
"    idn varchar(14),"
"    mon int,"
"    v1 decimal (16, 8));"
" create table #tmp2("
"    idn varchar(14),"
"    issuer char(3));"
" create table #open_issuer ("
"    idn varchar(14),"
"    issuer char(3),"
"    mon int);"
" create table #lines ("
"    idn varchar(14),"
"    issuer char(3),"
"    mon int,"
"    line decimal (16, 8));"
" create table #open_card ("
"    idn varchar(14),"
"    issue char(3),"
"    mon int);"
" create table #open_line ("
"    idn varchar(14),"
"    issue char(3),"
"    mon int,"
"    cards int,"
"    bucket int);"
" create table #latest_stmt_mon ("
"    idn varchar(14),"
"    issue char(3),"
"    mon int);"
" create table #latest_line ("
"    idn varchar(14),"
"    issue char(3),"
"    mon int,"
"    mob int);"
" /*Init bam085 variables*/"
" update #daco_v41_cal"
"    set fs068 = 0,"
"        fs040 = 0"
"    from #bam085_dedup as a"
"    where a.idn = #daco_v41_cal.idn;"
""
" /*Init krm021 variables*/"
" update #daco_v41_cal"
"    set fs008_12mplus = 0"
"    from #krm021_dedup as a"
"    where a.idn = #daco_v41_cal.idn;"
" /*Init krm023 variables*/"
" update #daco_v41_cal"
"    set fs002_6m_1k = 0,"
"        fs005_3m_1k = 0,"
"        fs016_9m = 0,"
"        fs101_9m = 0,"
"        ms009_3m = 0,"
"        ms009_6m = 0,"
"	app_last_month_bucket = 0,"
"        ms011_3m = 0,"
"        ms011_6m = 0,"
"        ms011_9m = 0,"
"        ms011_12m = 0,"
"        ms056_6m_1k = 0,"
"        ms110_3m = 0,"
"        ms110_6m = 0,"
"        ms106_3m = 0,"
"        ms106_6m = 0"
"    from #krm023_dedup as a"
"    where a.idn = #daco_v41_cal.idn;"
" /*Init krm021 and krm023 variables*/"
" update #daco_v41_cal"
"    set ms203_3m_1k = 0,"
"        ms203_6m_1k = 0,"
"        ms203_9m_1k = 0"
"    from #krm021_dedup as a, #krm023_dedup as b"
"    where a.idn = b.idn"
"      and a.idn = #daco_v41_cal.idn"
"      and ((a.issue = b.issue)"
"          or ((a.issue = '021' and a.card_brand = 'V') and (b.issue = 'CTV'))"
"          or ((a.issue = '021' and a.card_brand = 'M') and (b.issue = 'CTM'))"
"          or ((a.issue = '021' and a.card_brand = 'D') and (b.issue = 'CTD'))"
"          or ((a.issue = 'A82' and a.card_brand = 'A') and (b.issue = 'AEA'))"
"          )"
" delete from #tmp1;"
" delete from #tmp;"
" insert into #tmp1 (idn, mon, v1)"
"    select idn, mon_since, 1"
"    from #krm023_dedup"
"    where bucket_ef_1k >= 1"
"    group by idn, mon_since;"
" insert into #tmp (idn, mon, v1)"
"    select idn, 6, sum(v1)"
"    from #tmp1"
"    where (@now - mon) <= 6"
"      and (@now - mon) >= 0"
"    group by idn;"
" update #daco_v41_cal"
"    set fs002_6m_1k = v1"
"    from #tmp as a"
"    where a.idn = #daco_v41_cal.idn"
"      and mon = 6;"
" update #daco_v41_cal"
"    set fs002_6m_1k = (case when fs002_6m_1k > 6 then 6"
"                            else fs002_6m_1k end)"
" /* ---start making fs040--- */"
"  delete from #tmp1;"
"  insert into #tmp1 (idn, v1)"
"     select idn, count(*)"
"     from #bam085_dedup"
"     where (account_code2=''"
"        or account_code2 is null)"
"        and account_code <> 'K'"
"     group by idn;"
"  update #daco_v41_cal"
"     set fs040 = v1"
"     from #tmp1 as a"
"     where a.idn = #daco_v41_cal.idn;"
" /* ---start making fs068--- */"
"  delete from #tmp1;"
"  delete from #tmp2;"
"  insert into #tmp2(idn, issuer)"
"     select idn, bank_code2"
"     from #bam085_dedup"
"     where purpose_code = '1'"
"       and (account_code2 is not null or account_code2 <> '')"
"   insert into #tmp1(idn, v1)"
"      select idn, count(*)"
"      from #bam085_dedup"
"      where not exists (select * from #tmp2"
"                        where #bam085_dedup.idn = #tmp2.idn"
"                          and #bam085_dedup.bank_code2 = #tmp2.issuer)"
"        and purpose_code = '1'"
"        and ((account_code2 is null) or (account_code2 = ''))"
"        and account_code != 'K'"
"      group by idn"
"  update #daco_v41_cal"
"     set fs068 = v1"
"     from #tmp1 as a"
"     where a.idn = #daco_v41_cal.idn;"
"  update #daco_v41_cal"
"     set fs069 = fs040 - fs068"
" /* ---start making fs016--- */"
" delete from #tmp1;"
" insert into #tmp1 (idn, mon, v1)"
"    select idn, 9, count(distinct issue)"
"    from #krm023_dedup"
"    where (@now - mon_since) <= 9"
"      and (@now - mon_since) >= 0"
"      and cash = 'Y'"
"    group by idn;"
" update #daco_v41_cal"
"    set fs016_9m = v1"
"    from #tmp1 as a"
"    where a.idn = #daco_v41_cal.idn"
"      and mon = 9;"
" /* ---start making fs101--- */"
" delete from #tmp1;"
" insert into #tmp1 (idn, mon, v1)"
"    select idn, 9, count(distinct issue)"
"    from #krm023_dedup"
"    where (@now - mon_since) <= 9"
"      and (@now - mon_since) >= 0"
"    group by idn;"
" update #daco_v41_cal"
"    set fs101_9m = v1"
"    from #tmp1 as a"
"    where a.idn = #daco_v41_cal.idn"
"      and mon = 9;"
/*
" delete from #tmp"
" insert into #tmp (idn, v1)"
"    select idn, count(*)"
"    from #stm001_dedup"
"    where item_list is not null"
"      and item_list <> ''"
"      and (@now - query_mon_since) <= 3"
"    group by idn"
*/
" delete from #tmp;"
" insert into #tmp (idn, v1)"
"    select idn, count(*)"
"    from (select idn, bank_code, query_date, count(*) as cnt"
"          from #stm002_dedup"
"          where query_item is not null"
"            and query_item <> ''"
"            and (@now - query_mon_since) <= 3"
"          group by idn, bank_code, query_date) as a"
"    group by idn;"
" update #daco_v41_cal"
"    set fs031 = v1"
"    from #tmp as a"
"    where a.idn = #daco_v41_cal.idn"
" delete from #tmp"
" delete from #tmp1"
" insert into #tmp (idn, mon, v1)"
"    select idn, 3, count(*)"
"    from #krm023_dedup"
"    where bucket_f_1k >= 2"
"      and (@now - mon_since) <= 3"
"      and (@now - mon_since) >= 0"
"    group by idn"
" update #daco_v41_cal"
"    set fs005_3m_1k = v1"
"    from #tmp as a"
"    where a.idn = #daco_v41_cal.idn"
"      and mon = 3"
" update #daco_v41_cal"
"    set fs005_3m_1k = (case when fs005_3m_1k > 3 then 3"
"                            else fs005_3m_1k end)"
" delete from #tmp"
" delete from #tmp1"
" /*---start making ms056---*/"
" insert into #tmp1 (idn, mon, v1)"
"    select idn, mon_since, sum(payment_amt)"
"    from #krm023_dedup"
"    where pay_code in ('D', 'E', 'F')"
"      and bucket_def_1k >= 1"
"    group by idn, mon_since"
" insert into #tmp(idn, mon, v1)"
"    select idn, 6, max(v1)"
"    from #tmp1"
"    where (@now - mon) <= 6"
"      and (@now - mon) >= 0"
"    group by idn"
""
" update #daco_v41_cal"
"    set ms056_6m_1k = v1"
"    from #tmp as a"
"    where a.idn = #daco_v41_cal.idn and mon=6"
" delete from #tmp"
" insert into #tmp (idn, v1)"
"    select idn, max(bucket_ef_1k)"
"    from #krm023_dedup"
"    where (@now - mon_since) <= 1  /*max bucket for last 2 months, no \15 day\ rule*/"
"      and (@now - mon_since) >= 0"
"    group by idn"
" update #daco_v41_cal"
"    set app_last_month_bucket = v1"
"    from #tmp a"
"    where a.idn = #daco_v41_cal.idn"
" /* Initial global variables */"
" set @months = (select @now - min(start_mon_since) from #krm021_dedup);"
" delete from #open_issuer;"
" set @i = 0;"
" while @i <= (@months)"
"    begin"
"       insert into #open_issuer (idn, issuer, mon)"
"          select idn, issue, (@now - @i)"
"          from #krm021_dedup"
"          where (end_mon_since > (@now - @i))"
"            and (start_mon_since <= (@now - @i))"
"       set @i = @i + 1"
"    end;"
" "
"  delete from #tmp1;"
"  delete from #tmp;"
"  insert into #tmp1 (idn, mon, v1)"
"     select idn, 13, count(distinct issue)"
"     from #krm021_dedup as a"
"     where @now - end_mon_since > 0"
"       and stop_code = '3'"
"       and issue not in ('021', '081', '974')"
"       and issue not in (select distinct issuer"
"   	  	         from #open_issuer as b"
"   		         where a.idn = b.idn"
"   		           and a.end_mon_since = b.mon)"
"     group by idn;"
"  insert into #tmp (idn, mon, v1, v2, v3)"
"     select distinct idn, 13, 0, 0, 0"
"     from #krm021_dedup;"
"  update #tmp"
"     set v1 = a.v1"
"     from #tmp1 as a"
"     where a.idn = #tmp.idn"
"       and a.mon = #tmp.mon;"
"  delete from #tmp1;"
"  insert into #tmp1 (idn, mon, v1)"
"     select idn, 13, count(*)"
"     from #krm021_dedup"
"     where stop_code = '3'"
"       and issue in ('021', '081', '974')"
"       and @now - end_mon_since > 0"
"     group by idn;"
"  update #tmp"
"     set v2 = a.v1"
"     from #tmp1 as a"
"     where a.idn = #tmp.idn"
"       and a.mon = #tmp.mon;"
"  update #daco_v41_cal"
"     set fs008_12mplus = v1 + v2"
"     from #tmp as a"
"     where a.idn = #daco_v41_cal.idn"
"       and mon = 13;"
"  delete from #tmp1;"
"  delete from #tmp;"
"  insert into #tmp1 (idn, mon, v1)"
"     select idn, mon_since, sum(payment_amt)"
"     from #krm023_dedup"
"     group by idn, mon_since;"
"  set @i = 3"
"  while @i <= 6"
"     begin"
"        insert into #tmp (idn, mon, v1)"
"           select idn, @i, avg(v1)"
"           from #tmp1"
"           where (@now - mon) <= @i"
"             and (@now - mon) > 0 "
"           group by idn"
"        set @i = @i + 3"
"     end;"
"  update #daco_v41_cal"
"     set ms009_3m = v1"
"     from #tmp as a"
"     where a.idn = #daco_v41_cal.idn"
"       and mon=3;"
"  update #daco_v41_cal"
"     set ms009_6m = v1"
"     from #tmp as a"
"     where a.idn = #daco_v41_cal.idn"
"       and mon=6;"
"  delete from #tmp1;"
"  delete from #tmp;"
"  insert into #tmp1 (idn, mon, v1)"
"     select idn, mon_since, sum(case when pay_code in ('A', 'B') then payment_amt else 0 end)"
"     from #krm023_dedup"
"     group by idn, mon_since;"
"  set @i = 3"
"  while @i <= 12"
"     begin"
"        insert into #tmp (idn, mon, v1)"
"           select idn, @i, avg(v1)"
"           from #tmp1"
"           where (@now - mon) <= @i"
"             and (@now - mon) > 0 "
"           group by idn"
"        set @i = @i + 3"
"     end;"
"  update #daco_v41_cal"
"     set ms011_3m = v1"
"     from #tmp as a"
"     where a.idn = #daco_v41_cal.idn"
"       and mon = 3;"
"  update #daco_v41_cal"
"     set ms011_6m = v1"
"     from #tmp as a"
"     where a.idn = #daco_v41_cal.idn"
"       and mon = 6;"
"  update #daco_v41_cal"
"     set ms011_9m = v1"
"     from #tmp as a"
"     where a.idn = #daco_v41_cal.idn"
"       and mon = 9;"
"  update #daco_v41_cal"
"     set ms011_12m = v1"
"     from #tmp as a"
"     where a.idn = #daco_v41_cal.idn"
"       and mon = 12;"
" delete from #tmp1;"
" delete from #tmp;"
" insert into #tmp1 (idn, mon, v1)"
"    select idn, mon_since, sum(case when pay_code in ('C', 'D', 'E', 'F') then payment_amt"
"    				    else 0 end)"
"    from #krm023_dedup"
"    group by idn, mon_since;"
" set @i = 3"
" while @i <= 6"
"    begin"
"       insert into #tmp (idn, mon, v1)"
"          select idn, @i, avg(v1)"
"          from #tmp1"
"          where (@now - mon) <= @i"
"            and (@now - mon) >= 0"
"          group by idn"
"       set @i = @i + 3"
"    end;"
" update #daco_v41_cal"
"    set ms106_3m = v1"
"    from #tmp as a"
"    where a.idn = #daco_v41_cal.idn"
"      and mon=3;"
" update #daco_v41_cal"
"    set ms106_6m = v1"
"    from #tmp as a"
"    where a.idn = #daco_v41_cal.idn"
"      and mon=6;"
" delete from #tmp1;"
" delete from #tmp;"
" insert into #tmp1 (idn, mon, v1)"
"    select idn, mon_since, sum(convert(decimal(16, 8), (case when limit='' then NULL else limit end)))"
"    from #krm023_dedup"
"    group by idn, mon_since;"
" set @i = 3"
" while @i <= 6"
"    begin"
"       insert into #tmp (idn, mon, v1)"
"          select idn, @i, max(v1)"
"          from #tmp1"
"          where (@now - mon) <= @i"
"            and (@now - mon) >= 0"
"          group by idn"
"       set @i = @i + 3"
"    end;"
" update #daco_v41_cal"
"    set ms110_3m = (case when v1=0 then null else ms106_3m / v1 end)"
"    from #tmp as a"
"    where a.idn = #daco_v41_cal.idn"
"      and mon=3;"
" update #daco_v41_cal"
"    set ms110_6m = (case when v1=0 then null else ms106_6m / v1 end)"
"    from #tmp as a"
"    where a.idn = #daco_v41_cal.idn"
"      and mon=6;"
"  set @i = 0"
"  while @i <= 13"
"     begin"
"        insert into #open_card (idn, issue, mon)"
"           select idn,"
"                  (case when card_brand = 'A' and issue = 'A82' then 'AEA'"
"                   else issue end),"
"                  (@now - @i)"
"           from #krm021_dedup"
"           where (end_mon_since > (@now - @i))"
"             and (start_mon_since <= (@now - @i))"
"             and issue != '021'"
"        set @i = @i + 1"
"     end;"
"  insert into #open_line (idn, issue, mon, cards)"
"     select idn, issue, mon, count(*)"
"     from #open_card"
"     group by idn, issue, mon;"
"  set @i = 0"
"  while @i <= 13"
"     begin"
"        insert into #open_line (idn, issue, mon, cards)"
"           select idn,"
"                  (case when card_brand = 'M' then 'CTM'"
"                        when card_brand = 'V' then 'CTV'"
"                        when card_brand = 'D' then 'CTD' end),"
"                  (@now - @i),"
"                  1"
"           from #krm021_dedup"
"           where (end_mon_since > (@now - @i))"
"             and (start_mon_since <= (@now - @i)) "
"             and issue = '021'"
"        set @i = @i + 1"
"     end;"
"  update #open_line"
"     set bucket = 1;"
" /*arbitrary number, just to make sure it will out-of-range*/"
"  update #open_line"
"     set bucket = 100"
"     where mon = (@now - 13);"
"  set @i = 13;"
"  while @i > 0"
"     begin"
"        update #open_line"
"           set bucket = a.bucket + 1"
"        from #open_line as a inner join #open_line"
"             on  a.idn   = #open_line.idn"
"             and a.issue = #open_line.issue"
"             and a.mon   = (#open_line.mon - 1)"
"        where (@now - a.mon) = @i"
"        set @i = @i - 1"
"    end;"
"  insert into #latest_stmt_mon (idn, issue, mon)"
"     select idn, issue, max(mon)"
"     from #open_line"
"     where mon <= @now "
"     group by idn, issue;"
"  insert into #latest_line (idn, issue, mon, mob)"
"     select a.idn, a.issue, a.mon, a.bucket"
"     from #open_line as a inner join #latest_stmt_mon as b"
"         on a.idn = b.idn"
"         and a.issue = b.issue"
"         and a.mon = b.mon;"
"  delete from #tmp1;"
"  set @i = 3"
"  while @i <= 9"
"     begin"
"        insert into #tmp1 (idn, mon, v1)"
"           select idn, @i, sum(payment_amt)"
"           from #krm023_dedup as a"
"           where issue in (select issue"
"      		           from #latest_line"
"    		           where mob <= 12 and idn = a.idn)"
"             and bucket_def_1k <> 0"
"             and @now - mon_since <= @i"
"             and @now - mon_since > 0 "
"           group by idn"
"        set @i = @i + 3"
"     end;"
"  update #daco_v41_cal"
"     set ms203_3m_1k = v1"
"     from #tmp1 as a"
"     where a.idn = #daco_v41_cal.idn"
"       and a.mon = 3;"
"  update #daco_v41_cal"
"     set ms203_6m_1k = v1"
"     from #tmp1 as a"
"     where a.idn = #daco_v41_cal.idn"
"       and a.mon = 6;"
"  update #daco_v41_cal"
"     set ms203_9m_1k = v1"
"     from #tmp1 as a"
"     where a.idn = #daco_v41_cal.idn"
"       and a.mon = 9;"
"  update #daco_v41_cal"
"     set mt110_43 =  ms110_3m -  (ms110_6m +  ms110_3m),"
"         mt203_42_1k = ms203_3m_1k - ms203_9m_1k + ms203_6m_1k,"
"         mt009_43 = 2 * ms009_3m - ms009_6m,"
"         mt011_31 = ms011_6m - ms011_3m - ms011_12m + ms011_9m"
"  update #daco_v41_cal"
"     set fs002_6m_1k_q = power(fs002_6m_1k, 2),"
"         int015_9m = (case when fs101_9m = 0 then null else fs016_9m / fs101_9m end),"
"         mt203_42_1k_r = power((case when mt203_42_1k < 0 then null else mt203_42_1k end), 0.5),"
"         mt011_31_z = (case when mt011_31 = 0 then 1 else 0 end),"
"         fs008_12mplus_r = power((case when fs008_12mplus < 0 then null else fs008_12mplus end), 0.5),"
"         mt009_43_q = power(mt009_43, 2)"
"  update #daco_v41_cal"
"     set ms056_6m_1k_tran =  ms056_6m_1k,"
"         mt110_43_tran = (case when mt110_43 is null then 0"
"         		       when mt110_43 < 0 then 0"
"    			       else mt110_43 end),"
"         fs002_6m_1k_q_tran = fs002_6m_1k_q,"
"         fs031_tran = (case when fs031 is null then 0"
"    			    else fs031 end),"
"         mt203_42_1k_r_tran = (case when mt203_42_1k_r is null then 3.3"
"    			         else mt203_42_1k_r end),"
"         app_last_month_bucket_t1 = (case when app_last_month_bucket is null then 0"
"   				            else app_last_month_bucket end),"
"         int015_9m_tran = (case when int015_9m is null then 0.4"
"                             else int015_9m end),"
"         fs069_tran = (case when fs069 is null then -0.5"
"                            else fs069 end),"
"         sex_tran = (case when sex = 1 then 1 else 0 end),"
"         mt009_43_q_tran2=(case when mt009_43_q > 75000 then 1 else 0 end);"
/*
"  update #daco_v41_cal"
"     set ms056_6m_1k_tran = (case when ms056_6m_1k >120 then 120"
"    			          else ms056_6m_1k end),"
"         mt110_43_tran = (case when mt110_43 is null then 0"
"         		       when mt110_43 < 0 then 0"
"                               when mt110_43 > 1 then 1"
"    			       else mt110_43 end),"
"         fs002_6m_1k_q_tran = (case when fs002_6m_1k_q > 16 then 16"
"    			       else fs002_6m_1k_q end),"
"         fs031_tran = (case when fs031 is null then 0"
"    			    when fs031 > 8 then 8"
"    			    else fs031 end),"
"         mt203_42_1k_r_tran = (case when mt203_42_1k_r is null then 3.3"
"    			         when mt203_42_1k_r > 6 then 6"
"    			         else mt203_42_1k_r end),"
"         app_last_month_bucket_t1 = (case when app_last_month_bucket is null then 0"
"   				            else app_last_month_bucket end),"
"         int015_9m_tran = (case when int015_9m is null then 0.4"
"         		     when int015_9m > 0.4 then 0.4"
"                             else int015_9m end),"
"         fs069_tran = (case when fs069 is null then -0.5"
"         		    when fs069 > 6 then 6"
"                            else fs069 end),"
"         sex_tran = (case when sex = 1 then 1 else 0 end),"
"         mt009_43_q_tran2=(case when mt009_43_q > 75000 then 1 else 0 end);"
*/
" /* ---start making DACO score v4.1--- */"
"   update #daco_v41_cal"
"    set rscore41 = -0.02916"
"               + ms056_6m_1k_tran	*	0.00100"
"               + mt110_43_tran		*	0.14941"
"               + fs002_6m_1k_q_tran	*	0.01346"
"               + int015_9m_tran	*	0.26009"
"               + fs031_tran		*	0.01318"
"               + mt203_42_1k_r_tran	*	0.02712"
"               + app_last_month_bucket_t1 *	0.08179"
"               + fs008_12mplus_r	*	0.20956"
"               + fs069_tran		*	0.01431"
"               + mt011_31_z		*	0.06573"
"               + fs005_3m_1k		*	0.12226"
"               + sex_tran		*	0.02438"
"               + mt009_43_q_tran2	*	0.09215;"
" drop table #tmp; "
" drop table #tmp1; "
" drop table #open_issuer; "
" drop table #lines; "
" drop table #open_card; "
" drop table #open_line; "
" drop table #latest_stmt_mon; "
" drop table #latest_line; "
" /* -- end of procedure generate_daco41_score --*/",

/* Drop_Procedure_generate_ploan_score41 */
" if exists (select * from dbo.sysobjects where id = object_id(N'[generate_ploan_score41]') and OBJECTPROPERTY(id, N'IsProcedure') = 1)"
" drop procedure generate_ploan_score41;",

/* Exec_Procedure_generate_ploan_score41 */
" execute generate_ploan_score41 :v1, :v2;",

/* Create_Procedure_Generate_Ploan_Score41 */
" CREATE PROCEDURE generate_ploan_score41"
" (@now int,"
"  @curr_inqmon int)"
" AS"
" declare @i int"
" /* create temportary intermediate tables */"
" create table #tmp ("
"   idn varchar(14),"
"   mon int,"
"   v1 decimal (16, 8),"
"   v2 decimal (16, 8),"
"   v3 decimal (16, 8));"
" create table #tmp1 ("
"   idn varchar(14),"
"   mon int,"
"   v1 decimal (16, 8));"
" create table #open_issue ("
"   idn varchar(14),"
"   issue char(3),"
"   mon int);"
" create table #open_card ("
"  idn varchar(14),"
"  issue char(3),"
"  mon int);"
" create table #open_line ("
"  idn varchar(14),"
"  issue char(3),"
"  mon int,"
"  cards int,"
"  bucket int);"
" create table #latest_stmt_mon ("
"  idn varchar(14),"
"  issue char(3),"
"  mon int);"
" create table #latest_line ("
"  idn varchar(14),"
"  issue char(3),"
"  mon int,"
"  mob int);"
" /*Init krm021 variables*/"
" update #daco_v41_cal"
"    set rs017 = 0"
"    from #krm021_dedup as a"
"    where a.idn = #daco_v41_cal.idn;"
" /*Init krm023 variables*/"
" update #daco_v41_cal"
"    set fs063_12m_1k = 0,"
"        fs059_3m_1k = 0,"
"        fs059_6m_1k = 0,"
"        fs005_12m_1k = 0,"
"        fs018_3m = 0,"
"        fs018_6m = 0,"
"        fs018_9m = 0,"
"        fs102_3m = 0,"
"        fs102_6m = 0,"
"        fs102_9m = 0,"
"        ms024_3m = 0,"
"        ms026_3m = 0,"
"        ms119_12m = 0,"
"        ms120_9m = 0"
"    from #krm023_dedup as a"
"    where a.idn = #daco_v41_cal.idn;"
" /*Init krm021 and krm023 variables*/"
" update #daco_v41_cal"
"    set fs212_3m_1k = 0,"
"        fs212_6m_1k = 0"
"    from #krm021_dedup as a, #krm023_dedup as b"
"    where a.idn = b.idn"
"      and a.idn = #daco_v41_cal.idn"
"      and ((a.issue = b.issue)"
"          or ((a.issue = '021' and a.card_brand = 'V') and (b.issue = 'CTV'))"
"          or ((a.issue = '021' and a.card_brand = 'M') and (b.issue = 'CTM'))"
"          or ((a.issue = '021' and a.card_brand = 'D') and (b.issue = 'CTD'))"
"          or ((a.issue = 'A82' and a.card_brand = 'A') and (b.issue = 'AEA'))"
"          )"
" set @i = 3"
" while @i <= 6"
"    begin"
"       insert into #tmp1 (idn, mon, v1)"
"          select idn, @i, count(distinct issue)"
"          from #krm023_dedup"
"          where bucket_ef_1k >= 1"
"            and (@now - mon_since) <= @i"
"            and (@now - mon_since) >= 0"
"          group by idn"
"       set @i = @i + 3"
"    end"
" update #daco_v41_cal"
"    set fs059_3m_1k = v1"
"    from #tmp1 as a"
"    where a.idn = #daco_v41_cal.idn and mon = 3"
" update #daco_v41_cal"
"    set fs059_6m_1k = v1"
"    from #tmp1 as a"
"    where a.idn = #daco_v41_cal.idn and mon = 6"
" set @i = 12"
" while @i <= 12"
"    begin"
"       insert into #tmp1 (idn, mon, v1)"
"          select idn, @i, count(distinct issue)"
"          from #krm023_dedup"
"          where bucket_f_1k >= 2"
"            and (@now - mon_since) <= @i"
"            and (@now - mon_since) >= 0"
"          group by idn"
"       set @i = @i + 3"
"    end"
""
" update #daco_v41_cal"
"    set fs063_12m_1k = v1"
"    from #tmp1 as a"
"    where a.idn = #daco_v41_cal.idn and mon = 12"
" delete from #tmp"
" set @i = 3"
" while @i <= 3"
"   begin"
"      insert into #tmp (idn, mon, v1)"
"         select idn, @i, min(convert(decimal(16, 8),limit))"
"         from #krm023_dedup"
"         where (@now - mon_since) <= @i"
"           and (@now - mon_since) >= 0"
"           and convert(decimal(16, 8), limit) > 0.0"
"         group by idn"
"      set @i = @i + 3"
"   end"
" update #daco_v41_cal"
"    set ms026_3m = v1"
"    from #tmp as a"
"    where a.idn = #daco_v41_cal.idn"
"      and mon = 3"
" delete from #tmp"
" set @i = 3"
" while @i <= 3"
"   begin"
"      insert into #tmp (idn, mon, v1)"
"         select idn, @i, avg(convert(decimal(16, 8),limit))"
"         from  #krm023_dedup"
"         where (@now - mon_since) <= @i"
"           and (@now - mon_since) > 0  /*Keep 15-day rule*/"
"           and convert(decimal(16, 8), limit) > 0.0"
"         group by idn"
"      set @i = @i + 3"
"   end"
" update #daco_v41_cal"
"    set ms024_3m = v1"
"    from #tmp as a"
"    where a.idn = #daco_v41_cal.idn"
"      and mon = 3"
" delete from #tmp"
" insert into #tmp (idn, mon, v1)"
"    select idn, 12, count(*)"
"    from #krm023_dedup"
"    where bucket_f_1k >= 2"
"      and (@now - mon_since) <= 12"
"      and (@now - mon_since) >= 0"
"    group by idn"
" update #daco_v41_cal"
"    set fs005_12m_1k = v1"
"    from #tmp as a"
"    where a.idn = #daco_v41_cal.idn"
"      and mon = 12"
" update #daco_v41_cal"
"    set fs005_12m_1k = (case when fs005_12m_1k > 12 then 12"
"                             else fs005_12m_1k end)"
" delete from #tmp"
" delete from #tmp1"
" insert into #tmp1 (idn, mon, v1)"
"    select idn, mon_since, 1"
"    from #krm023_dedup"
"    where cash = 'Y'"
"    group by idn, mon_since"
" set @i = 3"
" while @i <= 9"
"    begin"
"       insert into #tmp (idn, mon, v1)"
"          select idn, @i, sum(v1)"
"          from #tmp1"
"          where (@now - mon) <= @i"
"            and (@now - mon) >= 0"
"          group by idn"
"       set @i = @i + 3"
"    end"
" update #daco_v41_cal"
"    set fs018_3m = v1"
"    from #tmp as a"
"    where a.idn = #daco_v41_cal.idn and mon = 3"
" update #daco_v41_cal"
"    set fs018_3m = (case when fs018_3m > 3 then 3"
"                            else fs018_3m end)"
" update #daco_v41_cal"
"    set fs018_6m = v1"
"    from #tmp as a"
"    where a.idn = #daco_v41_cal.idn and mon = 6"
" update #daco_v41_cal"
"    set fs018_9m = v1"
"    from #tmp as a"
"    where a.idn = #daco_v41_cal.idn and mon = 9"
" delete from #tmp"
" insert into #tmp (idn, mon)"
"    select idn, max(@now - start_mon_since + (1 - @curr_inqmon))"
"    from #krm021_dedup as a"
"    group by a.idn"
" update #daco_v41_cal"
"    set rs017 = mon"
"    from #tmp as a"
"    where a.idn = #daco_v41_cal.idn"
" delete from #tmp;"
" set @i = 12;"
" while @i <= 12"
" begin"
"   insert into #tmp (idn, mon, v1)"
"      select idn, @i, min(payment_amt / convert(decimal(16, 8), (case when limit='' then NULL else limit end)))"
"      from #krm023_dedup"
"      where (@now - mon_since) <= @i"
"        and (@now - mon_since) > 0"
"        and pay_code in ('A', 'B', 'C', 'D')"
"        and convert(decimal(16, 8), (case when limit='' then NULL else limit end)) <> 0"
"   group by idn"
"   set @i = @i + 3"
" end;"
" update #daco_v41_cal"
"  set ms119_12m = v1"
"  from #tmp as a"
"  where a.idn = #daco_v41_cal.idn"
"    and mon = 12;"
" delete from #tmp;"
" set @i = 9;"
" while @i <= 9"
" begin"
"   insert into #tmp (idn, mon, v1)"
"      select idn, @i, min(payment_amt / convert(decimal(16, 8), (case when limit='' then NULL else limit end)))"
"      from #krm023_dedup"
"      where (@now - mon_since) <= @i"
"        and (@now - mon_since) > 0"
"        and pay_code in ('A', 'B', 'C')"
"        and convert(decimal(16, 8), (case when limit='' then NULL else limit end)) <> 0"
"   group by idn"
"   set @i = @i + 3"
" end;"
" update #daco_v41_cal"
"  set ms120_9m = v1"
"  from #tmp as a"
"  where a.idn = #daco_v41_cal.idn"
"    and mon = 9;"
" delete from #open_issue"
" delete from #tmp"
" delete from #tmp1"
" insert into #open_issue (idn, mon, issue)"
"    select idn, mon_since, issue"
"    from #krm023_dedup"
"    where limit > 100"
" set @i = 3"
" while @i <= 9"
"    begin"
"       insert into #tmp (idn, mon, v1)"
"          select distinct idn, @i, 0"
"          from #krm023_dedup"
"          where (@now - mon_since) <= @i"
"            and (@now - mon_since) >= 0"
"          group by idn"
"       set @i = @i + 3"
"    end"
" set @i = 3"
" while @i<=9"
"    begin"
"       insert into #tmp1 (idn, mon, v1)"
"          select idn, @i, count(distinct issue)"
"          from #open_issue"
"          where (@now - mon) <= @i"
"            and (@now - mon) >= 0"
"          group by idn"
"       set @i = @i + 3"
"    end"
" update #tmp"
"    set v1 = a.v1"
"    from #tmp1 as a"
"    where a.idn = #tmp.idn"
"      and #tmp.mon = a.mon"
" update #daco_v41_cal"
"    set fs102_3m = a.v1"
"    from #tmp as a"
"    where a.idn = #daco_v41_cal.idn and a.mon = 3"
" update #daco_v41_cal"
"    set fs102_6m = a.v1"
"    from #tmp as a"
"    where a.idn = #daco_v41_cal.idn and a.mon = 6"
" update #daco_v41_cal"
"    set fs102_9m = a.v1"
"    from #tmp as a"
"    where a.idn = #daco_v41_cal.idn and a.mon = 9"
"  set @i = 0"
"  while @i <= 13"
"     begin"
"        insert into #open_card (idn, issue, mon)"
"           select idn,"
"                  (case when card_brand = 'A' and issue = 'A82' then 'AEA'"
"                   else issue end), "
"                  (@now - @i)"
"           from #krm021_dedup"
"           where (end_mon_since > (@now - @i))"
"             and (start_mon_since <= (@now - @i))"
"             and issue != '021'"
"        set @i = @i + 1"
"     end;"
"  insert into #open_line (idn, issue, mon, cards)"
"     select idn, issue, mon, count(*)"
"     from #open_card"
"     group by idn, issue, mon;"
"  set @i = 0"
"  while @i <= 13"
"     begin"
"        insert into #open_line (idn, issue, mon, cards)"
"           select idn,"
"                  (case when card_brand = 'M' then 'CTM'"
"                        when card_brand = 'V' then 'CTV'"
"                        when card_brand = 'D' then 'CTD' end),"
"                  (@now - @i),"
"                  1"
"           from #krm021_dedup"
"           where (end_mon_since > (@now - @i))"
"             and (start_mon_since <= (@now - @i)) "
"             and issue = '021'"
"        set @i = @i + 1"
"     end;"
"  update #open_line"
"     set bucket = 1;"
" /*arbitrary number, just to make sure it will out-of-range*/"
"  update #open_line"
"     set bucket = 100"
"     where mon = (@now - 13);"
"  set @i = 13;"
"  while @i > 0"
"     begin"
"        update #open_line"
"           set bucket = a.bucket + 1"
"        from #open_line as a inner join #open_line"
"             on  a.idn   = #open_line.idn"
"             and a.issue = #open_line.issue"
"             and a.mon   = (#open_line.mon - 1)"
"        where (@now - a.mon) = @i"
"        set @i = @i - 1"
"    end;"
"  insert into #latest_stmt_mon (idn, issue, mon)"
"     select idn, issue, max(mon)"
"     from #open_line"
"     where mon <= @now "
"     group by idn, issue;"
"  insert into #latest_line (idn, issue, mon, mob)"
"     select a.idn, a.issue, a.mon, a.bucket"
"     from #open_line as a inner join #latest_stmt_mon as b"
"         on a.idn = b.idn"
"         and a.issue = b.issue"
"         and a.mon = b.mon;"
" delete from #tmp"
" delete from #tmp1"
" set @i = 1"
" while @i <= 12"
"    begin"
"       insert into #tmp (idn, mon, v1)"
"          select idn, @i, count(*)"
"   	  from #krm023_dedup as a"
"   	  where issue in"
"		(select issue from #latest_line"
"      		 where  (mon - mob + 1) >=  (@now - 6) and idn = a.idn)"
"    	    and pay_code in ('C', 'D', 'E', 'F')"
"    	    and payment_amt > 1"
"    	    and (@now - mon_since) = @i"
"   	  group by idn"
"       set @i = @i + 1"
"    end"
" set @i = 3"
" while @i <= 6"
"    begin"
"       insert into #tmp1 (idn, mon, v1)"
"          select idn, @i, avg(v1)"
"          from #tmp"
"          where mon <= @i"
"            and mon > 0     /*keep 15-day rule*/"
"          group by idn"
"       set @i = @i + 3"
"    end"
" update #daco_v41_cal"
"    set fs212_3m_1k = v1"
"    from #tmp1 as a"
"    where a.idn = #daco_v41_cal.idn"
"      and a.mon = 3"
" update #daco_v41_cal"
"    set fs212_6m_1k = v1"
"    from #tmp1 as a"
"    where a.idn = #daco_v41_cal.idn"
"      and a.mon = 6"
" update #daco_v41_cal"
"    set ft102_42    = fs102_3m - (fs102_9m - fs102_6m),"
"        ft059_43_1k = fs059_3m_1k - (fs059_6m_1k - fs059_3m_1k),"
"        ft212_43_1k = fs212_3m_1k - (fs212_6m_1k - fs212_3m_1k),"
"        ft018_42    = fs018_3m - (fs018_9m - fs018_6m);"
" update #daco_v41_cal"
"    set ft102_42_r     = power((case when ft102_42 < 0 then null else ft102_42 end), 0.5),"
"        fs031_q         = power (fs031, 2),"
"        gender_z       = (case when sex = 0 then 1 else 0 end),"
"        ms120_9m_r     = power ((case when ms120_9m < 0 then null else ms120_9m end), 0.5),"
"        ms026_3m_r     = power ((case when ms026_3m < 0 then null else ms026_3m end), 0.5),"
"        ft059_43_1k_q  = power (ft059_43_1k, 2),"
"        fs063_12m_1k_q = power (fs063_12m_1k, 2),"
"        ft212_43_1k_q  = power (ft212_43_1k, 2),"
"        rs017_r        = power ((case when rs017 < 0 then null else rs017 end), 0.5),"
"        ft018_42_tran  = (case when ft018_42 < 0 then 0"
"        			 else ft018_42 end),"
"        fs005_12m_1k_r = power ((case when fs005_12m_1k < 0 then null else fs005_12m_1k end), 0.5),"
"        ms119_12m_r    = power ((case when ms119_12m < 0 then null else ms119_12m end), 0.5);"
" update #daco_v41_cal"
"    set ft102_42_r_tran = (case when ft102_42_r is null then 0"
"      			     when ft102_42_r > 2.625 then 2.625"
"      			     else ft102_42_r end),"
"        fs031_q_tran    = (case when fs031_q is null then 0"
"      			     when fs031_q > 320 then 320"
"      			     else fs031_q end),"
"        ft212_43_1k_q_tran = (case when ft212_43_1k_q is null then 3"
"      			    when ft212_43_1k_q > 13 then 13"
"      			    else ft212_43_1k_q end),"
"        ms120_9m_r_tran    = (case when ms120_9m_r > 0.825 then 0.825"
"        			 else ms120_9m_r end),"
"        app_last_month_bucket_tran = (case when app_last_month_bucket is null then 2"
"        					when app_last_month_bucket > 2 then 2"
"      				        else app_last_month_bucket end),"
"        ms026_3m_r_tran = (case when ms026_3m_r > 12 then 12"
"        			 else ms026_3m_r end),"
"        ft059_43_1k_q_tran = (case when ft059_43_1k_q > 24.75 then 24.75"
"        			 else ft059_43_1k_q end),"
"        ms024_3m_tran   = (case when ms024_3m < 55 then 55"
"   			   when ms024_3m > 135 then 135"
"        			 else ms024_3m end),"
"        ft018_42_tran_q = power (ft018_42_tran, 2),"
"        rs017_r_tran    = (case when rs017_r > 9.75 then 9.75"
"        			 else rs017_r end),"
"        ms119_12m_r_tran = (case when ms119_12m_r > 0.32 then 0.32"
"        			 else ms119_12m_r end);"
" /*---start making risk score & twentile---*/"
"  declare @guarantor char(1)"
"  declare @sex       int"
"  set @guarantor = (select guarantor from #daco_v41_cal)"
"  set @sex = (select sex from #daco_v41_cal)"
"  if @guarantor = '0'"
"     begin"
"        if @sex = 1"
"           begin"
"              update #daco_v41_cal"
"           	 set riskscore = 0.13362"
"                               + rscore41		* 0.14544"
"                               + ft102_42_r_tran	* -0.03306"
"                               + fs031_q_tran		* 0.0013"
"                               + gender_z		* -0.06228"
"                               + ft212_43_1k_q_tran	* 0.02155"
"                               + ms120_9m_r_tran	* 0.14477"
"                               + app_last_month_bucket_tran * 0.06967"
"                               + ms026_3m_r_tran	* -0.00862"
"                               + ft059_43_1k_q_tran	* 0.01027"
"                               + fs063_12m_1k_q	* 0.14215;"
"              update #daco_v41_cal"
"                 set twentile = (case"
"                                  when riskscore is null    then 0"
"                                  when riskscore <= -0.0108 then 1"
"                                  when riskscore <= 0.00107 then 2"
"                                  when riskscore <= 0.01177 then 3"
"                                  when riskscore <= 0.02176 then 4"
"                                  when riskscore <= 0.03161 then 5"
"                                  when riskscore <= 0.04212 then 6"
"                                  when riskscore <= 0.05296 then 7"
"                                  when riskscore <= 0.06435 then 8"
"                                  when riskscore <= 0.07464 then 9"
"                                  when riskscore <= 0.08609 then 10"
"                                  when riskscore <= 0.09759 then 11"
"                                  when riskscore <= 0.10945 then 12"
"                                  when riskscore <= 0.12526 then 13"
"                                  when riskscore <= 0.14063 then 14"
"                                  when riskscore <= 0.15807 then 15"
"                                  when riskscore <= 0.17617 then 16"
"                                  when riskscore <= 0.20609 then 17"
"                                  when riskscore <= 0.23679 then 18"
"                                  when riskscore <= 0.29913 then 19"
"                                  else 20 end)"
"           end"
"        else"
"           begin"
"              update #daco_v41_cal"
"                 set riskscore = 0.35632"
"                               + rscore41 * 0.17190"
"                               + MS024_3M_tran * -0.00143"
"                               + FT018_42_tran_q * 0.01541"
"                               + RS017_r_tran * -0.02022"
"              update #daco_v41_cal"
"                 set twentile = (case"
"                                  when riskscore is null     then 0"
"                                  when riskscore <= -0.02154 then 1"
"                                  when riskscore <= -0.01011 then 2"
"                                  when riskscore <= -0.00206 then 3"
"                                  when riskscore <= 0.01235  then 4"
"                                  when riskscore <= 0.02382  then 5"
"                                  when riskscore <= 0.03749  then 6"
"                                  when riskscore <= 0.04602  then 7"
"                                  when riskscore <= 0.05667  then 8"
"                                  when riskscore <= 0.06832  then 9"
"                                  when riskscore <= 0.07773  then 10"
"                                  when riskscore <= 0.08922  then 11"
"                                  when riskscore <= 0.10066  then 12"
"                                  when riskscore <= 0.11222  then 13"
"                                  when riskscore <= 0.12595  then 14"
"                                  when riskscore <= 0.14148  then 15"
"                                  when riskscore <= 0.15662  then 16"
"                                  when riskscore <= 0.17987  then 17"
"                                  when riskscore <= 0.19987  then 18"
"                                  when riskscore <= 0.22532  then 19"
"		                  else 20 end)"
"           end"
"     end"
"  else"
"     begin"
"        update #daco_v41_cal"
"           set f_score1 = (case when sex = 0 then"
"                                -0.00927 + fs005_12m_1k_r * 0.69960 + ms119_12m_r_tran * 0.43594"
"                                else 0 end)"
"        update #daco_v41_cal"
"           set riskscore = 0.01877"
"                         + f_score1	* 0.57606"
"                         + rscore41	* 0.52523"
"        update #daco_v41_cal"
"           set twentile = (case"
"                            when riskscore is null    then 0"
"                            when riskscore <= 0.01199 then 1"
"                            when riskscore <= 0.0125  then 2"
"                            when riskscore <= 0.01893 then 3"
"                            when riskscore <= 0.01942 then 4"
"                            when riskscore <= 0.02522 then 5"
"                            when riskscore <= 0.02635 then 6"
"                            when riskscore <= 0.03323 then 7"
"                            when riskscore <= 0.03612 then 8"
"                            when riskscore <= 0.04256 then 9"
"                            when riskscore <= 0.04815 then 10"
"                            when riskscore <= 0.05605 then 11"
"                            when riskscore <= 0.06539 then 12"
"                            when riskscore <= 0.07633 then 13"
"                            when riskscore <= 0.08878 then 14"
"                            when riskscore <= 0.11107 then 15"
"                            when riskscore <= 0.1336  then 16"
"                            when riskscore <= 0.16661 then 17"
"                            when riskscore <= 0.19827 then 18"
"                            when riskscore <= 0.2416  then 19"
"                            else 20 end)"
"     end"
" /*---start making PD---*/"
"  declare @apr_group int"
"  set @apr_group = (select apr_group from #daco_v41_cal)"
"  if @guarantor > '0'"
"     begin"
"       update #daco_v41_cal"
"         set pd = (case"
"            when twentile =  1 then 0.0004"
"            when twentile =  2 then 0.0004"
"            when twentile =  3 then 0.0004"
"            when twentile =  4 then 0.0004"
"            when twentile =  5 then 0.0004"
"            when twentile =  6 then 0.0004"
"            when twentile =  7 then 0.0005"
"            when twentile =  8 then 0.00077"
"            when twentile =  9 then 0.0011"
"            when twentile = 10 then 0.0016"
"            when twentile = 11 then 0.0022"
"            when twentile = 12 then 0.003"
"            when twentile = 13 then 0.0039"
"            when twentile = 14 then 0.005"
"            when twentile = 15 then 0.0063"
"            when twentile = 16 then 0.0078"
"            when twentile = 17 then 0.0096"
"            when twentile = 18 then 0.012"
"            when twentile = 19 then 0.014"
"            when twentile = 20 then 0.016"
"         end)"
"     end"
"   else"
"     begin"
"       if  @sex = 1"
"         begin"
"           if @apr_group = 1"
"             update #daco_v41_cal"
"                set pd = (case"
"                   when twentile =  1 then 0.004672845"
"                   when twentile =  2 then 0.005011462"
"                   when twentile =  3 then 0.005350079"
"                   when twentile =  4 then 0.005688698"
"                   when twentile =  5 then 0.006027327"
"                   when twentile =  6 then 0.006366035"
"                   when twentile =  7 then 0.006705148"
"                   when twentile =  8 then 0.007045912"
"                   when twentile =  9 then 0.007392299"
"                   when twentile = 10 then 0.007755354"
"                   when twentile = 11 then 0.008162619"
"                   when twentile = 12 then 0.008676988"
"                   when twentile = 13 then 0.009431984"
"                   when twentile = 14 then 0.010694243"
"                   when twentile = 15 then 0.012969207"
"                   when twentile = 16 then 0.017172978"
"                   when twentile = 17 then 0.024902422"
"                   when twentile = 18 then 0.038847356"
"                   when twentile = 19 then 0.063403396"
"                   when twentile = 20 then 0.105562488"
"                end)"
"           else if @apr_group = 2"
"             update #daco_v41_cal"
"                set pd = (case"
"                   when twentile =  1 then 0.006490181"
"                   when twentile =  2 then 0.006996893"
"                   when twentile =  3 then 0.007503604"
"                   when twentile =  4 then 0.008010317"
"                   when twentile =  5 then 0.008517041"
"                   when twentile =  6 then 0.009023843"
"                   when twentile =  7 then 0.00953105"
"                   when twentile =  8 then 0.010039909"
"                   when twentile =  9 then 0.01055439"
"                   when twentile = 10 then 0.011085539"
"                   when twentile = 11 then 0.011660899"
"                   when twentile = 12 then 0.012343362"
"                   when twentile = 13 then 0.013266452"
"                   when twentile = 14 then 0.014696805"
"                   when twentile = 15 then 0.017139864"
"                   when twentile = 16 then 0.021511729"
"                   when twentile = 17 then 0.029409267"
"                   when twentile = 18 then 0.043522296"
"                   when twentile = 19 then 0.068246431"
"                   when twentile = 20 then 0.110573617"
"                end)"
"           else if @apr_group = 3"
"             update #daco_v41_cal"
"                set pd = (case"
"                   when twentile =  1 then 0.007911629"
"                   when twentile =  2 then 0.008557534"
"                   when twentile =  3 then 0.009203438"
"                   when twentile =  4 then 0.009849343"
"                   when twentile =  5 then 0.01049526"
"                   when twentile =  6 then 0.011141255"
"                   when twentile =  7 then 0.011787655"
"                   when twentile =  8 then 0.012435706"
"                   when twentile =  9 then 0.01308938"
"                   when twentile = 10 then 0.013759722"
"                   when twentile = 11 then 0.014474274"
"                   when twentile = 12 then 0.01529593"
"                   when twentile = 13 then 0.016358213"
"                   when twentile = 14 then 0.017927759"
"                   when twentile = 15 then 0.020510011"
"                   when twentile = 16 then 0.025021068"
"                   when twentile = 17 then 0.033057799"
"                   when twentile = 18 then 0.04731002"
"                   when twentile = 19 then 0.072173348"
"                   when twentile = 20 then 0.114639727"
"                end)"
"           else if @apr_group = 4"
"             update #daco_v41_cal"
"                set pd = (case"
"                   when twentile =  1 then 0.009253218"
"                   when twentile =  2 then 0.010035695"
"                   when twentile =  3 then 0.010818172"
"                   when twentile =  4 then 0.011600649"
"                   when twentile =  5 then 0.012383138"
"                   when twentile =  6 then 0.013165705"
"                   when twentile =  7 then 0.013948677"
"                   when twentile =  8 then 0.0147333"
"                   when twentile =  9 then 0.015523547"
"                   when twentile = 10 then 0.016330461"
"                   when twentile = 11 then 0.017181585"
"                   when twentile = 12 then 0.018139814"
"                   when twentile = 13 then 0.019338668"
"                   when twentile = 14 then 0.021044786"
"                   when twentile = 15 then 0.02376361"
"                   when twentile = 16 then 0.02841124"
"                   when twentile = 17 then 0.036584543"
"                   when twentile = 18 then 0.050973337"
"                   when twentile = 19 then 0.075973236"
"                   when twentile = 20 then 0.118576187"
"                end)"
"           else if @apr_group = 5"
"             update #daco_v41_cal"
"                set pd = (case"
"                   when twentile =  1 then 0.010671485"
"                   when twentile =  2 then 0.011603146"
"                   when twentile =  3 then 0.012534808"
"                   when twentile =  4 then 0.013466471"
"                   when twentile =  5 then 0.014398145"
"                   when twentile =  6 then 0.015329897"
"                   when twentile =  7 then 0.016262055"
"                   when twentile =  8 then 0.017195864"
"                   when twentile =  9 then 0.018135296"
"                   when twentile = 10 then 0.019091395"
"                   when twentile = 11 then 0.020091705"
"                   when twentile = 12 then 0.021199119"
"                   when twentile = 13 then 0.022547159"
"                   when twentile = 14 then 0.024402462"
"                   when twentile = 15 then 0.027270471"
"                   when twentile = 16 then 0.032067286"
"                   when twentile = 17 then 0.040389775"
"                   when twentile = 18 then 0.054927754"
"                   when twentile = 19 then 0.080076839"
"                   when twentile = 20 then 0.122828975"
"                end)"
"           else if @apr_group = 6"
"             update #daco_v41_cal"
"                set pd = (case"
"                   when twentile =  1 then 0.01323963"
"                   when twentile =  2 then 0.014452354"
"                   when twentile =  3 then 0.015665077"
"                   when twentile =  4 then 0.016877802"
"                   when twentile =  5 then 0.018090538"
"                   when twentile =  6 then 0.019303352"
"                   when twentile =  7 then 0.020516572"
"                   when twentile =  8 then 0.021731443"
"                   when twentile =  9 then 0.022951937"
"                   when twentile = 10 then 0.024189098"
"                   when twentile = 11 then 0.025470469"
"                   when twentile = 12 then 0.026858945"
"                   when twentile = 13 then 0.028488047"
"                   when twentile = 14 then 0.030624413"
"                   when twentile = 15 then 0.033773484"
"                   when twentile = 16 then 0.038851361"
"                   when twentile = 17 then 0.047454911"
"                   when twentile = 18 then 0.062273952"
"                   when twentile = 19 then 0.087704099"
"                   when twentile = 20 then 0.130737297"
"                end)"
"           else if @apr_group = 7"
"             update #daco_v41_cal"
"                set pd = (case"
"                   when twentile =  1 then 0.017087433"
"                   when twentile =  2 then 0.01874349"
"                   when twentile =  3 then 0.020399548"
"                   when twentile =  4 then 0.022055606"
"                   when twentile =  5 then 0.023711675"
"                   when twentile =  6 then 0.025367823"
"                   when twentile =  7 then 0.027024376"
"                   when twentile =  8 then 0.02868258"
"                   when twentile =  9 then 0.030346407"
"                   when twentile = 10 then 0.032026902"
"                   when twentile = 11 then 0.033751607"
"                   when twentile = 12 then 0.035583416"
"                   when twentile = 13 then 0.037655851"
"                   when twentile = 14 then 0.04023555"
"                   when twentile = 15 then 0.043827955"
"                   when twentile = 16 then 0.049349165"
"                   when twentile = 17 then 0.058396049"
"                   when twentile = 18 then 0.073658423"
"                   when twentile = 19 then 0.099531904"
"                   when twentile = 20 then 0.143008435"
"                end)"
"           else if @apr_group = 8"
"             update #daco_v41_cal"
"                set pd = (case"
"                   when twentile =  1 then 0.022777805"
"                   when twentile =  2 then 0.025129124"
"                   when twentile =  3 then 0.027480443"
"                   when twentile =  4 then 0.029831763"
"                   when twentile =  5 then 0.032183095"
"                   when twentile =  6 then 0.034534504"
"                   when twentile =  7 then 0.036886319"
"                   when twentile =  8 then 0.039239785"
"                   when twentile =  9 then 0.041598875"
"                   when twentile = 10 then 0.043974631"
"                   when twentile = 11 then 0.046394598"
"                   when twentile = 12 then 0.048921669"
"                   when twentile = 13 then 0.051689367"
"                   when twentile = 14 then 0.054964328"
"                   when twentile = 15 then 0.059251994"
"                   when twentile = 16 then 0.065468466"
"                   when twentile = 17 then 0.075210613"
"                   when twentile = 18 then 0.091168248"
"                   when twentile = 19 then 0.117736991"
"                   when twentile = 20 then 0.161908785"
"                end)"
"         end"
"       else"
"         begin"
"           if @apr_group = 1"
"             update #daco_v41_cal"
"                set pd = (case"
"                   when twentile =  1 then 0.001375292"
"                   when twentile =  2 then 0.00274539"
"                   when twentile =  3 then 0.004115488"
"                   when twentile =  4 then 0.005485586"
"                   when twentile =  5 then 0.006855685"
"                   when twentile =  6 then 0.008225783"
"                   when twentile =  7 then 0.009595881"
"                   when twentile =  8 then 0.010965979"
"                   when twentile =  9 then 0.012336077"
"                   when twentile =  10 then 0.013706176"
"                   when twentile =  11 then 0.015076274"
"                   when twentile =  12 then 0.016446372"
"                   when twentile =  13 then 0.01781647"
"                   when twentile =  14 then 0.019186569"
"                   when twentile =  15 then 0.020556667"
"                   when twentile =  16 then 0.021926765"
"                   when twentile =  17 then 0.023296863"
"                   when twentile =  18 then 0.024666961"
"                   when twentile =  19 then 0.02603706"
"                   when twentile =  20 then 0.027407158"
"                end)"
"           else if @apr_group = 2"
"             update #daco_v41_cal"
"                set pd = (case"
"                   when twentile =  1 then 0.001486979"
"                   when twentile =  2 then 0.002938007"
"                   when twentile =  3 then 0.004389036"
"                   when twentile =  4 then 0.005840064"
"                   when twentile =  5 then 0.007291093"
"                   when twentile =  6 then 0.008742121"
"                   when twentile =  7 then 0.01019315"
"                   when twentile =  8 then 0.011644178"
"                   when twentile =  9 then 0.013095207"
"                   when twentile = 10 then 0.014546235"
"                   when twentile = 11 then 0.015997263"
"                   when twentile = 12 then 0.017448292"
"                   when twentile = 13 then 0.01889932"
"                   when twentile = 14 then 0.020350349"
"                   when twentile = 15 then 0.021801377"
"                   when twentile = 16 then 0.023252406"
"                   when twentile = 17 then 0.024703434"
"                   when twentile = 18 then 0.026154463"
"                   when twentile = 19 then 0.027605491"
"                   when twentile = 20 then 0.02905652"
"                end)"
"           else if @apr_group = 3"
"             update #daco_v41_cal"
"                set pd = (case"
"                   when twentile =  1 then 0.001617304"
"                   when twentile =  2 then 0.003119353"
"                   when twentile =  3 then 0.004621401"
"                   when twentile =  4 then 0.00612345"
"                   when twentile =  5 then 0.007625499"
"                   when twentile =  6 then 0.009127548"
"                   when twentile =  7 then 0.010629597"
"                   when twentile =  8 then 0.012131646"
"                   when twentile =  9 then 0.013633695"
"                   when twentile = 10 then 0.015135743"
"                   when twentile = 11 then 0.016637792"
"                   when twentile = 12 then 0.018139841"
"                   when twentile = 13 then 0.01964189"
"                   when twentile = 14 then 0.021143939"
"                   when twentile = 15 then 0.022645988"
"                   when twentile = 16 then 0.024148036"
"                   when twentile = 17 then 0.025650085"
"                   when twentile = 18 then 0.027152134"
"                   when twentile = 19 then 0.028654183"
"                   when twentile = 20 then 0.030156232"
"                end)"
"           else if @apr_group = 4"
"             update #daco_v41_cal"
"                set pd = (case"
"                   when twentile =  1 then 0.001833047"
"                   when twentile =  2 then 0.003376683"
"                   when twentile =  3 then 0.004920319"
"                   when twentile =  4 then 0.006463955"
"                   when twentile =  5 then 0.008007591"
"                   when twentile =  6 then 0.009551227"
"                   when twentile =  7 then 0.011094864"
"                   when twentile =  8 then 0.0126385"
"                   when twentile =  9 then 0.014182136"
"                   when twentile = 10 then 0.015725772"
"                   when twentile = 11 then 0.017269408"
"                   when twentile = 12 then 0.018813044"
"                   when twentile = 13 then 0.02035668"
"                   when twentile = 14 then 0.021900317"
"                   when twentile = 15 then 0.023443953"
"                   when twentile = 16 then 0.024987589"
"                   when twentile = 17 then 0.026531225"
"                   when twentile = 18 then 0.028074861"
"                   when twentile = 19 then 0.029618497"
"                   when twentile = 20 then 0.031162133"
"                end)"
"           else if @apr_group = 5"
"             update #daco_v41_cal"
"                set pd = (case"
"                   when twentile =  1 then 0.002251264"
"                   when twentile =  2 then 0.003833735"
"                   when twentile =  3 then 0.005416206"
"                   when twentile =  4 then 0.006998676"
"                   when twentile =  5 then 0.008581147"
"                   when twentile =  6 then 0.010163618"
"                   when twentile =  7 then 0.011746088"
"                   when twentile =  8 then 0.013328559"
"                   when twentile =  9 then 0.014911029"
"                   when twentile = 10 then 0.0164935"
"                   when twentile = 11 then 0.018075971"
"                   when twentile = 12 then 0.019658441"
"                   when twentile = 13 then 0.021240912"
"                   when twentile = 14 then 0.022823383"
"                   when twentile = 15 then 0.024405853"
"                   when twentile = 16 then 0.025988324"
"                   when twentile = 17 then 0.027570795"
"                   when twentile = 18 then 0.029153265"
"                   when twentile = 19 then 0.030735736"
"                   when twentile = 20 then 0.032318207"
"                end)"
"           else if @apr_group = 6"
"             update #daco_v41_cal"
"                set pd = (case"
"                   when twentile =  1 then 0.004013884"
"                   when twentile =  2 then 0.005656889"
"                   when twentile =  3 then 0.007299894"
"                   when twentile =  4 then 0.0089429"
"                   when twentile =  5 then 0.010585905"
"                   when twentile =  6 then 0.01222891"
"                   when twentile =  7 then 0.013871915"
"                   when twentile =  8 then 0.015514921"
"                   when twentile =  9 then 0.017157926"
"                   when twentile = 10 then 0.018800931"
"                   when twentile = 11 then 0.020443936"
"                   when twentile = 12 then 0.022086942"
"                   when twentile = 13 then 0.023729947"
"                   when twentile = 14 then 0.025372952"
"                   when twentile = 15 then 0.027015957"
"                   when twentile = 16 then 0.028658963"
"                   when twentile = 17 then 0.030301968"
"                   when twentile = 18 then 0.031944973"
"                   when twentile = 19 then 0.033587978"
"                   when twentile = 20 then 0.035230983"
"                end)"
"           else if @apr_group >= 7"
"             update #daco_v41_cal"
"                set pd = (case"
"                   when twentile =  1 then 0.02475304"
"                   when twentile =  2 then 0.026510592"
"                   when twentile =  3 then 0.028268145"
"                   when twentile =  4 then 0.030025698"
"                   when twentile =  5 then 0.031783251"
"                   when twentile =  6 then 0.033540804"
"                   when twentile =  7 then 0.035298357"
"                   when twentile =  8 then 0.03705591"
"                   when twentile =  9 then 0.038813463"
"                   when twentile = 10 then 0.040571016"
"                   when twentile = 11 then 0.042328569"
"                   when twentile = 12 then 0.044086122"
"                   when twentile = 13 then 0.045843675"
"                   when twentile = 14 then 0.047601228"
"                   when twentile = 15 then 0.049358781"
"                   when twentile = 16 then 0.051116334"
"                   when twentile = 17 then 0.052873887"
"                   when twentile = 18 then 0.05463144"
"                   when twentile = 19 then 0.056388993"
"                   when twentile = 20 then 0.058146546"
"                end)"
"         end"
"     end"
" drop table #tmp; "
" drop table #tmp1; "
" drop table #open_issuer; "
" drop table #lines; "
" drop table #open_card; "
" drop table #open_line; "
" drop table #latest_stmt_mon; "
" drop table #latest_line; "
" /* -- end of procedure generate_ploan_score41 --*/",
/*Drop_Working_Tables*/
" drop table #bam085_dedup;"
" drop table #krm021_dedup;"
" drop table #krm023_dedup;"
" drop table #stm001_dedup;"
" drop table #jas002_t;"
" drop table #jas002_t_dedup;"
" drop table #base;"
" drop table #daco_v41_cal;"
};
                      

